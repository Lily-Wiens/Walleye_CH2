library(lme4)
library(stargazer)
#### trans-hydroxyproline lmer ####

# retrying the models

Trans_Hydroxyproline_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = Trans_Hydroxyproline)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Trans_Hydroxyproline_lm_plot



# Trans_Hydroxyproline


#test normality
(shapiro.test(PCA_18W$Trans_Hydroxyproline
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Trans_Hydroxyproline
# W = 0.72619, p-value = 1.042e-08
attach(PCA_18W)
## logged
shapiro.test(log(Trans_Hydroxyproline))
# Shapiro-Wilk normality test
# 
# data:  log(Trans_Hydroxyproline)
# W = 0.94443, p-value = 0.01432

# problem not resolved but best transformation


## square root

shapiro.test(sqrt(Trans_Hydroxyproline))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Trans_Hydroxyproline)
# W = 0.8623, p-value = 1.796e-05

## standardized
shapiro.test((Trans_Hydroxyproline-(mean(Trans_Hydroxyproline))/(sd(Trans_Hydroxyproline)))) 
# Shapiro-Wilk normality test
# 
# data:  (Trans_Hydroxyproline - (mean(Trans_Hydroxyproline))/(sd(Trans_Hydroxyproline)))
# W = 0.72619, p-value = 1.042e-08

##  model no interaction site random metabolite log transformed
Trans_Hydroxyproline3_model <- lmer(log(Trans_Hydroxyproline) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Trans_Hydroxyproline3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Trans_Hydroxyproline) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 158.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.7547 -0.6317  0.1618  0.5574  2.7081 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 1.987    1.4098  
# Residual             0.831    0.9116  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  2.46958    0.79219   3.117
# Spine.Age   -0.11036    0.04451  -2.479
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.427
Trans_Hydroxyproline3_model_emm <- emmeans(Trans_Hydroxyproline3_model, ~ Spine.Age)
Trans_Hydroxyproline3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   1.62 0.716 2.99   -0.665      3.9
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Trans_Hydroxyproline3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Trans_Hydroxyproline) 
# -----------------------------------------------
#   Spine.Age                    -0.110**          
#   (0.045)          
# 
# Constant                     2.470***          
#   (0.792)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -79.200          
# Akaike Inf. Crit.             166.400          
# Bayesian Inf. Crit.           174.355          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01


anova(Trans_Hydroxyproline3_model)
library(car)
Anova(Trans_Hydroxyproline3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Trans_Hydroxyproline)
# Chisq Df Pr(>Chisq)   
# (Intercept) 9.7182  1   0.001825 **
#   Spine.Age   6.1462  1   0.013169 * 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Trans_Hydroxyproline3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Trans_Hydroxyproline3_model))
qqline(resid(Trans_Hydroxyproline3_model))
library(report)
report(Trans_Hydroxyproline3_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age (formula:
#                                                                                              log(Trans_Hydroxyproline) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.72) and the part related to the fixed
# effects alone (marginal R2) is of 0.04. The model's intercept,
# corresponding to Spine.Age = 0, is at 2.47 (95% CI [0.88, 4.06], t(50) =
#                                               3.12, p = 0.003). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(50) = -2.48, p = 0.017; Std. beta =
#                                                                          -0.07, 95% CI [-0.15, 0.02])

# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Trans_Hydroxyproline9_model <- lmer(log(Trans_Hydroxyproline) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Trans_Hydroxyproline9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Trans_Hydroxyproline) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 146.3
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.7995 -0.5945  0.1567  0.5656  2.7710 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 3.328    1.8243  
# Residual             0.831    0.9116  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    4.23352    1.86100   2.275
# Spine.Age     -0.10717    0.04465  -2.400
# SiteMatheson  -1.27475    2.60219  -0.490
# SiteRed River -2.94079    2.60522  -1.129
# SiteSandy Bar -2.95789    2.60843  -1.134
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.152                     
# SiteMathesn -0.695 -0.026              
# SiteRedRivr -0.690 -0.055  0.501       
# SiteSandyBr -0.696 -0.006  0.499  0.498


qqnorm(resid(Trans_Hydroxyproline9_model))
qqline(resid(Trans_Hydroxyproline9_model))

report(Trans_Hydroxyproline9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age and Site
# (formula: log(Trans_Hydroxyproline) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.86) and the part
# related to the fixed effects alone (marginal R2) is of 0.31. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 4.23 (95% CI [0.49, 7.98], t(47) = 2.27, p = 0.028). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(47) = -2.40, p = 0.020; Std. beta =
#                                                                          -0.06, 95% CI [-0.15, 0.02])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.27, 95% CI [-6.51, 3.96], t(47) = -0.49, p = 0.627;
#           Std. beta = -0.59, 95% CI [-1.72, 0.54])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -2.94, 95% CI [-8.18, 2.30], t(47) = -1.13, p = 0.265;
#           Std. beta = -0.87, 95% CI [-2.00, 0.26])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -2.96, 95% CI [-8.21, 2.29], t(47) = -1.13, p = 0.263;
#           Std. beta = -0.84, 95% CI [-1.98, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Trans_Hydroxyproline9_model)
# Analysis of Variance Table
# npar Sum Sq Mean Sq F value
# Spine.Age    1 4.9792  4.9792  5.9917
# Site         3 1.5073  0.5024  0.6046
Anova(Trans_Hydroxyproline9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Trans_Hydroxyproline)
# Chisq Df Pr(>Chisq)  
# (Intercept) 5.1750  1    0.02291 *
#   Spine.Age   5.7610  1    0.01639 *
#   Site        1.8138  3    0.61193  
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
##  model with interaction and sites with random intercept

Trans_Hydroxyproline8_model <- lmer(log(Trans_Hydroxyproline) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Trans_Hydroxyproline8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Trans_Hydroxyproline) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 142.3
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.62762 -0.40722  0.07707  0.56905  2.41744 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 9.3157   3.0522  
# Residual             0.7037   0.8389  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              3.28927    3.14208   1.047
# Spine.Age                0.04192    0.11277   0.372
# SiteMatheson             0.81017    4.42849   0.183
# SiteRed River           -2.83823    4.42010  -0.642
# SiteSandy Bar           -0.02111    4.49292  -0.005
# Spine.Age:SiteMatheson  -0.29409    0.13710  -2.145
# Spine.Age:SiteRed River -0.06080    0.12665  -0.480
# Spine.Age:SiteSandy Bar -0.44797    0.18279  -2.451
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.227                                          
# SiteMathesn -0.710  0.161                                   
# SiteRedRivr -0.711  0.162  0.504                            
# SiteSandyBr -0.699  0.159  0.496  0.497                     
# Spn.Ag:StMt  0.187 -0.823 -0.211 -0.133 -0.131              
# Spn.Ag:StRR  0.202 -0.890 -0.144 -0.200 -0.142  0.732       
# Spn.Ag:StSB  0.140 -0.617 -0.099 -0.100 -0.266  0.507  0.549



##  model
anova(Trans_Hydroxyproline8_model)
# Analysis of Variance Table
# npar Sum Sq Mean Sq F value
# Spine.Age         1 4.8457  4.8457  6.8863
# Site              3 0.4623  0.1541  0.2190
# Spine.Age:Site    3 8.3509  2.7836  3.9559

emmeans(Trans_Hydroxyproline8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean   SE      df lower.CL upper.CL
# Dauphin River  3.612 3.06  808695    -2.39     9.62
# Matheson       2.157 3.06 1819798    -3.84     8.15
# Red River      0.306 3.06 1199990    -5.70     6.31
# Sandy Bar      0.140 3.07  404259    -5.87     6.15
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate   SE      df t.ratio p.value
# Dauphin River - Matheson     1.455 4.33 1163992   0.336  0.9869
# Dauphin River - Red River    3.307 4.33  975444   0.763  0.8709
# Dauphin River - Sandy Bar    3.472 4.34  554629   0.801  0.8541
# Matheson - Red River         1.851 4.33 1461671   0.428  0.9738
# Matheson - Sandy Bar         2.017 4.33  745448   0.465  0.9666
# Red River - Sandy Bar        0.166 4.33  646629   0.038  1.0000
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Trans_Hydroxyproline8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.0000000  0.27240296
# .sigma                   0.6483373  0.94681008
# (Intercept)              1.9147524  4.66378599
# Spine.Age               -0.1657600  0.24959588
# SiteMatheson            -1.0132497  2.63358232
# SiteRed River           -4.5912776 -1.08517718
# SiteSandy Bar           -2.3175635  2.27534326
# Spine.Age:SiteMatheson  -0.5465814 -0.04160176
# Spine.Age:SiteRed River -0.2940449  0.17243791
# Spine.Age:SiteSandy Bar -0.7846051 -0.11133759
syx <- summary(Trans_Hydroxyproline8_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.421674
plot(Trans_Hydroxyproline8_model)
# Check model performance
check_model(Trans_Hydroxyproline8_model)
# Plot the Q-Q plot for the residuals
qqnorm(resid(Trans_Hydroxyproline8_model))
qqline(resid(Trans_Hydroxyproline8_model))
Anova(Trans_Hydroxyproline8_model, type="III")
# 
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Trans_Hydroxyproline)
# Chisq Df Pr(>Chisq)   
# (Intercept)     1.0959  1   0.295171   
# Spine.Age       0.1382  1   0.710106   
# Site            0.7893  3   0.852035   
# Spine.Age:Site 11.8676  3   0.007851 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

report(Trans_Hydroxyproline8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age and Site
# (formula: log(Trans_Hydroxyproline) ~ Spine.Age * Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.94) and the part
# related to the fixed effects alone (marginal R2) is of 0.17. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 3.29 (95% CI [-3.04, 9.62], t(44) = 1.05, p = 0.301). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.04, 95% CI [-0.19, 0.27], t(44) = 0.37, p = 0.712; Std. beta =
#     0.07, 95% CI [-0.15, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.81, 95% CI [-8.11, 9.74], t(44) = 0.18, p = 0.856; Std.
#           beta = -0.65, 95% CI [-3.32, 2.03])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -2.84, 95% CI [-11.75, 6.07], t(44) = -0.64, p = 0.524;
#           Std. beta = -0.96, 95% CI [-3.64, 1.72])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.02, 95% CI [-9.08, 9.03], t(44) = -4.70e-03, p =
#             0.996; Std. beta = -0.94, 95% CI [-3.62, 1.75])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and negative (beta = -0.29, 95% CI [-0.57, -0.02], t(44) = -2.15, p =
#                 0.038; Std. beta = -0.27, 95% CI [-0.54, -1.62e-03])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and negative (beta = -0.06, 95% CI [-0.32, 0.19], t(44) =
#                                 -0.48, p = 0.634; Std. beta = -0.08, 95% CI [-0.33, 0.17])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and negative (beta = -0.45, 95% CI [-0.82, -0.08], t(44) = -2.45, p =
#                 0.018; Std. beta = -0.23, 95% CI [-0.59, 0.13])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Trans_Hydroxyproline9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age and Site
# (formula: log(Trans_Hydroxyproline) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.86) and the part
# related to the fixed effects alone (marginal R2) is of 0.31. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 4.23 (95% CI [0.49, 7.98], t(47) = 2.27, p = 0.028). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(47) = -2.40, p = 0.020; Std. beta =
#                                                                          -0.06, 95% CI [-0.15, 0.02])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.27, 95% CI [-6.51, 3.96], t(47) = -0.49, p = 0.627;
#           Std. beta = -0.59, 95% CI [-1.72, 0.54])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -2.94, 95% CI [-8.18, 2.30], t(47) = -1.13, p = 0.265;
#           Std. beta = -0.87, 95% CI [-2.00, 0.26])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -2.96, 95% CI [-8.21, 2.29], t(47) = -1.13, p = 0.263;
#           Std. beta = -0.84, 95% CI [-1.98, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Trans_Hydroxyproline3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age (formula:
#                                                                                              log(Trans_Hydroxyproline) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.72) and the part related to the fixed
# effects alone (marginal R2) is of 0.04. The model's intercept,
# corresponding to Spine.Age = 0, is at 2.47 (95% CI [0.88, 4.06], t(50) =
#                                               3.12, p = 0.003). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(50) = -2.48, p = 0.017; Std. beta =
#                                                                          -0.07, 95% CI [-0.15, 0.02])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

anova(Trans_Hydroxyproline8_model,Trans_Hydroxyproline9_model,Trans_Hydroxyproline3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Trans_Hydroxyproline3_model: log(Trans_Hydroxyproline) ~ Spine.Age + (1 | Site)
# Trans_Hydroxyproline9_model: log(Trans_Hydroxyproline) ~ Spine.Age + Site + (1 | Site)
# Trans_Hydroxyproline8_model: log(Trans_Hydroxyproline) ~ Spine.Age * Site + (1 | Site)
#                               npar    AIC    BIC  logLik deviance  Chisq Df
# Trans_Hydroxyproline3_model    4 163.02 170.98 -77.510   155.02          
# Trans_Hydroxyproline9_model    7 152.00 165.93 -69.001   138.00 17.018  3
# Trans_Hydroxyproline8_model   10 145.61 165.50 -62.804   125.61 12.394  3
# Pr(>Chisq)    
# Trans_Hydroxyproline3_model               
# Trans_Hydroxyproline9_model  0.0007007 ***
#   Trans_Hydroxyproline8_model  0.0061488 ** 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

##  robust rank model with interaction 
Trans_Hydroxyproline8_rmodel <- rlmer(log(Trans_Hydroxyproline) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Trans_Hydroxyproline8_rmodel)
# Robust linear mixed model fit by DAStau 
# Formula: log(Trans_Hydroxyproline) ~ Spine.Age * Site + (1 | Site) 
# Data: PCA_18W 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.4160 -0.4770  0.0427  0.6055  3.0039 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.0000   0.0000  
# Residual             0.4781   0.6914  
# Number of obs: 54, groups: Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              3.46254    0.63095   5.488
# Spine.Age                0.03806    0.09534   0.399
# SiteMatheson             0.64591    0.83699   0.772
# SiteRed River           -3.07775    0.80468  -3.825
# SiteSandy Bar           -0.30622    1.05423  -0.290
# Spine.Age:SiteMatheson  -0.29005    0.11591  -2.502
# Spine.Age:SiteRed River -0.05171    0.10707  -0.483
# Spine.Age:SiteSandy Bar -0.43158    0.15453  -2.793
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.957                                          
# SiteMathesn -0.754  0.721                                   
# SiteRedRivr -0.784  0.750  0.591                            
# SiteSandyBr -0.598  0.573  0.451  0.469                     
# Spn.Ag:StMt  0.787 -0.823 -0.946 -0.617 -0.471              
# Spn.Ag:StRR  0.852 -0.890 -0.642 -0.931 -0.510  0.732       
# Spn.Ag:StSB  0.590 -0.617 -0.445 -0.463 -0.959  0.507  0.549
# 
# Robustness weights for the residuals: 
#   43 weights are ~= 1. The remaining 11 ones are summarized as
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.394   0.479   0.730   0.714   0.886   0.999 
# 
# Robustness weights for the random effects: 
#   [1] 1 1 1 1
# 
# Rho functions used for fitting:
#   Residuals:
#   eff: smoothed Huber (k = 1.345, s = 10) 
# sig: smoothed Huber, Proposal 2 (k = 1.345, s = 10) 
# Random Effects, variance component 1 (Site):
#   eff: smoothed Huber (k = 1.345, s = 10) 
# vcp: smoothed Huber, Proposal 2 (k = 1.345, s = 10) 
emmeans(Trans_Hydroxyproline8_rmodel, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE  df asymp.LCL asymp.UCL
# Dauphin River  3.756 0.225 Inf      3.31     4.197
# Matheson       2.167 0.183 Inf      1.81     2.527
# Red River      0.280 0.204 Inf     -0.12     0.679
# Sandy Bar      0.125 0.268 Inf     -0.40     0.650
# 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df z.ratio p.value
# Dauphin River - Matheson     1.589 0.290 Inf   5.473  <.0001
# Dauphin River - Red River    3.476 0.303 Inf  11.456  <.0001
# Dauphin River - Sandy Bar    3.631 0.350 Inf  10.379  <.0001
# Matheson - Red River         1.888 0.274 Inf   6.887  <.0001
# Matheson - Sandy Bar         2.042 0.325 Inf   6.290  <.0001
# Red River - Sandy Bar        0.155 0.337 Inf   0.460  0.9676
# 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 

syx <- summary(Trans_Hydroxyproline8_rmodel)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.27004
plot(Trans_Hydroxyproline8_rmodel)

# Check model performance
check_model(Trans_Hydroxyproline8_rmodel)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Trans_Hydroxyproline8_rmodel))
qqline(resid(Trans_Hydroxyproline8_rmodel))

# REPORTS
library(report)
report(Trans_Hydroxyproline8_model)
# ormula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap optimizer) to predict
# Trans_Hydroxyproline with Spine.Age and Site (formula: log(Trans_Hydroxyproline) ~ Spine.Age
#                                               * Site). The model included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.94) and the part related to the fixed
# effects alone (marginal R2) is of 0.17. The model's intercept, corresponding to Spine.Age = 0
# and Site = Dauphin River, is at 3.29 (95% CI [-3.04, 9.62], t(44) = 1.05, p = 0.301). Within
# this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive (beta = 0.04, 95% CI
#                                                                            [-0.19, 0.27], t(44) = 0.37, p = 0.712; Std. beta = 0.07, 95% CI [-0.15, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and positive (beta = 0.81,
#                                                                                95% CI [-8.11, 9.74], t(44) = 0.18, p = 0.856; Std. beta = -0.65, 95% CI [-3.32, 2.03])
# - The effect of Site [Red River] is statistically non-significant and negative (beta = -2.84,
#                                                                                 95% CI [-11.75, 6.07], t(44) = -0.64, p = 0.524; Std. beta = -0.96, 95% CI [-3.64, 1.72])
# - The effect of Site [Sandy Bar] is statistically non-significant and negative (beta = -0.02,
#                                                                                 95% CI [-9.08, 9.03], t(44) = -4.70e-03, p = 0.996; Std. beta = -0.94, 95% CI [-3.62, 1.75])
# - The effect of Spine Age × Site [Matheson] is statistically significant and negative (beta =
#                                                                                          -0.29, 95% CI [-0.57, -0.02], t(44) = -2.15, p = 0.038; Std. beta = -0.27, 95% CI [-0.54,
#                                                                                                                                                                             -1.62e-03])
# - The effect of Spine Age × Site [Red River] is statistically non-significant and negative
# (beta = -0.06, 95% CI [-0.32, 0.19], t(44) = -0.48, p = 0.634; Std. beta = -0.08, 95% CI
#   [-0.33, 0.17])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant and negative (beta
#                                                                                         = -0.45, 95% CI [-0.82, -0.08], t(44) = -2.45, p = 0.018; Std. beta = -0.23, 95% CI [-0.59,
#                                                                                                                                                                              0.13])
# 
# Standardized parameters were obtained by fitting the model on a standardized version of the
# dataset. 95% Confidence Intervals (CIs) and p-values were computed using a Wald
# t-distribution approximation.
report(Trans_Hydroxyproline3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Trans_Hydroxyproline with Spine.Age (formula:
#                                                                                              log(Trans_Hydroxyproline) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.72) and the part related to the fixed
# effects alone (marginal R2) is of 0.04. The model's intercept,
# corresponding to Spine.Age = 0, is at 2.47 (95% CI [0.88, 4.06], t(50) =
#                                               3.12, p = 0.003). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(50) = -2.48, p = 0.017; Std. beta =
#                                                                          -0.07, 95% CI [-0.15, 0.02])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.



#### C10:2 ####

C10_2_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = C10_2)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C10_2_lm_plot
# no intercation model
C10_23_model <- lmer(log(1000*C10_2)~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C10_23_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C10_2) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 53
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.0911 -0.5931 -0.1017  0.3900  2.8459 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.01838  0.1356  
# Residual             0.12557  0.3544  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept) -2.67847    0.15313 -17.492
# Spine.Age    0.02589    0.01679   1.542
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.838
C10_23_model_emm <- emmeans(C10_23_model, ~ Spine.Age)

C10_23_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7  -2.48 0.084 2.84    -2.76     -2.2
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
plot(C10_23_model)

# Check model perfomance
check_model(C10_23_model) 
# Plot the Q-Q plot for the residuals

qqnorm(resid(C10_23_model))
qqline(resid(C10_23_model))
Anova(C10_23_model,type="III") # non significant
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C10_2)
# Chisq Df Pr(>Chisq)    
# (Intercept) 305.9635  1     <2e-16 ***
#   Spine.Age     2.3779  1     0.1231    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C10_23_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C10_2 with Spine.Age (formula: log(C10_2) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is moderate (conditional R2 =
# 0.16) and the part related to the fixed effects alone (marginal R2) is of
# 0.04. The model's intercept, corresponding to Spine.Age = 0, is at -2.68
# (95% CI [-2.99, -2.37], t(50) = -17.49, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-7.83e-03, 0.06], t(50) = 1.54, p = 0.129; Std.
#   beta = 0.08, 95% CI [-0.02, 0.18])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

#### c10:2
# MODEL WITH INTERACTION THE SIMPLEST ONE
shapiro.test(C10_2)
# Shapiro-Wilk normality test
# 
# data:  C10_2
# W = 0.85895, p-value = 1.433e-05
shapiro.test(log(C10_2))
# Shapiro-Wilk normality test
# 
# data:  log(C10_2)
# W = 0.9704, p-value = 0.2007

##  model with interaction
C10_28_model <- lmer(log(1000*C10_2) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C10_28_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C10_2) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 64.8
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.8087 -0.5738 -0.1092  0.3958  2.8277 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.001988 0.04459 
# Residual             0.130468 0.36120 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              4.26995    0.32444  13.161
# Spine.Age               -0.01366    0.04856  -0.281
# SiteMatheson            -0.22941    0.43094  -0.532
# SiteRed River            0.17315    0.41467   0.418
# SiteSandy Bar            0.24384    0.54064   0.451
# Spine.Age:SiteMatheson   0.05993    0.05904   1.015
# Spine.Age:SiteRed River  0.03273    0.05453   0.600
# Spine.Age:SiteSandy Bar  0.01305    0.07871   0.166
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.948                                          
# SiteMathesn -0.753  0.714                                   
# SiteRedRivr -0.782  0.742  0.589                            
# SiteSandyBr -0.600  0.569  0.452  0.470                     
# Spn.Ag:StMt  0.780 -0.823 -0.936 -0.610 -0.468              
# Spn.Ag:StRR  0.844 -0.890 -0.635 -0.920 -0.506  0.732       

stargazer(C10_28_model, type = "text")
# ===================================================
#   Dependent variable:    
#   ---------------------------
#   log(1000 * C10_2)     
# ---------------------------------------------------
#   Spine.Age                         -0.014           
# (0.049)          
# 
# SiteMatheson                      -0.229           
# (0.431)          
# 
# SiteRed River                      0.173           
# (0.415)          
# 
# SiteSandy Bar                      0.244           
# (0.541)          
# 
# Spine.Age:SiteMatheson             0.060           
# (0.059)          
# 
# Spine.Age:SiteRed River            0.033           
# (0.055)          
# 
# Spine.Age:SiteSandy Bar            0.013           
# (0.079)          
# 
# Constant                         4.270***          
#   (0.324)          
# 
# ---------------------------------------------------
#   Observations                        54             
# Log Likelihood                    -32.413          
# Akaike Inf. Crit.                 84.825           
# Bayesian Inf. Crit.               104.715          
# ===================================================
#   Note:                   *p<0.1; **p<0.05; ***p<0.01
##  model
anova(C10_28_model)
# Analysis of Variance Table
# npar                Sum Sq Mean Sq F value
# Spine.Age         1 0.54873 0.54873  4.2058
# Site              3 0.89164 0.29721  2.2781
Anova(C10_28_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C10_2)
# Chisq Df Pr(>Chisq)    
# (Intercept)    173.2091  1     <2e-16 ***
#   Spine.Age        0.0791  1     0.7785    
# Site             1.3957  3     0.7066    
# Spine.Age:Site   1.2034  3     0.7522    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


confint(C10_28_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                   0.00000000 0.11729278
# .sigma                   0.27917030 0.40769095
# (Intercept)              3.67809213 4.86181010
# Spine.Age               -0.10308208 0.07576776
# SiteMatheson            -1.01456388 0.55574091
# SiteRed River           -0.58170122 0.92800534
# SiteSandy Bar           -0.74500289 1.23267618
# Spine.Age:SiteMatheson  -0.04878820 0.16865310
# Spine.Age:SiteRed River -0.06770134 0.13316344
# Spine.Age:SiteSandy Bar -0.13189782 0.15800730
syx <- summary(C10_28_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.067409
plot(C10_28_model)
# Check model performance
check_model(C10_28_model) # collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(C10_28_model))
qqline(resid(C10_28_model))
report(C10_28_model)
# ixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C10_2 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C10_2) ~ Spine.Age * Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is moderate
# (conditional R2 = 0.22) and the part related to the fixed effects alone
# (marginal R2) is of 0.21. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 4.27 (95% CI [3.62, 4.92],
#                                                     t(44) = 13.16, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.01, 95% CI [-0.11, 0.08], t(44) = -0.28, p = 0.780; Std. beta
#   = -1.48, 95% CI [-3.58, 0.61])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.23, 95% CI [-1.10, 0.64], t(44) = -0.53, p = 0.597;
#           Std. beta = 0.43, 95% CI [-3.77, 4.63])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.17, 95% CI [-0.66, 1.01], t(44) = 0.42, p = 0.678;
#           Std. beta = -0.82, 95% CI [-4.73, 3.09])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.24, 95% CI [-0.85, 1.33], t(44) = 0.45, p = 0.654;
#           Std. beta = -0.72, 95% CI [-4.55, 3.10])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 0.06, 95% CI [-0.06, 0.18], t(44) =
#                                 1.02, p = 0.316; Std. beta = 1.11, 95% CI [-2.44, 4.67])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.03, 95% CI [-0.08, 0.14], t(44) =
#                                 0.60, p = 0.551; Std. beta = 2.20, 95% CI [-0.06, 4.45])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.01, 95% CI [-0.15, 0.17], t(44) =
#                                 0.17, p = 0.869; Std. beta = 6.51, 95% CI [2.90, 10.11])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
## with site extra
C10_29_model <- lmer(log(1000*C10_2) ~ Spine.Age+Site + (1 | Site), data = PCA_18W)
summary(C10_29_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C10_2) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 53.8
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1220 -0.4840 -0.1448  0.3405  3.0102 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.03069  0.1752  
# Residual             0.12568  0.3545  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    4.05250    0.22620  17.915
# Spine.Age      0.02068    0.01737   1.191
# SiteMatheson   0.18941    0.28081   0.675
# SiteRed River  0.37532    0.28502   1.317
# SiteSandy Bar  0.31942    0.28942   1.104
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.486                     
# SiteMathesn -0.569 -0.095              
# SiteRedRivr -0.511 -0.195  0.507       
# SiteSandyBr -0.587 -0.020  0.483  0.478
emmeans(C10_29_model, pairwise ~ Site, adjust = "tukey")
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   4.21 0.199  962     3.82     4.60
# Matheson        4.40 0.198 1064     4.01     4.79
# Red River       4.59 0.200  893     4.19     4.98
# Sandy Bar       4.53 0.212  486     4.11     4.95
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df t.ratio p.value
# Dauphin River - Matheson   -0.1894 0.281 999  -0.675  0.9067
# Dauphin River - Red River  -0.3753 0.285 821  -1.317  0.5524
# Dauphin River - Sandy Bar  -0.3194 0.289 687  -1.104  0.6874
# Matheson - Red River       -0.1859 0.281 987  -0.661  0.9115
# Matheson - Sandy Bar       -0.1300 0.290 669  -0.448  0.9700
# Red River - Sandy Bar       0.0559 0.294 591   0.190  0.9976
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 


syx <- summary(C10_29_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.064859
plot(C10_29_model)

# Check model performance
check_model(C10_29_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C10_29_model))
qqline(resid(C10_29_model))
Anova(C10_29_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C10_2)
# Chisq Df Pr(>Chisq)    
# (Intercept) 320.9544  1     <2e-16 ***
#   Spine.Age     1.4178  1     0.2338    
# Site          2.0557  3     0.5609    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C10_29_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C10_2 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C10_2) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.33) and the part related to the fixed effects alone
# (marginal R2) is of 0.17. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 4.05 (95% CI [3.60, 4.51],
#                                                     t(47) = 17.92, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.01, 0.06], t(47) = 1.19, p = 0.240; Std. beta =
#     0.37, 95% CI [-0.43, 1.17])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.19, 95% CI [-0.38, 0.75], t(47) = 0.67, p = 0.503;
#           Std. beta = -1.50, 95% CI [-5.50, 2.50])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.38, 95% CI [-0.20, 0.95], t(47) = 1.32, p = 0.194;
#           Std. beta = -2.20, 95% CI [-6.09, 1.68])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.32, 95% CI [-0.26, 0.90], t(47) = 1.10, p = 0.275;
#           Std. beta = -2.04, 95% CI [-5.88, 1.80])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
Anova(C10_29_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C10_2)
# Chisq Df Pr(>Chisq)    
# (Intercept) 320.9544  1     <2e-16 ***
#   Spine.Age     1.4178  1     0.2338    
# Site          2.0557  3     0.5609    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

anova(C10_28_model,C10_29_model,C10_23_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   C10_23_model: log(C10_2) ~ Spine.Age + (1 | Site)
# C10_29_model: log(1000 * C10_2) ~ Spine.Age + Site + (1 | Site)
# C10_28_model: log(1000 * C10_2) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)  
# C10_23_model    4 51.336 59.292 -21.668   43.336                       
# C10_29_model    7 50.004 63.927 -18.002   36.004 7.3327  3    0.06202 .
# C10_28_model   10 54.609 74.499 -17.305   34.609 1.3945  3    0.70682  
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### C6:1 ####

# retrying the models

C6_1_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = C6_1)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C6_1_lm_plot

# MODEL WITH INTERACTION THE SIMPLEST ONE
shapiro.test(C6_1 
)
# Shapiro-Wilk normality test
# 
# data:  C6_1
# W = 0.96359, p-value = 0.09978


##  model with interaction
C6_18_model <- lmer(C6_1 ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C6_18_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: C6_1 ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: -141.2
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.24634 -0.77184 -0.01706  0.53176  2.54424 
# 
# Random effects:
#   Groups   Name        Variance  Std.Dev.
# Site     (Intercept) 0.0002525 0.01589 
# Residual             0.0014795 0.03846 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              0.268329   0.037731   7.112
# Spine.Age               -0.009498   0.005171  -1.837
# SiteMatheson            -0.060633   0.050654  -1.197
# SiteRed River           -0.056582   0.049090  -1.153
# SiteSandy Bar            0.003606   0.061437   0.059
# Spine.Age:SiteMatheson   0.008163   0.006287   1.298
# Spine.Age:SiteRed River  0.004763   0.005807   0.820
# Spine.Age:SiteSandy Bar -0.002009   0.008382  -0.240
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.868                                          
# SiteMathesn -0.745  0.647                                   
# SiteRedRivr -0.769  0.667  0.573                            
# SiteSandyBr -0.614  0.533  0.457  0.472                     
# Spn.Ag:StMt  0.714 -0.823 -0.848 -0.549 -0.438              
# Spn.Ag:StRR  0.773 -0.890 -0.576 -0.828 -0.475  0.732       
# Spn.Ag:StSB  0.535 -0.617 -0.399 -0.412 -0.892  0.507  0.549       

stargazer(C6_18_model, type = "text")
# ===================================================
#   Dependent variable:    
#   ---------------------------
#   C6_1            
# ---------------------------------------------------
#   Spine.Age                         -0.009*          
#   (0.005)          
# 
# SiteMatheson                      -0.061           
# (0.051)          
# 
# SiteRed River                     -0.057           
# (0.049)          
# 
# SiteSandy Bar                      0.004           
# (0.061)          
# 
# Spine.Age:SiteMatheson             0.008           
# (0.006)          
# 
# Spine.Age:SiteRed River            0.005           
# (0.006)          
# 
# Spine.Age:SiteSandy Bar           -0.002           
# (0.008)          
# 
# Constant                         0.268***          
#   (0.038)          
# 
# ---------------------------------------------------
#   Observations                        54             
# Log Likelihood                    70.614           
# Akaike Inf. Crit.                -121.228          
# Bayesian Inf. Crit.              -101.339          
# ===================================================
#   Note:                   *p<0.1; **p<0.05; ***p<0.01
##  model
anova(C6_18_model)
# Analysis of Variance Table
# npar    Sum Sq   Mean Sq F value
# Spine.Age         1 0.0127085 0.0127085  8.5898
# Site              3 0.0015810 0.0005270  0.3562
# Spine.Age:Site    3 0.0041282 0.0013761  0.9301


# forest_model(C10_28_model) #Error: No tidy method for objects of class lmerMod
report(C6_18_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C6_1 with Spine.Age and Site (formula: C6_1 ~
#                                                                                       Spine.Age * Site). The model included Site as random effect (formula: ~1
#                                                                                                                                                    | Site). The model's total explanatory power is substantial (conditional
# R2 = 0.35) and the part related to the fixed effects alone (marginal R2)
# is of 0.24. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at 0.27 (95% CI [0.19, 0.34], t(44) = 7.11, p <
#                                     .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -9.50e-03, 95% CI [-0.02, 9.23e-04], t(44) = -1.84, p = 0.073;
#   Std. beta = -0.69, 95% CI [-1.44, 0.07])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.06, 95% CI [-0.16, 0.04], t(44) = -1.20, p = 0.238;
#           Std. beta = 0.05, 95% CI [-1.24, 1.34])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.06, 95% CI [-0.16, 0.04], t(44) = -1.15, p = 0.255;
#           Std. beta = -0.47, 95% CI [-1.77, 0.84])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 3.61e-03, 95% CI [-0.12, 0.13], t(44) = 0.06, p = 0.953;
#           Std. beta = -0.28, 95% CI [-1.66, 1.10])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 8.16e-03, 95% CI [-4.51e-03, 0.02],
#                               t(44) = 1.30, p = 0.201; Std. beta = 0.59, 95% CI [-0.33, 1.51])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 4.76e-03, 95% CI [-6.94e-03, 0.02],
#                               t(44) = 0.82, p = 0.417; Std. beta = 0.34, 95% CI [-0.50, 1.19])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and negative (beta = -2.01e-03, 95% CI [-0.02, 0.01],
#                               t(44) = -0.24, p = 0.812; Std. beta = -0.15, 95% CI [-1.37, 1.08])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
confint(C6_18_model)
# Computing profile confidence intervals ...
# 2.5 %       97.5 %
#   .sig01                   0.000000000 1.249035e-02
# .sigma                   0.029728541 4.341456e-02
# (Intercept)              0.205302136 3.313550e-01
# Spine.Age               -0.019020955 2.456954e-05
# SiteMatheson            -0.144242601 2.297744e-02
# SiteRed River           -0.136965289 2.380172e-02
# SiteSandy Bar           -0.101694382 1.089065e-01
# Spine.Age:SiteMatheson  -0.003414431 1.974066e-02
# Spine.Age:SiteRed River -0.005932417 1.545745e-02
# Spine.Age:SiteSandy Bar -0.017444510 1.342717e-02
syx <- summary(C6_18_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.00074
plot(C6_18_model)
# Check model performance
check_model(C6_18_model)
# Plot the Q-Q plot for the residuals
qqnorm(resid(C6_18_model))
qqline(resid(C6_18_model))
Anova(C6_18_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: C6_1
# Chisq Df Pr(>Chisq)    
# (Intercept)    50.5755  1  1.147e-12 ***
#   Spine.Age       3.3741  1    0.06623 .  
# Site            2.5383  3    0.46840    
# Spine.Age:Site  2.7903  3    0.42511    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


## model without interaction
C6_13_model <- lmer(C6_1 ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C6_13_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: C6_1 ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: -180.9
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.60287 -0.82545  0.05081  0.47058  2.85595 
# 
# Random effects:
#   Groups   Name        Variance  Std.Dev.
# Site     (Intercept) 2.432e-05 0.004931
# Residual             1.469e-03 0.038329
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  0.237371   0.014537  16.328
# Spine.Age   -0.005970   0.001734  -3.442
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.917
C6_13_model_emm <- emmeans(C6_13_model, ~ Spine.Age)
C6_13_model_emm
# Spine.Age emmean      SE   df lower.CL upper.CL
# 7.7  0.191 0.00588 2.56    0.171    0.212
# 
# Degrees-of-freedom method: kenward-roger 
# Confidence level used: 0.95 
stargazer(C6_13_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   C6_1            
# -----------------------------------------------
#   Spine.Age                    -0.006***         
#   (0.002)          
# 
# Constant                     0.237***          
#   (0.015)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                90.428           
# Akaike Inf. Crit.            -172.856          
# Bayesian Inf. Crit.          -164.900          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

plot(C6_13_model)

# Check model perfomance
check_model(C6_13_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C6_13_model))
qqline(resid(C6_13_model))
Anova(C6_13_model)
# Analysis of Deviance Table (Type II Wald chisquare tests)
# 
# Response: C6_1
# Chisq Df Pr(>Chisq)    
# Spine.Age 11.846  1   0.000578 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

report(C6_13_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C6_1 with Spine.Age (formula: C6_1 ~ Spine.Age).
# The model included Site as random effect (formula: ~1 | Site). The
# model's total explanatory power is moderate (conditional R2 = 0.20) and
# the part related to the fixed effects alone (marginal R2) is of 0.19. The
# model's intercept, corresponding to Spine.Age = 0, is at 0.24 (95% CI
#                                                                [0.21, 0.27], t(50) = 16.33, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -5.97e-03, 95% CI [-9.45e-03, -2.49e-03], t(50) = -3.44, p = 0.001;
#                                                                        Std. beta = -0.43, 95% CI [-0.68, -0.18])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction site separate
C6_19_model <- lmer(C6_1 ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C6_19_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: C6_1 ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: -164.1
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.4377 -0.8219 -0.0187  0.4088  2.7068 
# 
# Random effects:
#   Groups   Name        Variance  Std.Dev.
# Site     (Intercept) 0.0007634 0.02763 
# Residual             0.0014732 0.03838 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    0.239688   0.031676   7.567
# Spine.Age     -0.004976   0.001880  -2.647
# SiteMatheson  -0.003350   0.041611  -0.081
# SiteRed River -0.025650   0.041945  -0.612
# SiteSandy Bar -0.011292   0.042297  -0.267
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.376                     
# SiteMathesn -0.628 -0.069              
# SiteRedRivr -0.595 -0.143  0.504       
# SiteSandyBr -0.638 -0.015  0.491  0.488
Anova(C6_19_model,type="III")# significant
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: C6_1
# Chisq Df Pr(>Chisq)    
# (Intercept) 57.2582  1  3.822e-14 ***
#   Spine.Age    7.0056  1   0.008126 ** 
#   Site         0.4460  3   0.930582    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
qqnorm(resid(C6_19_model))
qqline(resid(C6_19_model))

report(C6_19_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: C6_1 ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: -164.1
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.4377 -0.8219 -0.0187  0.4088  2.7068 
# 
# Random effects:
#   Groups   Name        Variance  Std.Dev.
# Site     (Intercept) 0.0007634 0.02763 
# Residual             0.0014732 0.03838 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    0.239688   0.031676   7.567
# Spine.Age     -0.004976   0.001880  -2.647
# SiteMatheson  -0.003350   0.041611  -0.081
# SiteRed River -0.025650   0.041945  -0.612
# SiteSandy Bar -0.011292   0.042297  -0.267
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.376                     
# SiteMathesn -0.628 -0.069              
# SiteRedRivr -0.595 -0.143  0.504       
# SiteSandyBr -0.638 -0.015  0.491  0.488
qqnorm(resid(C6_19_model))
qqline(resid(C6_19_model))
report(C6_19_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C6_1 with Spine.Age and Site (formula: C6_1 ~
#                                                                                       Spine.Age + Site). The model included Site as random effect (formula: ~1| Site). The model's total explanatory power is substantial (conditional
# # R2 = 0.45) and the part related to the fixed effects alone (marginal R2)
## # is of 0.17. The model's intercept, corresponding to Spine.Age = 0 #and
# Site = Dauphin River, is at 0.24 (95% CI [0.18, 0.30], t(47) = 7.57, p <
#                                     .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -4.98e-03, 95% CI [-8.76e-03, -1.19e-03], t(47) = -2.65, p = 0.011;
#                                                                        Std. beta = -0.36, 95% CI [-0.63, -0.09])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -3.35e-03, 95% CI [-0.09, 0.08], t(47) = -0.08, p =
#             0.936; Std. beta = -0.08, 95% CI [-1.33, 1.17])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.03, 95% CI [-0.11, 0.06], t(47) = -0.61, p = 0.544;
#           Std. beta = -0.60, 95% CI [-1.88, 0.68])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.01, 95% CI [-0.10, 0.07], t(47) = -0.27, p = 0.791;
#           Std. beta = -0.26, 95% CI [-1.57, 1.04])

# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
# plot(C6_19_model)

# Check model perfomance
check_model(C6_19_model)

anova(C6_18_model,C6_19_model,C6_13_model)
# Data: PCA_18W
# Models:
#   C6_13_model: C6_1 ~ Spine.Age + (1 | Site)
# C6_19_model: C6_1 ~ Spine.Age + Site + (1 | Site)
# C6_18_model: C6_1 ~ Spine.Age * Site + (1 | Site)
# npar     AIC     BIC logLik deviance  Chisq Df Pr(>Chisq)
# C6_13_model    4 -192.40 -184.44 100.20  -200.40                     
# C6_19_model    7 -190.10 -176.18 102.05  -204.10 3.7028  3     0.2954
# C6_18_model   10 -187.28 -167.39 103.64  -207.28 3.1800  3     0.3647

#### serine ####
# retrying the models

Serine_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = Serine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Serine_lm_plot


# MODEL WITH INTERACTION THE SIMPLEST ONE
shapiro.test(Serine)
# Shapiro-Wilk normality test
# 
# data:  Serine
# W = 0.88959, p-value = 0.0001266
shapiro.test(log(Serine))
# Shapiro-Wilk normality test
# # 
# # data:  log(Serine)
# Shapiro-Wilk normality test
# 
# data:  log(Serine)
# W = 0.97497, p-value = 0.3158


##  model WITH INTERACTION
Serine8_model <- lmer(log(Serine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Serine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Serine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 56.3
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.2135 -0.6503  0.0825  0.5122  2.2653 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.01199  0.1095  
# Residual             0.10842  0.3293  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              4.65781    0.31275  14.893
# Spine.Age               -0.02853    0.04426  -0.645
# SiteMatheson            -0.44712    0.41833  -1.069
# SiteRed River           -0.88841    0.40443  -2.197
# SiteSandy Bar           -2.15771    0.51339  -4.203
# Spine.Age:SiteMatheson   0.06290    0.05382   1.169
# Spine.Age:SiteRed River  0.13470    0.04971   2.710
# Spine.Age:SiteSandy Bar  0.31436    0.07175   4.381
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.896                                          
# SiteMathesn -0.748  0.670                                   
# SiteRedRivr -0.773  0.693  0.578                            
# SiteSandyBr -0.609  0.546  0.455  0.471                     
# Spn.Ag:StMt  0.737 -0.823 -0.879 -0.570 -0.449              
# Spn.Ag:StRR  0.798 -0.890 -0.597 -0.860 -0.486  0.732       
# Spn.Ag:StSB  0.553 -0.617 -0.413 -0.428 -0.914  0.507  0.549   

stargazer(Serine8_model, type = "text")
# ===================================================
#   Dependent variable:    
#   ---------------------------
#   log(Serine)        
# ---------------------------------------------------
#   Spine.Age                         -0.029           
# (0.044)          
# 
# SiteMatheson                      -0.447           
# (0.418)          
# 
# SiteRed River                    -0.888**          
#   (0.404)          
# 
# SiteSandy Bar                    -2.158***         
#   (0.513)          
# 
# Spine.Age:SiteMatheson             0.063           
# (0.054)          
# 
# Spine.Age:SiteRed River          0.135***          
#   (0.050)          
# 
# Spine.Age:SiteSandy Bar          0.314***          
#   (0.072)          
# 
# Constant                         4.658***          
#   (0.313)          
# 
# ---------------------------------------------------
#   Observations                        54             
# Log Likelihood                    -28.154          
# Akaike Inf. Crit.                 76.308           
# Bayesian Inf. Crit.               96.198           
# ===================================================
#   Note:                   *p<0.1; **p<0.05; ***p<0.01
anova(Serine8_model)
# Analysis of Variance Table
#                  npar Sum Sq Mean Sq F value
# Spine.Age         1 3.2265  3.2265 29.7605
# Site              3 0.0978  0.0326  0.3005
# Spine.Age:Site    3 2.4745  0.8248  7.6080


confint(Serine8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.10692223
# .sigma                   0.25448614  0.37164303
# (Intercept)              4.11828661  5.19734056
# Spine.Age               -0.11004686  0.05298913
# SiteMatheson            -1.16284680  0.26861208
# SiteRed River           -1.57651910 -0.20030036
# SiteSandy Bar           -3.05912128 -1.25630804
# Spine.Age:SiteMatheson  -0.03620898  0.16200622
# Spine.Age:SiteRed River  0.04315106  0.22625544
# Spine.Age:SiteSandy Bar  0.18222664  0.44649843
syx <- summary(Serine8_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.055704
plot(Serine8_model)
# Check model performance
check_model(Serine8_model) # NOT A GOOD MODEL
# Plot the Q-Q plot for the residuals
qqnorm(resid(Serine8_model))
qqline(resid(Serine8_model))
Anova(Serine8_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Serine)
#                      Chisq Df Pr(>Chisq)    
#   (Intercept)    221.8090  1  < 2.2e-16 ***
#   Spine.Age        0.4154  1  0.5192442    
#   Site            19.1635  3  0.0002529 ***
#   Spine.Age:Site  22.8240  3  4.394e-05 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Serine8_model)
##  robust rank model with interaction
Serine9_model <- lmer(log(Serine)~ Spine.Age+Site + (1 | Site), data = PCA_18W)
summary(Serine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Serine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 63.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.0580 -0.5205 -0.1318  0.7338  1.7209 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.0518   0.2276  
# Residual             0.1523   0.3902  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    3.95141    0.27678  14.276
# Spine.Age      0.08301    0.01911   4.343
# SiteMatheson  -0.12334    0.35323  -0.349
# SiteRed River  0.03884    0.35728   0.109
# SiteSandy Bar -0.09914    0.36155  -0.274
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.437                     
# SiteMathesn -0.597 -0.083              
# SiteRedRivr -0.552 -0.171  0.505       
# SiteSandyBr -0.611 -0.018  0.487  0.483 
emmeans(Serine9_model, pairwise ~ Site, adjust = "tukey")
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   4.59 0.250 1637     4.10     5.08
# Matheson        4.47 0.249 1822     3.98     4.96
# Red River       4.63 0.251 1512     4.14     5.12
# Sandy Bar       4.49 0.263  781     3.98     5.01
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE   df t.ratio p.value
# Dauphin River - Matheson    0.1233 0.353 1703   0.349  0.9854
# Dauphin River - Red River  -0.0388 0.357 1381  -0.109  0.9995
# Dauphin River - Sandy Bar   0.0991 0.362 1139   0.274  0.9928
# Matheson - Red River       -0.1622 0.353 1683  -0.459  0.9679
# Matheson - Sandy Bar       -0.0242 0.362 1107  -0.067  0.9999
# Red River - Sandy Bar       0.1380 0.366  968   0.377  0.9817
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 

syx <- summary(Serine9_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.079113
plot(Serine9_model)
check_model(Serine9_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Serine9_model))
qqline(resid(Serine9_model))
Anova(Serine9_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Serine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 203.8078  1  < 2.2e-16 ***
#   Spine.Age    18.8599  1  1.407e-05 ***
#   Site          0.2863  3     0.9626    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Serine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Serine with Spine.Age and Site (formula:
#                                                                                         log(Serine) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.46) and the part related to the fixed effects alone
# (marginal R2) is of 0.27. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 3.95 (95% CI [3.39, 4.51],
#                                                     t(47) = 14.28, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.08, 95% CI [0.04, 0.12], t(47) = 4.34, p < .001; Std. beta = 0.20,
#                                                                        95% CI [0.11, 0.29])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.12, 95% CI [-0.83, 0.59], t(47) = -0.35, p = 0.729;
#           Std. beta = -0.10, 95% CI [-0.33, 0.13])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.04, 95% CI [-0.68, 0.76], t(47) = 0.11, p = 0.914;
#           Std. beta = 0.04, 95% CI [-0.21, 0.28])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.10, 95% CI [-0.83, 0.63], t(47) = -0.27, p = 0.785;
# #           Std. beta = -0.04, 95% CI [-0.29, 0.22])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
## model without interaction lme4
Serine3_model <- lmer(log(Serine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Serine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Serine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 58.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.2381 -0.5327 -0.1148  0.6143  1.8541 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.0000   0.000   
# Residual             0.1482   0.385   
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  3.88565    0.14198  27.368
# Spine.Age    0.08635    0.01713   5.041
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.929
# optimizer (nloptwrap) convergence code: 0 (OK)
# boundary (singular) fit: see help('isSingular')

stargazer(Serine3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Serine)        
# -----------------------------------------------
#   Spine.Age                    0.086***          
#   (0.017)          
# 
# Constant                     3.886***          
#   (0.142)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -29.261          
# Akaike Inf. Crit.             66.523           
# Bayesian Inf. Crit.           74.478           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

# Check model perfomance
check_model(Serine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Serine3_model))
qqline(resid(Serine3_model))
Anova(Serine3_model,typr="III")
# Analysis of Deviance Table (Type II Wald chisquare tests)
# 
# Response: log(Serine)
# Chisq Df Pr(>Chisq)    
# Spine.Age 25.415  1  4.624e-07 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
anova(Serine8_model,Serine9_model,Serine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Serine3_model: log(Serine) ~ Spine.Age + (1 | Site)
# Serine9_model: log(Serine) ~ Spine.Age + Site + (1 | Site)
# Serine8_model: log(Serine) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df Pr(>Chisq)
# Serine3_model    4 56.129 64.084 -24.064   48.129                      
# Serine9_model    7 60.368 74.291 -23.184   46.368  1.7603  3     0.6236
# Serine8_model   10 44.611 64.501 -12.306   24.611 21.7572  3  7.328e-05
# 
# Serine3_model    
# Serine9_model    
# Serine8_model ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


report(Serine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Serine with Spine.Age (formula: log(Serine) ~
#                                                                                Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                        Site). The model's explanatory power related to the fixed effects alone
# (marginal R2) is 0.32. The model's intercept, corresponding to Spine.Age
# = 0, is at 3.89 (95% CI [3.60, 4.17], t(50) = 27.37, p < .001). Within
# this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.09, 95% CI [0.05, 0.12], t(50) = 5.04, p < .001; Std. beta = 0.21,
#                                                                        95% CI [0.13, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.



PCA_18W <- read.csv("F:/Chapter 2 Analysis/PCA_18W.csv")
### C10_2 ####

# Create the scatter plot
ggplot(PCA_18W, aes(x = Site, y = C10_2
                    , color = Sex)) +
  geom_point() +
  labs(x = "Site", y = " C10_2 ", title = " C10_2")

C10_2_dotplot <- ggplot(PCA_18W, aes(x = Site, y = C10_2
                                     , color = Age_Category)) +
  geom_boxplot() +
  labs(x = "Site", y = " C10_2 ", title = " C10_2
 by Site and Age") + theme_bw()
save(C10_2_dotplot, file = " C10_2_dotplot.RData")
C10_2_dotplot
# To load the plot object later
load("C10_2_dotplot.RData")
print(C10_2_dotplot)



C10_2_loess_plot <- ggplot(data = PCA_18W, 
                           mapping = aes(x = Spine.Age, y = C10_2
                           )) +
  geom_point(aes(color = Site, size= 1)) +
  geom_smooth() + theme_bw()+
  sm_hvgrid(borders = FALSE)
C10_2_loess_plot
save(C10_2_dotplot, file = " C10_2_dotplot.RData")

# # To load the plot object later
load("C10_2_dotplot.RData")
print(C10_2_dotplot)

ggplot(data = PCA_18W, 
       mapping = aes(x = Spine.Age, y = C10_2) +
         geom_point(aes(color = Site, size = 1)) +
         geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
         theme_bw() +
         sm_hvgrid(borders = FALSE))

C10_2_lm_plot<- ggplot(data = PCA_18W, 
                       mapping = aes(x = Spine.Age, y = C10_2)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C10_2_lm_plot
Save(C10_2_lm_plot, file = " C10_2_lm_plot.RData")

# To load the plot object later
Load(C10_2_lm_dotplot.RData)
print(C10_2_lm_dotplot)

C10_2_dotplot <- ggplot(data = PCA_18W, 
                        mapping = aes(x = Spine.Age, y = C10_2, color = Site, shape = Age_Category, size = 1)) +
  geom_point() +
  sm_hvgrid(borders = FALSE, legends = T) #+
#sm_statCorr()
C10_2_dotplot

Save(C10_2_dotplot, file = " C10_2_dotplot.RData")

# To load the plot object later
load("C10_2_dotplot.RData")
print(C10_2_dotplot)

#test
(shapiro.test(PCA_18W$C10_2))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C10_2
# W = 0.85895, p-value = 1.433e-05

library(lme4)

attach(PCA_18W)

#### c16_2 ####

# retrying the models

C16_2_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = C16_2)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C16_2_lm_plot

# MODEL WITH INTERACTION THE SIMPLEST ONE

shapiro.test(log(C16_2))
# Shapiro-Wilk normality test
# 
# data:  log(C16_2)
# W = 0.93018, p-value = 0.003709
hist(C16_2)
hist(log(C16_2))
shapiro.test(sqrt(C16_2)) # no good best log

##  model with interaction
C16_28_model <- lmer(log(1000*C16_2) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C16_28_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C16_2) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 63.6
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.3999 -0.5595 -0.0326  0.5083  4.0474 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.002228 0.0472  
# Residual             0.126923 0.3563  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              3.00834    0.32046   9.388
# Spine.Age               -0.08110    0.04789  -1.693
# SiteMatheson            -0.72496    0.42574  -1.703
# SiteRed River           -0.46649    0.40971  -1.139
# SiteSandy Bar           -0.84995    0.53380  -1.592
# Spine.Age:SiteMatheson   0.12001    0.05823   2.061
# Spine.Age:SiteRed River  0.12556    0.05379   2.334
# Spine.Age:SiteSandy Bar  0.14961    0.07763   1.927
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.947                                          
# SiteMathesn -0.753  0.712                                   
# SiteRedRivr -0.782  0.740  0.589                            
# SiteSandyBr -0.600  0.568  0.452  0.470                     
# Spn.Ag:StMt  0.779 -0.823 -0.934 -0.609 -0.467              
# Spn.Ag:StRR  0.843 -0.890 -0.634 -0.919 -0.506  0.732       
# Spn.Ag:StSB  0.584 -0.617 -0.440 -0.457 -0.951  0.507  0.549
stargazer(C16_28_model, type = "text")
# 
# ===================================================
#   Dependent variable:    
#   ---------------------------
#   log(1000 * C16_2)     
# ---------------------------------------------------
#   Spine.Age                         -0.081*          
#   (0.048)          
# 
# SiteMatheson                      -0.725*          
#   (0.426)          
# 
# SiteRed River                     -0.466           
# (0.410)          
# 
# SiteSandy Bar                     -0.850           
# (0.534)          
# 
# Spine.Age:SiteMatheson            0.120**          
#   (0.058)          
# 
# Spine.Age:SiteRed River           0.126**          
#   (0.054)          
# 
# Spine.Age:SiteSandy Bar           0.150*           
#   (0.078)          
# 
# Constant                         3.008***          
#   (0.320)          
# 
# ---------------------------------------------------
#   Observations                        54             
# Log Likelihood                    -31.779          
# Akaike Inf. Crit.                 83.558           
# Bayesian Inf. Crit.               103.448          
# ===================================================
#   Note:                   *p<0.1; **p<0.05; ***p<0.01
anova(C16_28_model)
# Analysis of Variance Table
# npar  Sum Sq Mean Sq F value
# Spine.Age         1 0.93258 0.93258  7.3476
# Site              3 0.90229 0.30076  2.3697
# Spine.Age:Site    3 0.78553 0.26184  2.0630
Anova(C16_28_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C16_2)
# Chisq Df Pr(>Chisq)    
# (Intercept)    88.1254  1    < 2e-16 ***
#   Spine.Age       2.8671  1    0.09041 .  
# Site            3.7595  3    0.28863    
# Spine.Age:Site  6.1890  3    0.10277    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


confint(C16_28_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.000000000 0.115688038
# .sigma                   0.275350700 0.402112926
# (Intercept)              2.424576754 3.592099114
# Spine.Age               -0.169297531 0.007105293
# SiteMatheson            -1.499368116 0.049451792
# SiteRed River           -1.211019761 0.278031031
# SiteSandy Bar           -1.825257590 0.125362912
# Spine.Age:SiteMatheson   0.012780622 0.227246892
# Spine.Age:SiteRed River  0.026496948 0.224613499
# Spine.Age:SiteSandy Bar  0.006644689 0.292583328
syx <- summary(C16_28_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
# [1] 1.065518
plot(C16_28_model)
# Check model performance
check_model(C16_28_model) # collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(C16_28_model))
qqline(resid(C16_28_model))
report(C16_28_model)
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_2 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C16_2) ~ Spine.Age * Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.32) and the part related to the fixed effects alone
# (marginal R2) is of 0.31. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 3.01 (95% CI [2.36, 3.65],
#                                                     t(44) = 9.39, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.08, 95% CI [-0.18, 0.02], t(44) = -1.69, p = 0.097; Std. beta
#   = -2.07, 95% CI [-5.32, 1.19])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.72, 95% CI [-1.58, 0.13], t(44) = -1.70, p = 0.096;
#           Std. beta = -1.03, 95% CI [-6.72, 4.66])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.47, 95% CI [-1.29, 0.36], t(44) = -1.14, p = 0.261;
#           Std. beta = -0.64, 95% CI [-5.70, 4.42])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.85, 95% CI [-1.93, 0.23], t(44) = -1.59, p = 0.118;
#           Std. beta = -3.81, 95% CI [-8.80, 1.17])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and positive (beta = 0.12, 95% CI [2.66e-03, 0.24], t(44) = 2.06, p =
#                 0.045; Std. beta = 3.04, 95% CI [-2.49, 8.57])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.13, 95% CI [0.02, 0.23], t(44) = 2.33, p = 0.024;
#               Std. beta = 2.71, 95% CI [-0.68, 6.10])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.15, 95% CI [-6.84e-03, 0.31],
#                               t(44) = 1.93, p = 0.060; Std. beta = 6.69, 95% CI [1.89, 11.48])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  site site model
C16_29_model <- lmer(log(1000*C16_2) ~ Spine.Age+Site + (1 | Site), data = PCA_18W)
summary(C16_29_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C16_2) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 57.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.3747 -0.6738 -0.0686  0.4808  4.3182 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.03691  0.1921  
# Residual             0.13518  0.3677  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    2.31604    0.24275   9.541
# Spine.Age      0.02821    0.01801   1.567
# SiteMatheson   0.05154    0.30431   0.169
# SiteRed River  0.38067    0.30848   1.234
# SiteSandy Bar  0.11104    0.31286   0.355
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.470                     
# SiteMathesn -0.579 -0.091              
# SiteRedRivr -0.525 -0.187  0.506       
# SiteSandyBr -0.596 -0.019  0.484  0.479
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined

emmeans(C16_29_model, pairwise ~ Site, adjust = "tukey")

# 
# 
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   2.53 0.216 1146     2.11     2.96
# Matheson        2.58 0.214 1270     2.16     3.01
# Red River       2.91 0.217 1062     2.49     3.34
# Sandy Bar       2.64 0.229  567     2.20     3.09
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE   df t.ratio p.value
# Dauphin River - Matheson   -0.0515 0.304 1190  -0.169  0.9983
# Dauphin River - Red River  -0.3807 0.308  974  -1.234  0.6053
# Dauphin River - Sandy Bar  -0.1110 0.313  810  -0.355  0.9847
# Matheson - Red River       -0.3291 0.305 1177  -1.081  0.7014
# Matheson - Sandy Bar       -0.0595 0.314  789  -0.190  0.9976
# Red River - Sandy Bar       0.2696 0.317  695   0.850  0.8302
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
syx <- summary(C16_29_model)$sigma
( cf <- exp((syx^2)/2) ) # this is the bias correction factor
#[1] 1.069928
plot(C16_29_model)

# Check model performance
check_model(C16_29_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C16_29_model))
qqline(resid(C16_29_model))

Anova(C16_29_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C16_2)
# Chisq Df Pr(>Chisq)    
# (Intercept) 91.0244  1     <2e-16 ***
#   Spine.Age    2.4544  1     0.1172    
# Site         1.8128  3     0.6122    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C16_29_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_2 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C16_2) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.37) and the part related to the fixed effects alone
# (marginal R2) is of 0.20. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 2.32 (95% CI [1.83, 2.80],
#                                                     t(47) = 9.54, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-8.02e-03, 0.06], t(47) = 1.57, p = 0.124; Std.
#   beta = 0.45, 95% CI [-0.47, 1.37])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.05, 95% CI [-0.56, 0.66], t(47) = 0.17, p = 0.866;
#           Std. beta = -2.97, 95% CI [-9.70, 3.76])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.38, 95% CI [-0.24, 1.00], t(47) = 1.23, p = 0.223;
#           Std. beta = -2.72, 95% CI [-9.31, 3.88])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.11, 95% CI [-0.52, 0.74], t(47) = 0.35, p = 0.724;
#           Std. beta = -5.65, 95% CI [-12.29, 1.00])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

C16_23_model <- lmer(log(1000*C16_2) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C16_23_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C16_2) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 56.7
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.4621 -0.7800 -0.0986  0.6110  4.2327 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.01864  0.1365  
# Residual             0.13504  0.3675  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  2.39936    0.15778  15.207
# Spine.Age    0.03523    0.01739   2.026
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.842
C16_23_model_emm <- emmeans(C16_23_model, ~ Spine.Age)
C16_23_model_emm
# Spine.Age emmean     SE   df lower.CL upper.CL
# 7.7   2.67 0.0854 2.83     2.39     2.95
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C16_23_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(1000 * C16_2)     
# -----------------------------------------------
#   Spine.Age                     0.035**          
#   (0.017)          
# 
# Constant                     2.399***          
#   (0.158)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -28.329          
# Akaike Inf. Crit.             64.658           
# Bayesian Inf. Crit.           72.614           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

plot(C16_23_model)

# Check model perfomance
check_model(C16_23_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C16_23_model))
qqline(resid(C16_23_model))

Anova(C16_23_model,type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C16_2)
# Chisq Df Pr(>Chisq)    
# (Intercept) 231.2536  1    < 2e-16 ***
#   Spine.Age     4.1065  1    0.04272 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


report(C16_23_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_2 with Spine.Age (formula: log(1000 * C16_2) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is moderate (conditional R2 =
# 0.18) and the part related to the fixed effects alone (marginal R2) is of
# 0.07. The model's intercept, corresponding to Spine.Age = 0, is at 2.40
# (95% CI [2.08, 2.72], t(50) = 15.21, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.04, 95% CI [3.11e-04, 0.07], t(50) = 2.03, p = 0.048; Std. beta =
#                                                                          0.41, 95% CI [-0.48, 1.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.


#




#### C12DC ####


# retrying the models

C12DC_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y = C12DC)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C12DC_lm_plot



#test normality
(shapiro.test(PCA_18W$C12DC
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C12DC
# W = 0.85613, p-value = 1.188e-05
## logged
shapiro.test(log(C12DC))
# Shapiro-Wilk normality test
# 
# data:  log(C12DC)
# W = 0.97772, p-value = 0.4091




##  model no interaction site random metabolite log transformed
C12DC3_model <- lmer(log(C12DC) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C12DC3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C12DC) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 50
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7448 -0.5517 -0.1946  0.4958  3.6025 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.02098  0.1448  
# Residual             0.11757  0.3429  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept) -4.16306    0.15170 -27.443
# Spine.Age    0.01993    0.01631   1.222
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.821
C12DC3_model_emm <- emmeans(C12DC3_model, ~ Spine.Age)
C12DC3_model_emm
# Spine.Age emmean     SE   df lower.CL upper.CL
# 7.7  -4.01 0.0868 2.86    -4.29    -3.73
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C12DC3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(C12DC)         
# -----------------------------------------------
#   Spine.Age                      0.020           
# (0.016)          
# 
# Constant                     -4.163***         
#   (0.152)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -24.981          
# Akaike Inf. Crit.             57.962           
# Bayesian Inf. Crit.           65.918           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01


Anova(C12DC3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C12DC)
# Chisq Df Pr(>Chisq)    
# (Intercept) 753.1422  1     <2e-16 ***
#   Spine.Age     1.4923  1     0.2219    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(C12DC3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C12DC3_model))
qqline(resid(C12DC3_model))

report(C12DC3_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C12DC with Spine.Age (formula: log(C12DC) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is moderate (conditional R2 =
# 0.17) and the part related to the fixed effects alone (marginal R2) is of
# 0.03. The model's intercept, corresponding to Spine.Age = 0, is at -4.16
# (95% CI [-4.47, -3.86], t(50) = -27.44, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.01, 0.05], t(50) = 1.22, p = 0.228; Std. beta =
#     0.06, 95% CI [-0.04, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
C12DC9_model <- lmer(log(C12DC) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C12DC9_model)
# 
# 
# 
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C12DC) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 50.6
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7405 -0.5736 -0.1390  0.4493  3.7259 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.00199  0.0446  
# Residual             0.11771  0.3431  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)   -4.31349    0.14548 -29.650
# Spine.Age      0.01458    0.01680   0.868
# SiteMatheson   0.12223    0.14261   0.857
# SiteRed River  0.39977    0.15022   2.661
# SiteSandy Bar  0.25234    0.15791   1.598
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.732                     
# SiteMathesn -0.342 -0.181              
# SiteRedRivr -0.188 -0.358  0.524       
# SiteSandyBr -0.402 -0.035  0.443  0.427
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined
qqnorm(resid(C12DC9_model))
qqline(resid(C12DC9_model))

report(C12DC9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C12DC with Spine.Age and Site (formula: log(C12DC)
#                                                                                      ~ Spine.Age + Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is moderate (conditional
# R2 = 0.22) and the part related to the fixed effects alone (marginal R2)
# is of 0.21. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at -4.31 (95% CI [-4.61, -4.02], t(47) = -29.65,
#                                    p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.02, 0.05], t(47) = 0.87, p = 0.390; Std. beta =
#     0.05, 95% CI [-0.06, 0.15])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.12, 95% CI [-0.16, 0.41], t(47) = 0.86, p = 0.396;
#           Std. beta = 0.13, 95% CI [-0.45, 0.70])
# - The effect of Site [Red River] is statistically significant and
# positive (beta = 0.40, 95% CI [0.10, 0.70], t(47) = 2.66, p = 0.011; Std.
#           beta = 0.41, 95% CI [-0.18, 0.99])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.25, 95% CI [-0.07, 0.57], t(47) = 1.60, p = 0.117;
#           Std. beta = 0.26, 95% CI [-0.34, 0.85])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.


Anova(C12DC9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C12DC)
# Chisq Df Pr(>Chisq)    
# (Intercept) 879.1441  1    < 2e-16 ***
#   Spine.Age     0.7531  1    0.38550    
# Site          7.9966  3    0.04608 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

C12DC8_model <- lmer(log(C12DC) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C12DC8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C12DC) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 53.6
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.5887 -0.6337 -0.1526  0.4212  3.4766 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.003889 0.06236 
# Residual             0.102252 0.31977 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)             -3.52228    0.29125 -12.094
# Spine.Age               -0.11035    0.04299  -2.567
# SiteMatheson            -0.70048    0.38757  -1.807
# SiteRed River           -0.59998    0.37340  -1.607
# SiteSandy Bar           -0.89531    0.48347  -1.852
# Spine.Age:SiteMatheson   0.12893    0.05226   2.467
# Spine.Age:SiteRed River  0.14680    0.04828   3.041
# Spine.Age:SiteSandy Bar  0.17839    0.06968   2.560
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.935                                          
# SiteMathesn -0.751  0.702                                   
# SiteRedRivr -0.780  0.729  0.586                            
# SiteSandyBr -0.602  0.563  0.453  0.470                     
# Spn.Ag:StMt  0.769 -0.823 -0.921 -0.600 -0.463              
# Spn.Ag:StRR  0.832 -0.890 -0.625 -0.905 -0.501  0.732       
# Spn.Ag:StSB  0.577 -0.617 -0.433 -0.450 -0.943  0.507  0.549
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined
##  model
Anova(C12DC8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C12DC)
# Chisq Df Pr(>Chisq)    
# (Intercept)    146.2538  1    < 2e-16 ***
#   Spine.Age        6.5891  1    0.01026 *  
#   Site             4.7416  3    0.19172    
# Spine.Age:Site  10.4052  3    0.01542 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

emmeans(C12DC8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE df lower.CL upper.CL
# Dauphin River  -4.37 0.109  0     -Inf      Inf
# Matheson       -4.08 0.103  0     -Inf      Inf
# Red River      -3.84 0.116  0     -Inf      Inf
# Sandy Bar      -3.89 0.132  0     -Inf      Inf
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE df t.ratio p.value
# Dauphin River - Matheson    -0.293 0.151  0  -1.938     NaN
# Dauphin River - Red River   -0.531 0.158  0  -3.362     NaN
# Dauphin River - Sandy Bar   -0.479 0.173  0  -2.773     NaN
# Matheson - Red River        -0.238 0.148  0  -1.605     NaN
# Matheson - Sandy Bar        -0.186 0.168  0  -1.110     NaN
# Red River - Sandy Bar        0.052 0.171  0   0.304     NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 


plot(C12DC8_model)
# Check model performance
check_model(C12DC8_model)
# Plot the Q-Q plot for the residuals
qqnorm(resid(C12DC8_model))
qqline(resid(C12DC8_model))
Anova(C12DC8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C12DC)
# Chisq Df Pr(>Chisq)    
# (Intercept)    146.2538  1    < 2e-16 ***
#   Spine.Age        6.5891  1    0.01026 *  
#   Site             4.7416  3    0.19172    
# Spine.Age:Site  10.4052  3    0.01542 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C12DC8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C12DC with Spine.Age and Site (formula: log(C12DC)
#                                                                                      ~ Spine.Age * Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.35) and the part related to the fixed effects alone
# (marginal R2) is of 0.33. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at -3.52 (95% CI [-4.11,
#                                                              -2.94], t(44) = -12.09, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.11, 95% CI [-0.20, -0.02], t(44) = -2.57, p = 0.014; Std. beta =
#                                                                          -0.35, 95% CI [-0.62, -0.08])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.70, 95% CI [-1.48, 0.08], t(44) = -1.81, p = 0.078;
#           Std. beta = 0.30, 95% CI [-0.25, 0.85])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.60, 95% CI [-1.35, 0.15], t(44) = -1.61, p = 0.115;
#           Std. beta = 0.54, 95% CI [-0.02, 1.10])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.90, 95% CI [-1.87, 0.08], t(44) = -1.85, p = 0.071;
#           Std. beta = 0.49, 95% CI [-0.09, 1.07])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and positive (beta = 0.13, 95% CI [0.02, 0.23], t(44) = 2.47, p = 0.018;
#               Std. beta = 0.41, 95% CI [0.08, 0.74])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.15, 95% CI [0.05, 0.24], t(44) = 3.04, p = 0.004;
#               Std. beta = 0.46, 95% CI [0.16, 0.77])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# # and positive (beta = 0.18, 95% CI [0.04, 0.32], t(44) = 2.56, p = 0.014;
# #               Std. beta = 0.56, 95% CI [0.12, 1.00])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C12DC9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C12DC with Spine.Age and Site (formula: log(C12DC)
#                                                                                      ~ Spine.Age + Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is moderate (conditional
# R2 = 0.22) and the part related to the fixed effects alone (marginal R2)
# is of 0.21. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at -4.31 (95% CI [-4.61, -4.02], t(47) = -29.65,
#                                    p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.02, 0.05], t(47) = 0.87, p = 0.390; Std. beta =
#     0.05, 95% CI [-0.06, 0.15])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.12, 95% CI [-0.16, 0.41], t(47) = 0.86, p = 0.396;
#           Std. beta = 0.13, 95% CI [-0.45, 0.70])
# - The effect of Site [Red River] is statistically significant and
# positive (beta = 0.40, 95% CI [0.10, 0.70], t(47) = 2.66, p = 0.011; Std.
#           beta = 0.41, 95% CI [-0.18, 0.99])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.25, 95% CI [-0.07, 0.57], t(47) = 1.60, p = 0.117;
#           Std. beta = 0.26, 95% CI [-0.34, 0.85])
# 
# Standardized parameters were obtained by fitting the model on a
# # standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C12DC3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C12DC with Spine.Age (formula: log(C12DC) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is moderate (conditional R2 =
# 0.17) and the part related to the fixed effects alone (marginal R2) is of
# 0.03. The model's intercept, corresponding to Spine.Age = 0, is at -4.16
# (95% CI [-4.47, -3.86], t(50) = -27.44, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.01, 0.05], t(50) = 1.22, p = 0.228; Std. beta =
# #     0.06, 95% CI [-0.04, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(C12DC8_model,C12DC9_model,C12DC3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   C12DC3_model: log(C12DC) ~ Spine.Age + (1 | Site)
# C12DC9_model: log(C12DC) ~ Spine.Age + Site + (1 | Site)
# C12DC8_model: log(C12DC) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df Pr(>Chisq)  
# C12DC3_model    4 48.329 56.285 -20.164   40.329                        
# C12DC9_model    7 46.462 60.384 -16.231   32.462  7.8672  3    0.04884 *
#   C12DC8_model   10 41.450 61.340 -10.725   21.450 11.0117  3    0.01166 *
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1



#### C18_1 ####


# retrying the models

C18_1_lm_plot<- ggplot(data = PCA_18W, 
                       mapping = aes(x = Spine.Age, y = C18_1)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C18_1_lm_plot



#test normality
(shapiro.test(PCA_18W$C18_1
))

# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C18_1
# W = 0.63518, p-value = 2.492e-10
shapiro.test(log(C18_1))
# 
# Shapiro-Wilk normality test
# 
# data:  log(C18_1)
# W = 0.99118, p-value = 0.9603



##  model no interaction site random metabolite log transformed
C18_13_model <- lmer(log(1000*C18_1) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C18_13_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C18_1) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 122.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.8509 -0.5607 -0.0326  0.5951  4.1436 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1785   0.4225  
# Residual             0.4579   0.6767  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  4.80513    0.33947   14.15
# Spine.Age    0.02185    0.03262    0.67
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.732
C18_13_model_emm <- emmeans(C18_13_model, ~ Spine.Age)
C18_13_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   4.97 0.231 2.93     4.23     5.72
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C18_13_model, type = "text")
# 
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(1000 * C18_1)     
# -----------------------------------------------
#   Spine.Age                      0.022           
# (0.033)          
# 
# Constant                     4.805***          
#   (0.339)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -61.222          
# Akaike Inf. Crit.             130.443          
# Bayesian Inf. Crit.           138.399          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(C18_13_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C18_1)
# Chisq Df Pr(>Chisq)    
# (Intercept) 200.3555  1     <2e-16 ***
#   Spine.Age     0.4485  1      0.503    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(C18_13_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C18_13_model))
qqline(resid(C18_13_model))

report(C18_13_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C18_1 with Spine.Age (formula: log(1000 * C18_1) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is substantial (conditional R2
# = 0.29) and the part related to the fixed effects alone (marginal R2) is
# of 7.10e-03. The model's intercept, corresponding to Spine.Age = 0, is at
# 4.81 (95% CI [4.12, 5.49], t(50) = 14.15, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.09], t(50) = 0.67, p = 0.506; Std. beta =
#     -0.25, 95% CI [-1.01, 0.50])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
C18_19_model <- lmer(log(1000*C18_1) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C18_19_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C18_1) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 117.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7015 -0.6085 -0.0597  0.5674  4.2527 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2930   0.5413  
# Residual             0.4582   0.6769  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    4.26931    0.60630   7.042
# Spine.Age      0.01316    0.03315   0.397
# SiteMatheson   0.61895    0.80597   0.768
# SiteRed River  1.12016    0.81134   1.381
# SiteSandy Bar  0.67543    0.81700   0.827
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.346                     
# SiteMathesn -0.640 -0.063              
# SiteRedRivr -0.612 -0.131  0.503       
# SiteSandyBr -0.648 -0.014  0.492  0.490


qqnorm(resid(C18_19_model))
qqline(resid(C18_19_model))

report(C18_19_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C18_1 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C18_1) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.52) and the part related to the fixed effects alone
# (marginal R2) is of 0.21. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 4.27 (95% CI [3.05, 5.49],
#                                                     t(47) = 7.04, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.05, 0.08], t(47) = 0.40, p = 0.693; Std. beta =
#     -0.26, 95% CI [-1.07, 0.55])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.62, 95% CI [-1.00, 2.24], t(47) = 0.77, p = 0.446;
#           Std. beta = -2.45, 95% CI [-7.24, 2.35])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 1.12, 95% CI [-0.51, 2.75], t(47) = 1.38, p = 0.174;
#           Std. beta = -2.02, 95% CI [-6.83, 2.80])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.68, 95% CI [-0.97, 2.32], t(47) = 0.83, p = 0.413;
#           Std. beta = -4.22, 95% CI [-9.04, 0.61])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(C18_19_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C18_1)
# Chisq Df Pr(>Chisq)    
# (Intercept) 49.5842  1    1.9e-12 ***
#   Spine.Age    0.1576  1     0.6914    
# Site         1.9369  3     0.5856    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

C18_18_model <- lmer(log(1000*C18_1) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C18_18_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C18_1) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 114.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.5511 -0.7005 -0.0119  0.4369  4.0610 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 1.0869   1.0425  
# Residual             0.3835   0.6193  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              5.99675    1.17919   5.085
# Spine.Age               -0.25959    0.08325  -3.118
# SiteMatheson            -1.49876    1.64561  -0.911
# SiteRed River           -1.02504    1.63327  -0.628
# SiteSandy Bar           -1.06611    1.73820  -0.613
# Spine.Age:SiteMatheson   0.32236    0.10122   3.185
# Spine.Age:SiteRed River  0.31658    0.09350   3.386
# Spine.Age:SiteSandy Bar  0.27487    0.13495   2.037
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.447                                          
# SiteMathesn -0.717  0.320                                   
# SiteRedRivr -0.722  0.323  0.517                            
# SiteSandyBr -0.678  0.303  0.486  0.490                     
# Spn.Ag:StMt  0.368 -0.823 -0.420 -0.266 -0.250              
# Spn.Ag:StRR  0.398 -0.890 -0.285 -0.401 -0.270  0.732       
# Spn.Ag:StSB  0.276 -0.617 -0.198 -0.199 -0.508  0.507  0.549

emmeans(C18_18_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean   SE    df lower.CL upper.CL
# Dauphin River   4.00 1.06 39140     1.92     6.08
# Matheson        4.98 1.05 86501     2.91     7.05
# Red River       5.41 1.06 57519     3.34     7.48
# Sandy Bar       5.05 1.07 20005     2.95     7.14
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate   SE    df t.ratio p.value
# Dauphin River - Matheson   -0.9846 1.50 55832  -0.658  0.9127
# Dauphin River - Red River  -1.4138 1.50 46983  -0.944  0.7812
# Dauphin River - Sandy Bar  -1.0514 1.51 27145  -0.698  0.8978
# Matheson - Red River       -0.4291 1.49 69770  -0.287  0.9917
# Matheson - Sandy Bar       -0.0668 1.50 36160  -0.044  1.0000
# Red River - Sandy Bar       0.3624 1.50 31496   0.241  0.9951
confint(C18_18_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                   0.00000000  0.2039429
# .sigma                   0.47864229  0.6989931
# (Intercept)              4.98204577  7.0114449
# Spine.Age               -0.41291294 -0.1062718
# SiteMatheson            -2.84481173 -0.1527104
# SiteRed River           -2.31912983  0.2690408
# SiteSandy Bar           -2.76152847  0.6293084
# Spine.Age:SiteMatheson   0.13596126  0.5087681
# Spine.Age:SiteRed River  0.14438224  0.4887684
# Spine.Age:SiteSandy Bar  0.02634483  0.5233921

plot(C18_18_model)
# Check model performance
check_model(C18_18_model)
# Plot the Q-Q plot for the residuals
qqnorm(resid(C18_18_model))
qqline(resid(C18_18_model))
Anova(C18_18_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C18_1)
# Chisq Df Pr(>Chisq)    
# (Intercept)    25.8622  1  3.667e-07 ***
#   Spine.Age       9.7226  1   0.001820 ** 
#   Site            0.8838  3   0.829339    
# Spine.Age:Site 12.5367  3   0.005754 ** 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C18_18_model)
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C18_1 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C18_1) ~ Spine.Age * Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.78) and the part related to the fixed effects alone
# (marginal R2) is of 0.16. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 6.00 (95% CI [3.62, 8.37],
#                                                     t(44) = 5.09, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.26, 95% CI [-0.43, -0.09], t(44) = -3.12, p = 0.003; Std. beta =
#                                                                          -3.76, 95% CI [-6.00, -1.51])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.50, 95% CI [-4.82, 1.82], t(44) = -0.91, p = 0.367;
#           Std. beta = 0.62, 95% CI [-3.60, 4.84])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.03, 95% CI [-4.32, 2.27], t(44) = -0.63, p = 0.534;
#           Std. beta = 0.75, 95% CI [-3.31, 4.81])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.07, 95% CI [-4.57, 2.44], t(44) = -0.61, p = 0.543;
#           Std. beta = -2.71, 95% CI [-6.51, 1.10])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and positive (beta = 0.32, 95% CI [0.12, 0.53], t(44) = 3.18, p = 0.003;
#               Std. beta = 3.48, 95% CI [0.05, 6.91])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.32, 95% CI [0.13, 0.51], t(44) = 3.39, p = 0.002;
#               Std. beta = 3.81, 95% CI [1.47, 6.15])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.27, 95% CI [2.90e-03, 0.55], t(44) = 2.04, p =
#                 0.048; Std. beta = 5.38, 95% CI [1.84, 8.91])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C18_19_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C18_1 with Spine.Age and Site (formula: log(1000 *
#                                                                                                     C18_1) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.52) and the part related to the fixed effects alone
# (marginal R2) is of 0.21. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 4.27 (95% CI [3.05, 5.49],
#                                                     t(47) = 7.04, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.05, 0.08], t(47) = 0.40, p = 0.693; Std. beta =
#     -0.26, 95% CI [-1.07, 0.55])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.62, 95% CI [-1.00, 2.24], t(47) = 0.77, p = 0.446;
#           Std. beta = -2.45, 95% CI [-7.24, 2.35])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 1.12, 95% CI [-0.51, 2.75], t(47) = 1.38, p = 0.174;
#           Std. beta = -2.02, 95% CI [-6.83, 2.80])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.68, 95% CI [-0.97, 2.32], t(47) = 0.83, p = 0.413;
#           Std. beta = -4.22, 95% CI [-9.04, 0.61])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C18_13_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C18_1 with Spine.Age (formula: log(1000 * C18_1) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is substantial (conditional R2
# = 0.29) and the part related to the fixed effects alone (marginal R2) is
# of 7.10e-03. The model's intercept, corresponding to Spine.Age = 0, is at
# 4.81 (95% CI [4.12, 5.49], t(50) = 14.15, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.09], t(50) = 0.67, p = 0.506; Std. beta =
#     -0.25, 95% CI [-1.01, 0.50])
# # 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(C18_18_model,C18_19_model,C18_13_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   C18_13_model: log(1000 * C18_1) ~ Spine.Age + (1 | Site)
# C18_19_model: log(1000 * C18_1) ~ Spine.Age + Site + (1 | Site)
# C18_18_model: log(1000 * C18_1) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)   
# C18_13_model    4 124.17 132.13 -58.086  116.171                        
# C18_19_model    7 119.85 133.77 -52.925  105.850 10.321  3   0.016023 * 
#   C18_18_model   10 112.83 132.72 -46.418   92.835 13.015  3   0.004605 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### C14_2OH ####


C14_2OH_lm_plot<- ggplot(data = PCA_18W, 
                          mapping = aes(x = Spine.Age, y = C14_2OH)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C14_2OH_lm_plot



#test normality
(shapiro.test(PCA_18W$C14_2OH
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C14_2OH
# W = 0.67553, p-value = 1.197e-09
shapiro.test(log(C14_2OH))
# 
# Shapiro-Wilk normality test
# 
# data:  log(C14_2OH)
# W = 0.97297, p-value = 0.2596



##  model no interaction site random metabolite log transformed
C14_2OH3_model <- lmer(log(1000*C14_2OH) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C14_2OH3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C14_2OH) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 89.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.6586 -0.6129 -0.1814  0.4491  4.3552 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.05661  0.2379  
# Residual             0.24915  0.4992  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  2.80296    0.22820  12.283
# Spine.Age    0.03512    0.02386   1.472
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.798
C14_2OH3_model_emm <- emmeans(C14_2OH3_model, ~ Spine.Age)
C14_2OH3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   3.07 0.138 2.88     2.62     3.52
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C14_2OH3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(1000 * C14_2OH)    
# -----------------------------------------------
#   Spine.Age                      0.035           
# (0.024)          
# 
# Constant                     2.803***          
#   (0.228)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -44.764          
# Akaike Inf. Crit.             97.529           
# Bayesian Inf. Crit.           105.485          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01
Anova(C14_2OH3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C14_2OH)
# Chisq Df Pr(>Chisq)    
# (Intercept) 150.8702  1     <2e-16 ***
#   Spine.Age     2.1669  1      0.141    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(C14_2OH3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C14_2OH3_model))
qqline(resid(C14_2OH3_model))

report(C14_2OH3_model)
# boundary (singular) fit: see help('isSingular')
# boundary (singular) fit: see help('isSingular')
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C14_2OH with Spine.Age (formula: log(1000 *
#                                                                                              C14_2OH) ~ Spine.Age). The model included Site as random effect (formula:
#                                                                                                                                                                 ~1 | Site). The model's total explanatory power is moderate (conditional
# R2 = 0.22) and the part related to the fixed effects alone (marginal R2)
# is of 0.04. The model's intercept, corresponding to Spine.Age = 0, is at
# 2.80 (95% CI [2.34, 3.26], t(50) = 12.28, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.04, 95% CI [-0.01, 0.08], t(50) = 1.47, p = 0.147; Std. beta =
#     0.02, 95% CI [-0.48, 0.51])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
C14_2OH9_model <- lmer(log(1000*C14_2OH) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C14_2OH9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C14_2OH) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 87.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.4762 -0.6184 -0.1784  0.3569  4.4915 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2518   0.5018  
# Residual             0.2494   0.4994  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    2.50201    0.54074   4.627
# Spine.Age      0.02788    0.02446   1.140
# SiteMatheson   0.32961    0.73363   0.449
# SiteRed River  0.65068    0.73684   0.883
# SiteSandy Bar  0.45775    0.74024   0.618
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.286                     
# SiteMathesn -0.662 -0.051              
# SiteRedRivr -0.643 -0.106  0.502       
# SiteSandyBr -0.667 -0.011  0.495  0.493


qqnorm(resid(C14_2OH9_model))
qqline(resid(C14_2OH9_model))

report(C14_2OH9_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C14_2OH with Spine.Age and Site (formula: log(1000
#                                                                                                     * C14_2OH) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.57) and the part related to the fixed effects alone
# (marginal R2) is of 0.14. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 2.50 (95% CI [1.41, 3.59],
#                                                     t(47) = 4.63, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.02, 0.08], t(47) = 1.14, p = 0.260; Std. beta =
#     0.21, 95% CI [-0.28, 0.70])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.33, 95% CI [-1.15, 1.81], t(47) = 0.45, p = 0.655;
#           Std. beta = -2.96, 95% CI [-6.06, 0.13])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.65, 95% CI [-0.83, 2.13], t(47) = 0.88, p = 0.382;
#           Std. beta = -2.87, 95% CI [-5.94, 0.21])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.46, 95% CI [-1.03, 1.95], t(47) = 0.62, p = 0.539;
#           Std. beta = -2.75, 95% CI [-5.91, 0.40])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
Anova(C14_2OH9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C14_2OH)
# Chisq Df Pr(>Chisq)    
# (Intercept) 21.4089  1   3.71e-06 ***
#   Spine.Age    1.2992  1     0.2544    
# Site         0.8283  3     0.8427    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

C14_2OH8_model <- lmer(log(1000*C14_2OH) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C14_2OH8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(1000 * C14_2OH) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 91.9
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.5386 -0.6826 -0.0538  0.4859  4.2189 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2378   0.4876  
# Residual             0.2352   0.4850  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              3.43634    0.65113   5.277
# Spine.Age               -0.11964    0.06520  -1.835
# SiteMatheson            -0.75235    0.89622  -0.839
# SiteRed River           -0.53674    0.88227  -0.608
# SiteSandy Bar           -0.54907    0.99769  -0.550
# Spine.Age:SiteMatheson   0.16629    0.07927   2.098
# Spine.Age:SiteRed River  0.17407    0.07323   2.377
# Spine.Age:SiteSandy Bar  0.15840    0.10569   1.499
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.634                                          
# SiteMathesn -0.727  0.461                                   
# SiteRedRivr -0.738  0.468  0.536                            
# SiteSandyBr -0.653  0.414  0.474  0.482                     
# Spn.Ag:StMt  0.522 -0.823 -0.604 -0.385 -0.340              
# Spn.Ag:StRR  0.565 -0.890 -0.410 -0.581 -0.369  0.732       
# Spn.Ag:StSB  0.391 -0.617 -0.284 -0.289 -0.693  0.507  0.549

emmeans(C14_2OH8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
#  Site          emmean    SE    df lower.CL upper.CL
#  Dauphin River   2.51 0.511  5613     1.51     3.52
#  Matheson        3.04 0.503 11937     2.06     4.03
#  Red River       3.32 0.507  8082     2.32     4.31
#  Sandy Bar       3.19 0.521  3004     2.16     4.21
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
#  contrast                  estimate    SE   df t.ratio p.value
#  Dauphin River - Matheson    -0.529 0.718 7856  -0.737  0.8823
#  Dauphin River - Red River   -0.804 0.720 6670  -1.117  0.6792
#  Dauphin River - Sandy Bar   -0.671 0.730 3985  -0.920  0.7944
#  Matheson - Red River        -0.276 0.715 9716  -0.386  0.9805
#  Matheson - Sandy Bar        -0.142 0.724 5210  -0.197  0.9973
#  Red River - Sandy Bar        0.133 0.727 4578   0.183  0.9978
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(C14_2OH8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000 0.157496874
# .sigma                   0.37486056 0.547433784
# (Intercept)              2.64160660 4.231063551
# Spine.Age               -0.23972080 0.000432801
# SiteMatheson            -1.80662697 0.301925845
# SiteRed River           -1.55032929 0.476854258
# SiteSandy Bar           -1.87685530 0.778706098
# Spine.Age:SiteMatheson   0.02030622 0.312279133
# Spine.Age:SiteRed River  0.03921598 0.308930496
# Spine.Age:SiteSandy Bar -0.03623821 0.353036692
plot(C14_2OH8_model)
# Check model performance
check_model(C14_2OH8_model) # some collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(C14_2OH8_model))
qqline(resid(C14_2OH8_model))
Anova(C14_2OH8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(1000 * C14_2OH)
# Chisq Df Pr(>Chisq)    
# (Intercept)    27.8518  1   1.31e-07 ***
#   Spine.Age       3.3671  1    0.06651 .  
# Site            0.7546  3    0.86029    
# Spine.Age:Site  5.9441  3    0.11436    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C14_2OH8_model)
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# fixed-effect model matrix is rank deficient so dropping 1 column / coefficient
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C14_2OH with Spine.Age and Site (formula: log(1000
#                                                                                                     * C14_2OH) ~ Spine.Age * Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.60) and the part related to the fixed effects alone
# (marginal R2) is of 0.19. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 3.44 (95% CI [2.12, 4.75],
#                                                     t(44) = 5.28, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.12, 95% CI [-0.25, 0.01], t(44) = -1.83, p = 0.073; Std. beta
#   = -0.61, 95% CI [-2.38, 1.16])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.75, 95% CI [-2.56, 1.05], t(44) = -0.84, p = 0.406;
#           Std. beta = -2.03, 95% CI [-5.68, 1.62])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.54, 95% CI [-2.31, 1.24], t(44) = -0.61, p = 0.546;
#           Std. beta = -2.24, 95% CI [-5.72, 1.24])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.55, 95% CI [-2.56, 1.46], t(44) = -0.55, p = 0.585;
#           Std. beta = -1.96, 95% CI [-5.64, 1.72])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and positive (beta = 0.17, 95% CI [6.53e-03, 0.33], t(44) = 2.10, p =
#                 0.042; Std. beta = 0.30, 95% CI [-2.64, 3.24])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.17, 95% CI [0.03, 0.32], t(44) = 2.38, p = 0.022;
#               Std. beta = 0.93, 95% CI [-0.93, 2.78])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.16, 95% CI [-0.05, 0.37], t(44) =
#                                 1.50, p = 0.141; Std. beta = 8.07, 95% CI [5.04, 11.11])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C14_2OH9_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C14_2OH with Spine.Age and Site (formula: log(1000
#                                                                                                     * C14_2OH) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.57) and the part related to the fixed effects alone
# (marginal R2) is of 0.14. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 2.50 (95% CI [1.41, 3.59],
#                                                     t(47) = 4.63, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.02, 0.08], t(47) = 1.14, p = 0.260; Std. beta =
#     0.21, 95% CI [-0.28, 0.70])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.33, 95% CI [-1.15, 1.81], t(47) = 0.45, p = 0.655;
#           Std. beta = -2.96, 95% CI [-6.06, 0.13])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.65, 95% CI [-0.83, 2.13], t(47) = 0.88, p = 0.382;
#           Std. beta = -2.87, 95% CI [-5.94, 0.21])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.46, 95% CI [-1.03, 1.95], t(47) = 0.62, p = 0.539;
#           Std. beta = -2.75, 95% CI [-5.91, 0.40])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C14_2OH3_model)
# boundary (singular) fit: see help('isSingular')
# boundary (singular) fit: see help('isSingular')
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C14_2OH with Spine.Age (formula: log(1000 *
#                                                                                              C14_2OH) ~ Spine.Age). The model included Site as random effect (formula:
#                                                                                                                                                                 ~1 | Site). The model's total explanatory power is moderate (conditional
# R2 = 0.22) and the part related to the fixed effects alone (marginal R2)
# is of 0.04. The model's intercept, corresponding to Spine.Age = 0, is at
# 2.80 (95% CI [2.34, 3.26], t(50) = 12.28, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# # (beta = 0.04, 95% CI [-0.01, 0.08], t(50) = 1.47, p = 0.147; Std. beta =
#     0.02, 95% CI [-0.48, 0.51])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(C14_2OH8_model, C14_2OH9_model, C14_2OH3_model)
# Data: PCA_18W
# Models:
#   C14_2OH3_model: log(1000 * C14_2OH) ~ Spine.Age + (1 | Site)
# C14_2OH9_model: log(1000 * C14_2OH) ~ Spine.Age + Site + (1 | Site)
# C14_2OH8_model: log(1000 * C14_2OH) ~ Spine.Age * Site + (1 | Site)
# npar    AIC     BIC  logLik deviance  Chisq Df Pr(>Chisq)
# C14_2OH3_model    4 89.587  97.542 -40.793   81.587                     
# C14_2OH9_model    7 87.003 100.926 -36.501   73.003 8.5839  3    0.03537
# C14_2OH8_model   10 86.440 106.330 -33.220   66.440 6.5624  3    0.08723
# 
# C14_2OH3_model  
# C14_2OH9_model *
#   C14_2OH8_model .
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### C16_1 ####


# retrying the models

C16_1_lm_plot<- ggplot(data = PCA_18W, 
                       mapping = aes(x = Spine.Age, y = C16_1)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C16_1_lm_plot



#test normality
(shapiro.test(PCA_18W$C16_1
))
# 
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C16_1
# W = 0.62368, p-value = 1.628e-10
shapiro.test(log(C16_1))
# Shapiro-Wilk normality test
# 
# data:  log(C16_1)
# W = 0.98201, p-value = 0.5901



##  model no interaction si6e random metabolite log transformed
C16_13_model <- lmer(log(C16_1) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C16_13_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C16_1) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 113.8
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.9523 -0.6609 -0.0848  0.5004  4.2973 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1398   0.3739  
# Residual             0.3896   0.6241  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept) -2.33494    0.30809  -7.579
# Spine.Age    0.02934    0.03005   0.976
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.743
C16_13_model_emm <- emmeans(C16_13_model, ~ Spine.Age)
C16_13_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7  -2.11 0.206 2.92    -2.78    -1.44
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C16_13_model, type = "text")

# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(C16_1)         
# -----------------------------------------------
#   Spine.Age                      0.029           
# (0.030)          
# 
# Constant                     -2.335***         
#   (0.308)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -56.917          
# Akaike Inf. Crit.             121.834          
# Bayesian Inf. Crit.           129.790          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(C16_13_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C16_1)
# Chisq Df Pr(>Chisq)    
# (Intercept) 57.4360  1  3.492e-14 ***
#   Spine.Age    0.9534  1     0.3289    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(C16_13_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C16_13_model))
qqline(resid(C16_13_model))

report(C16_13_model)
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_1 with Spine.Age (formula: log(C16_1) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is substantial (conditional R2
# = 0.28) and the part related to the fixed effects alone (marginal R2) is
# of 0.02. The model's intercept, corresponding to Spine.Age = 0, is at
# -2.33 (95% CI [-2.95, -1.72], t(50) = -7.58, p < .001). Within this
# model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.03, 0.09], t(50) = 0.98, p = 0.334; Std. beta =
# #     0.07, 95% CI [-0.03, 0.17])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
C16_19_model <- lmer(log(C16_1) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C16_19_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C16_1) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 109.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.8092 -0.6094 -0.0761  0.4583  4.3997 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1748   0.4181  
# Residual             0.3898   0.6243  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)   -2.76624    0.48818  -5.666
# Spine.Age      0.02128    0.03058   0.696
# SiteMatheson   0.40508    0.63546   0.637
# SiteRed River  0.98844    0.64124   1.541
# SiteSandy Bar  0.58633    0.64733   0.906
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.397                     
# SiteMathesn -0.618 -0.074              
# SiteRedRivr -0.581 -0.153  0.504       
# SiteSandyBr -0.629 -0.016  0.489  0.486


qqnorm(resid(C16_19_model))
qqline(resid(C16_19_model))

report(C16_19_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_1 with Spine.Age and Site (formula: log(C16_1)
#                                                                                      ~ Spine.Age + Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.47) and the part related to the fixed effects alone
# (marginal R2) is of 0.23. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at -2.77 (95% CI [-3.75,
#                                                              -1.78], t(47) = -5.67, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(47) = 0.70, p = 0.490; Std. beta =
#     0.05, 95% CI [-0.06, 0.15])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.41, 95% CI [-0.87, 1.68], t(47) = 0.64, p = 0.527;
#           Std. beta = 0.10, 95% CI [-0.47, 0.67])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.99, 95% CI [-0.30, 2.28], t(47) = 1.54, p = 0.130;
#           Std. beta = 0.40, 95% CI [-0.18, 0.98])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.59, 95% CI [-0.72, 1.89], t(47) = 0.91, p = 0.370;
#           Std. beta = 0.18, 95% CI [-0.41, 0.77])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(C16_19_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C16_1)
# Chisq Df Pr(>Chisq)    
# (Intercept) 32.1090  1  1.458e-08 ***
#   Spine.Age    0.4842  1     0.4865    
# Site         2.4619  3     0.4822    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

C16_18_model <- lmer(log(C16_1) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C16_18_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C16_1) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 108.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.3455 -0.6589 -0.0381  0.4954  4.1874 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1488   0.3857  
# Residual             0.3370   0.5805  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)             -1.26510    0.64463  -1.963
# Spine.Age               -0.21574    0.07804  -2.764
# SiteMatheson            -1.38469    0.87579  -1.581
# SiteRed River           -0.82842    0.85525  -0.969
# SiteSandy Bar           -1.27893    1.02094  -1.253
# Spine.Age:SiteMatheson   0.27371    0.09488   2.885
# Spine.Age:SiteRed River  0.27014    0.08765   3.082
# Spine.Age:SiteSandy Bar  0.29164    0.12650   2.305
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.767                                          
# SiteMathesn -0.736  0.564                                   
# SiteRedRivr -0.754  0.578  0.555                            
# SiteSandyBr -0.631  0.484  0.465  0.476                     
# Spn.Ag:StMt  0.631 -0.823 -0.740 -0.475 -0.398              
# Spn.Ag:StRR  0.683 -0.890 -0.503 -0.717 -0.431  0.732       
# Spn.Ag:StSB  0.473 -0.617 -0.348 -0.357 -0.810  0.507  0.549

emmeans(C16_18_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River  -2.93 0.427 1336    -3.77    -2.09
# Matheson       -2.20 0.414 2657    -3.01    -1.39
# Red River      -1.67 0.420 1857    -2.50    -0.85
# Sandy Bar      -1.96 0.444  771    -2.83    -1.09
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE   df t.ratio p.value
# Dauphin River - Matheson    -0.724 0.595 1809  -1.217  0.6163
# Dauphin River - Red River   -1.253 0.599 1560  -2.090  0.1568
# Dauphin River - Sandy Bar   -0.968 0.616  985  -1.571  0.3958
# Matheson - Red River        -0.529 0.590 2197  -0.896  0.8067
# Matheson - Sandy Bar        -0.244 0.607 1250  -0.402  0.9780
# Red River - Sandy Bar        0.285 0.611 1114   0.466  0.9664
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(C16_18_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.18851297
# .sigma                   0.44867995  0.65523714
# (Intercept)             -2.21632930 -0.31386866
# Spine.Age               -0.35946467 -0.07201884
# SiteMatheson            -2.64657686 -0.12279743
# SiteRed River           -2.04161324  0.38477328
# SiteSandy Bar           -2.86818789  0.31031974
# Spine.Age:SiteMatheson   0.09897672  0.44844638
# Spine.Age:SiteRed River  0.10872616  0.43155419
# Spine.Age:SiteSandy Bar  0.05867468  0.52460752

plot(C16_18_model)
# Check model performance
check_model(C16_18_model) # some collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(C16_18_model))
qqline(resid(C16_18_model))
Anova(C16_18_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C16_1)
# Chisq Df Pr(>Chisq)   
# (Intercept)     3.8515  1   0.049702 * 
#   Spine.Age       7.6421  1   0.005702 **
#   Site            2.8463  3   0.415937   
# Spine.Age:Site 10.6764  3   0.013611 * 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C16_18_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_1 with Spine.Age and Site (formula: log(C16_1)
#                                                                                      ~ Spine.Age * Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.53) and the part related to the fixed effects alone
# (marginal R2) is of 0.32. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at -1.27 (95% CI [-2.56,
#                                                              0.03], t(44) = -1.96, p = 0.056). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.22, 95% CI [-0.37, -0.06], t(44) = -2.76, p = 0.008; Std. beta =
#                                                                          -0.27, 95% CI [-0.55, 8.47e-03])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.38, 95% CI [-3.15, 0.38], t(44) = -1.58, p = 0.121;
#           Std. beta = 0.24, 95% CI [-1.03, 1.51])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.83, 95% CI [-2.55, 0.90], t(44) = -0.97, p = 0.338;
#           Std. beta = 0.51, 95% CI [-0.77, 1.78])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.28, 95% CI [-3.34, 0.78], t(44) = -1.25, p = 0.217;
#           Std. beta = 0.34, 95% CI [-0.95, 1.62])
# - The effect of Spine Age × Site [Matheson] is statistically significant
# and positive (beta = 0.27, 95% CI [0.08, 0.46], t(44) = 2.88, p = 0.006;
#               Std. beta = 0.35, 95% CI [0.02, 0.69])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.27, 95% CI [0.09, 0.45], t(44) = 3.08, p = 0.004;
#               Std. beta = 0.37, 95% CI [0.06, 0.68])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.29, 95% CI [0.04, 0.55], t(44) = 2.31, p = 0.026;
#               Std. beta = 0.37, 95% CI [-0.08, 0.82])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C16_19_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_1 with Spine.Age and Site (formula: log(C16_1)
#                                                                                      ~ Spine.Age + Site). The model included Site as random effect (formula:
#                                                                                                                                                       ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.47) and the part related to the fixed effects alone
# (marginal R2) is of 0.23. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at -2.77 (95% CI [-3.75,
#                                                              -1.78], t(47) = -5.67, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(47) = 0.70, p = 0.490; Std. beta =
#     0.05, 95% CI [-0.06, 0.15])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.41, 95% CI [-0.87, 1.68], t(47) = 0.64, p = 0.527;
#           Std. beta = 0.10, 95% CI [-0.47, 0.67])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.99, 95% CI [-0.30, 2.28], t(47) = 1.54, p = 0.130;
#           Std. beta = 0.40, 95% CI [-0.18, 0.98])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.59, 95% CI [-0.72, 1.89], t(47) = 0.91, p = 0.370;
#           Std. beta = 0.18, 95% CI [-0.41, 0.77])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C16_13_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C16_1 with Spine.Age (formula: log(C16_1) ~
#                                                                               Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                       Site). The model's total explanatory power is substantial (conditional R2
# = 0.28) and the part related to the fixed effects alone (marginal R2) is
# of 0.02. The model's intercept, corresponding to Spine.Age = 0, is at
# -2.33 (95% CI [-2.95, -1.72], t(50) = -7.58, p < .001). Within this
# model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.03, 0.09], t(50) = 0.98, p = 0.334; Std. beta =
#     0.07, 95% CI [-0.03, 0.17])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(C16_18_model,C16_19_model,C16_13_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   C16_13_model: log(C16_1) ~ Spine.Age + (1 | Site)
# C16_19_model: log(C16_1) ~ Spine.Age + Site + (1 | Site)
# C16_18_model: log(C16_1) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)  
# C16_13_model    4 115.17 123.12 -53.584  107.167                       
# C16_19_model    7 111.12 125.05 -48.562   97.125 10.043  3    0.01821 *
#   C16_18_model   10 105.85 125.74 -42.927   85.854 11.271  3    0.01035 *
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### C5 ####


# retrying the models

C5_lm_plot<- ggplot(data = PCA_18W, 
                       mapping = aes(x = Spine.Age, y = C5)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
C5_lm_plot



#test normality
(shapiro.test(PCA_18W$C5
))
# 
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$C5
# W = 0.71033, p-value = 5.157e-09
shapiro.test(log(C5))
# Shapiro-Wilk normality test
# 
# data:  log(C5)
# W = 0.98611, p-value = 0.783


##  model no interaction si6e random metabolite log transformed
C53_model <- lmer(log(C5) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(C53_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C5) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 111.1
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.20138 -0.53640  0.00004  0.71289  2.17707 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.5411   0.7356  
# Residual             0.3425   0.5852  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept) -2.02266    0.43479  -4.652
# Spine.Age    0.01962    0.02854   0.688
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.499
C53_model_emm <- emmeans(C53_model, ~ Spine.Age)
C53_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7  -1.87 0.377 2.98    -3.07   -0.668
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(C53_model, type = "text")
# ==============================================
#   Dependent variable:    
#   ---------------------------
#   log(C5)          
# -----------------------------------------------
#   Spine.Age                      0.020           
# (0.029)          
# 
# Constant                     -2.023***         
#   (0.435)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -55.560          
# Akaike Inf. Crit.             119.120          
# Bayesian Inf. Crit.           127.076          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(C53_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C5)
# Chisq Df Pr(>Chisq)    
# (Intercept) 21.6417  1  3.286e-06 ***
#   Spine.Age    0.4729  1     0.4917    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(C53_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(C53_model))
qqline(resid(C53_model))

report(C53_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C5 with Spine.Age (formula: log(C5) ~ Spine.Age).
# The model included Site as random effect (formula: ~1 | Site). The
# model's total explanatory power is substantial (conditional R2 = 0.61)
# and the part related to the fixed effects alone (marginal R2) is of
# 4.14e-03. The model's intercept, corresponding to Spine.Age = 0, is at
# -2.02 (95% CI [-2.90, -1.15], t(50) = -4.65, p < .001). Within this
# model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(50) = 0.69, p = 0.495; Std. beta =
#     -9.24e-03, 95% CI [-0.09, 0.08])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
C59_model <- lmer(log(C5) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(C59_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C5) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 102.9
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.28467 -0.59153 -0.00247  0.72086  2.11208 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 1.3377   1.1566  
# Residual             0.3426   0.5853  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)   -1.01288    1.18046  -0.858
# Spine.Age      0.02234    0.02867   0.779
# SiteMatheson  -0.94979    1.65015  -0.576
# SiteRed River -1.60019    1.65211  -0.969
# SiteSandy Bar -1.58633    1.65420  -0.959
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.154                     
# SiteMathesn -0.694 -0.027              
# SiteRedRivr -0.689 -0.056  0.501       
# SiteSandyBr -0.696 -0.006  0.499  0.498


qqnorm(resid(C59_model))
qqline(resid(C59_model))

report(C59_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C5 with Spine.Age and Site (formula: log(C5) ~
#                                                                                     Spine.Age + Site). The model included Site as random effect (formula: ~1
#                                                                                                                                                  | Site). The model's total explanatory power is substantial (conditional
# R2 = 0.84) and the part related to the fixed effects alone (marginal R2)
# is of 0.20. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at -1.01 (95% CI [-3.39, 1.36], t(47) = -0.86, p
#                                    = 0.395). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(47) = 0.78, p = 0.440; Std. beta =
#     -5.20e-03, 95% CI [-0.09, 0.08])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.95, 95% CI [-4.27, 2.37], t(47) = -0.58, p = 0.568;
#           Std. beta = -0.51, 95% CI [-2.80, 1.79])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.60, 95% CI [-4.92, 1.72], t(47) = -0.97, p = 0.338;
#           Std. beta = -0.72, 95% CI [-3.02, 1.57])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.59, 95% CI [-4.91, 1.74], t(47) = -0.96, p = 0.342;
#           Std. beta = -0.75, 95% CI [-3.05, 1.55])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(C59_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C5)
# Chisq Df Pr(>Chisq)
# (Intercept) 0.7362  1     0.3909
# Spine.Age   0.6072  1     0.4359
# Site        1.2469  3     0.7418

C58_model <- lmer(log(C5) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(C58_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(C5) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 100.4
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.76141 -0.67851 -0.04108  0.64460  1.94581 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 1.0344   1.0170  
# Residual             0.2825   0.5315  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              0.05288    1.12160   0.047
# Spine.Age               -0.14594    0.07145  -2.043
# SiteMatheson            -1.38095    1.56915  -0.880
# SiteRed River           -3.33191    1.55963  -2.136
# SiteSandy Bar           -3.40835    1.64104  -2.077
# Spine.Age:SiteMatheson   0.08761    0.08687   1.009
# Spine.Age:SiteRed River  0.23813    0.08025   2.968
# Spine.Age:SiteSandy Bar  0.28172    0.11582   2.432
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.403                                          
# SiteMathesn -0.715  0.288                                   
# SiteRedRivr -0.719  0.290  0.514                            
# SiteSandyBr -0.683  0.276  0.489  0.492                     
# Spn.Ag:StMt  0.332 -0.823 -0.378 -0.239 -0.227              
# Spn.Ag:StRR  0.359 -0.890 -0.257 -0.360 -0.246  0.732       
# Spn.Ag:StSB  0.249 -0.617 -0.178 -0.179 -0.462  0.507  0.549

emmeans(C58_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean   SE     df lower.CL upper.CL
# Dauphin River  -1.07 1.03  64332    -3.09    0.949
# Matheson       -1.78 1.03 142906    -3.79    0.234
# Red River      -2.57 1.03  94800    -4.58   -0.553
# Sandy Bar      -2.31 1.04  32677    -4.34   -0.278
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate   SE     df t.ratio p.value
# Dauphin River - Matheson     0.706 1.45  92001   0.485  0.9624
# Dauphin River - Red River    1.497 1.46  77329   1.028  0.7328
# Dauphin River - Sandy Bar    1.238 1.46  44476   0.847  0.8320
# Matheson - Red River         0.791 1.45 115128   0.545  0.9480
# Matheson - Sandy Bar         0.532 1.46  59397   0.365  0.9834
# Red River - Sandy Bar       -0.259 1.46  51676  -0.178  0.9980
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(C58_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.17259079
# .sigma                   0.41078477  0.59989630
# (Intercept)             -0.81801274  0.92376748
# Spine.Age               -0.27752353 -0.01435517
# SiteMatheson            -2.53625662 -0.22563374
# SiteRed River           -4.44263281 -2.22117709
# SiteSandy Bar           -4.86337270 -1.95331947
# Spine.Age:SiteMatheson  -0.07236911  0.24758460
# Spine.Age:SiteRed River  0.09035261  0.38591482
# Spine.Age:SiteSandy Bar  0.06842535  0.49500585

plot(C58_model)
# Check model performance
check_model(C58_model) # collinearitiwes
# Plot the Q-Q plot for the residuals
qqnorm(resid(C58_model))
qqline(resid(C58_model))
Anova(C58_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(C5)
# Chisq Df Pr(>Chisq)   
# (Intercept)     0.0022  1   0.962398   
# Spine.Age       4.1719  1   0.041099 * 
#   Site            6.3905  3   0.094083 . 
# Spine.Age:Site 13.4194  3   0.003812 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(C58_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C5 with Spine.Age and Site (formula: log(C5) ~
#                                                                                     Spine.Age * Site). The model included Site as random effect (formula: ~1
#                                                                                                                                                  | Site). The model's total explanatory power is substantial (conditional
# R2 = 0.84) and the part related to the fixed effects alone (marginal R2)
# is of 0.27. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at 0.05 (95% CI [-2.21, 2.31], t(44) = 0.05, p =
#                                     0.963). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.15, 95% CI [-0.29, -1.94e-03], t(44) = -2.04, p = 0.047; Std. beta =
#                                                                          -0.27, 95% CI [-0.49, -0.05])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.38, 95% CI [-4.54, 1.78], t(44) = -0.88, p = 0.384;
#           Std. beta = -0.38, 95% CI [-2.53, 1.76])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -3.33, 95% CI [-6.48, -0.19], t(44) = -2.14, p = 0.038;
#           Std. beta = -0.66, 95% CI [-2.81, 1.49])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -3.41, 95% CI [-6.72, -0.10], t(44) = -2.08, p = 0.044;
#           Std. beta = -0.59, 95% CI [-2.74, 1.56])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 0.09, 95% CI [-0.09, 0.26], t(44) =
#                                 1.01, p = 0.319; Std. beta = 0.20, 95% CI [-0.07, 0.47])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.24, 95% CI [0.08, 0.40], t(44) = 2.97, p = 0.005;
#               Std. beta = 0.36, 95% CI [0.11, 0.60])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# # and positive (beta = 0.28, 95% CI [0.05, 0.52], t(44) = 2.43, p = 0.019;
#               Std. beta = 0.39, 95% CI [0.04, 0.75])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C59_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C5 with Spine.Age and Site (formula: log(C5) ~
#                                                                                     Spine.Age + Site). The model included Site as random effect (formula: ~1
#                                                                                                                                                  | Site). The model's total explanatory power is substantial (conditional
# R2 = 0.84) and the part related to the fixed effects alone (marginal R2)
# is of 0.20. The model's intercept, corresponding to Spine.Age = 0 and
# Site = Dauphin River, is at -1.01 (95% CI [-3.39, 1.36], t(47) = -0.86, p
#                                    = 0.395). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(47) = 0.78, p = 0.440; Std. beta =
#     -5.20e-03, 95% CI [-0.09, 0.08])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.95, 95% CI [-4.27, 2.37], t(47) = -0.58, p = 0.568;
#           Std. beta = -0.51, 95% CI [-2.80, 1.79])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.60, 95% CI [-4.92, 1.72], t(47) = -0.97, p = 0.338;
#           Std. beta = -0.72, 95% CI [-3.02, 1.57])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.59, 95% CI [-4.91, 1.74], t(47) = -0.96, p = 0.342;
#           Std. beta = -0.75, 95% CI [-3.05, 1.55])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(C53_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict C5 with Spine.Age (formula: log(C5) ~ Spine.Age).
# The model included Site as random effect (formula: ~1 | Site). The
# model's total explanatory power is substantial (conditional R2 = 0.61)
# and the part related to the fixed effects alone (marginal R2) is of
# 4.14e-03. The model's intercept, corresponding to Spine.Age = 0, is at
# -2.02 (95% CI [-2.90, -1.15], t(50) = -4.65, p < .001). Within this
# model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.04, 0.08], t(50) = 0.69, p = 0.495; Std. beta =
#     -9.24e-03, 95% CI [-0.09, 0.08])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(C58_model,C59_model,C53_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   C53_model: log(C5) ~ Spine.Age + (1 | Site)
# C59_model: log(C5) ~ Spine.Age + Site + (1 | Site)
# C58_model: log(C5) ~ Spine.Age * Site + (1 | Site)
# npar     AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)   
# C53_model    4 113.566 121.52 -52.783  105.566                        
# C59_model    7 104.147 118.07 -45.073   90.147 15.419  3   0.001491 **
#   C58_model   10  96.324 116.21 -38.162   76.324 13.823  3   0.003156 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### Valine_Average ####


# retrying the models

Valine_Average_lm_plot<- ggplot(data = PCA_18W, 
                    mapping = aes(x = Spine.Age, y = Valine_Average)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Valine_Average_lm_plot



#test normality
(shapiro.test(PCA_18W$Valine_Average
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Valine_Average
# W = 0.84566, p-value = 6.023e-06
shapiro.test(log(Valine_Average))
# Shapiro-Wilk normality test
# 
# data:  log(Valine_Average)
# W = 0.98468, p-value = 0.7162




##  model no interaction si6e random metabolite log transformed
Valine_Average3_model <- lmer(log(Valine_Average) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Valine_Average3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Valine_Average) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 78.6
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.35447 -0.61595  0.06244  0.78962  1.90355 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2497   0.4997  
# Residual             0.1850   0.4301  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  4.47603    0.30237  14.803
# Spine.Age    0.06349    0.02096   3.029
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.527
Valine_Average3_model_emm <- emmeans(Valine_Average3_model, ~ Spine.Age)
Valine_Average3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   4.97 0.257 2.98     4.14     5.79
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Valine_Average3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Valine_Average)    
# -----------------------------------------------
#   Spine.Age                    0.063***          
#   (0.021)          
# 
# Constant                     4.476***          
#   (0.302)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -39.323          
# Akaike Inf. Crit.             86.646           
# Bayesian Inf. Crit.           94.602           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Valine_Average3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Valine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 219.128  1  < 2.2e-16 ***
#   Spine.Age     9.177  1   0.002451 ** 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Valine_Average3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Valine_Average3_model))
qqline(resid(Valine_Average3_model))

report(Valine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Valine_Average with Spine.Age (formula:
#                                                                                        log(Valine_Average) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.61) and the part related to the fixed
# effects alone (marginal R2) is of 0.08. The model's intercept,
# corresponding to Spine.Age = 0, is at 4.48 (95% CI [3.87, 5.08], t(50) =
#                                               14.80, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.06, 95% CI [0.02, 0.11], t(50) = 3.03, ; Std. beta = 0.12,
#                                                                        95% CI [0.04, 0.21])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
Valine_Average9_model <- lmer(log(Valine_Average) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Valine_Average9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Valine_Average) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 72.7
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.45263 -0.59755  0.09555  0.74377  1.95033 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1491   0.3862  
# Residual             0.1851   0.4302  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    5.21725    0.42343  12.322
# Spine.Age      0.06601    0.02107   3.133
# SiteMatheson  -0.96894    0.56921  -1.702
# SiteRed River -1.11029    0.57228  -1.940
# SiteSandy Bar -0.96884    0.57553  -1.683
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.315                     
# SiteMathesn -0.652 -0.057              
# SiteRedRivr -0.629 -0.118  0.502       
# SiteSandyBr -0.659 -0.012  0.494  0.492


qqnorm(resid(Valine_Average9_model))
qqline(resid(Valine_Average9_model))

report(Valine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Valine_Average with Spine.Age and Site (formula:
#                                                                                                 log(Valine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.65) and the part related to the fixed
# effects alone (marginal R2) is of 0.37. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.22 (95%
#                                                                      CI [4.37, 6.07], t(47) = 12.32, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.02, 0.11], t(47) = 3.13, p = 0.003; Std. beta = 0.13,
#                                                                        95% CI [0.04, 0.22])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.97, 95% CI [-2.11, 0.18], t(47) = -1.70, p = 0.095;
#           Std. beta = -0.70, 95% CI [-1.52, 0.12])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.11, 95% CI [-2.26, 0.04], t(47) = -1.94, p = 0.058;
#           Std. beta = -0.77, 95% CI [-1.60, 0.05])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.97, 95% CI [-2.13, 0.19], t(47) = -1.68, p = 0.099;
# #           Std. beta = -0.67, 95% CI [-1.50, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Valine_Average9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Valine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 151.8203  1  < 2.2e-16 ***
#   Spine.Age     9.8147  1   0.001731 ** 
#   Site          4.8259  3   0.184995    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Valine_Average8_model <- lmer(log(Valine_Average) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Valine_Average8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Valine_Average) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 75.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.3514 -0.6395 -0.1088  0.6392  2.5241 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1323   0.3638  
# Residual             0.1642   0.4052  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              5.46011    0.51216  10.661
# Spine.Age                0.02767    0.05447   0.508
# SiteMatheson            -0.58128    0.70242  -0.828
# SiteRed River           -1.69751    0.68998  -2.460
# SiteSandy Bar           -1.94699    0.79217  -2.458
# Spine.Age:SiteMatheson  -0.04180    0.06623  -0.631
# Spine.Age:SiteRed River  0.07447    0.06118   1.217
# Spine.Age:SiteSandy Bar  0.14864    0.08830   1.683
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.674                                          
# SiteMathesn -0.729  0.491                                   
# SiteRedRivr -0.742  0.500  0.541                            
# SiteSandyBr -0.647  0.436  0.471  0.480                     
# Spn.Ag:StMt  0.554 -0.823 -0.644 -0.411 -0.358              
# Spn.Ag:StRR  0.600 -0.890 -0.437 -0.620 -0.388  0.732       
# Spn.Ag:StSB  0.416 -0.617 -0.303 -0.308 -0.729  0.507  0.549

emmeans(Valine_Average8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   5.67 0.386 3735     4.92     6.43
# Matheson        4.77 0.379 7830     4.03     5.51
# Red River       4.55 0.382 5337     3.80     5.30
# Sandy Bar       4.87 0.395 2032     4.10     5.65
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE   df t.ratio p.value
# Dauphin River - Matheson     0.903 0.541 5191   1.671  0.3391
# Dauphin River - Red River    1.124 0.543 4421   2.070  0.1631
# Dauphin River - Sandy Bar    0.802 0.552 2673   1.453  0.4664
# Matheson - Red River         0.221 0.538 6395   0.410  0.9767
# Matheson - Sandy Bar        -0.101 0.547 3473  -0.185  0.9977
# Red River - Sandy Bar       -0.322 0.549 3060  -0.586  0.9363
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Valine_Average8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.13158550
# .sigma                   0.31318918  0.45737097
# (Intercept)              4.79613246  6.12409483
# Spine.Age               -0.07265497  0.12798899
# SiteMatheson            -1.46210551  0.29955201
# SiteRed River           -2.54434265 -0.85066766
# SiteSandy Bar           -3.05632708 -0.83765384
# Spine.Age:SiteMatheson  -0.16377332  0.08016473
# Spine.Age:SiteRed River -0.03820316  0.18713842
# Spine.Age:SiteSandy Bar -0.01397609  0.31125601

plot(Valine_Average8_model)
# Check model performance
check_model(Valine_Average8_model) # some collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Valine_Average8_model))
qqline(resid(Valine_Average8_model))
Anova(Valine_Average8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Valine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept)    113.6555  1    < 2e-16 ***
#   Spine.Age        0.2579  1    0.61153    
# Site             9.2990  3    0.02557 *  
#   Spine.Age:Site   9.2246  3    0.02645 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Valine_Average8_model)

# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Valine_Average with Spine.Age and Site (formula:
#                                                                                                 log(Valine_Average) ~ Spine.Age * Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.69) and the part related to the fixed
# effects alone (marginal R2) is of 0.44. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.46 (95%
#                                                                      CI [4.43, 6.49], t(44) = 10.66, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.08, 0.14], t(44) = 0.51, p = 0.614; Std. beta =
#     0.08, 95% CI [-0.16, 0.31])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.58, 95% CI [-2.00, 0.83], t(44) = -0.83, p = 0.412;
#           Std. beta = -0.67, 95% CI [-1.47, 0.13])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -1.70, 95% CI [-3.09, -0.31], t(44) = -2.46, p = 0.018;
#           Std. beta = -0.79, 95% CI [-1.59, 0.01])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -1.95, 95% CI [-3.54, -0.35], t(44) = -2.46, p = 0.018;
#           Std. beta = -0.58, 95% CI [-1.39, 0.23])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.04, 95% CI [-0.18, 0.09], t(44) =
#                                 -0.63, p = 0.531; Std. beta = -0.10, 95% CI [-0.38, 0.19])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.07, 95% CI [-0.05, 0.20], t(44) =
#                                 1.22, p = 0.230; Std. beta = 0.12, 95% CI [-0.15, 0.38])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.15, 95% CI [-0.03, 0.33], t(44) =
#                                 1.68, p = 0.099; Std. beta = 0.25, 95% CI [-0.13, 0.63])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Valine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Valine_Average with Spine.Age and Site (formula:
#                                                                                                 log(Valine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.65) and the part related to the fixed
# effects alone (marginal R2) is of 0.37. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.22 (95%
#                                                                      CI [4.37, 6.07], t(47) = 12.32, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.02, 0.11], t(47) = 3.13, p = 0.003; Std. beta = 0.13,
#                                                                        95% CI [0.04, 0.22])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.97, 95% CI [-2.11, 0.18], t(47) = -1.70, p = 0.095;
#           Std. beta = -0.70, 95% CI [-1.52, 0.12])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.11, 95% CI [-2.26, 0.04], t(47) = -1.94, p = 0.058;
#           Std. beta = -0.77, 95% CI [-1.60, 0.05])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.97, 95% CI [-2.13, 0.19], t(47) = -1.68, p = 0.099;
#           Std. beta = -0.67, 95% CI [-1.50, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Valine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Valine_Average with Spine.Age (formula:
#                                                                                        log(Valine_Average) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.61) and the part related to the fixed
# effects alone (marginal R2) is of 0.08. The model's intercept,
# corresponding to Spine.Age = 0, is at 4.48 (95% CI [3.87, 5.08], t(50) =
#                                               14.80, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.06, 95% CI [0.02, 0.11], t(50) = 3.03, p = 0.004; Std. beta = 0.12,
#                                                                        95% CI [0.04, 0.21])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Valine_Average8_model,Valine_Average9_model,Valine_Average3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Valine_Average3_model: log(Valine_Average) ~ Spine.Age + (1 | Site)
# Valine_Average9_model: log(Valine_Average) ~ Spine.Age + Site + (1 | Site)
# Valine_Average8_model: log(Valine_Average) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df
# Valine_Average3_model    4 79.709 87.665 -35.855   71.709           
# Valine_Average9_model    7 70.897 84.820 -28.449   56.897 14.8121  3
# Valine_Average8_model   10 67.028 86.917 -23.514   47.028  9.8694  3
# Pr(>Chisq)   
# Valine_Average3_model              
# Valine_Average9_model   0.001984 **
#   Valine_Average8_model   0.019709 * 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#### PC36_0AA ####


# retrying the models

PC36_0AA_lm_plot<- ggplot(data = PCA_18W, 
                                mapping = aes(x = Spine.Age, y = PC36_0AA)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
PC36_0AA_lm_plot



#test normality
(shapiro.test(PCA_18W$PC36_0AA
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$PC36_0AA
# W = 0.93399, p-value = 0.005276
shapiro.test(log(PC36_0AA))
# Shapiro-Wilk normality test
# 
# data:  log(PC36_0AA)
# W = 0.96423, p-value = 0.1066

##  model no interaction si6e random metabolite log transformed
PC36_0AA3_model <- lmer(log(PC36_0AA) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(PC36_0AA3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(PC36_0AA) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 66
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.3240 -0.6737  0.0981  0.5067  1.8230 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1338   0.3658  
# Residual             0.1483   0.3851  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  4.92420    0.23793   20.70
# Spine.Age   -0.08179    0.01872   -4.37
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.599
PC36_0AA3_model_emm <- emmeans(PC36_0AA3_model, ~ Spine.Age)
PC36_0AA3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   4.29 0.191 2.97     3.68      4.9
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(PC36_0AA3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(PC36_0AA)       
# -----------------------------------------------
#   Spine.Age                    -0.082***         
#   (0.019)          
# 
# Constant                     4.924***          
#   (0.238)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -33.009          
# Akaike Inf. Crit.             74.018           
# Bayesian Inf. Crit.           81.974           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(PC36_0AA3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(PC36_0AA)
# Chisq Df Pr(>Chisq)    
# (Intercept) 428.307  1  < 2.2e-16 ***
#   Spine.Age    19.093  1  1.245e-05 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(PC36_0AA3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(PC36_0AA3_model))
qqline(resid(PC36_0AA3_model))

report(PC36_0AA3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict PC36_0AA with Spine.Age (formula: log(PC36_0AA) ~
#                                                                                  Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                          Site). The model's total explanatory power is substantial (conditional R2
# = 0.57) and the part related to the fixed effects alone (marginal R2) is
# of 0.18. The model's intercept, corresponding to Spine.Age = 0, is at
# 4.92 (95% CI [4.45, 5.40], t(50) = 20.70, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.08, 95% CI [-0.12, -0.04], t(50) = -4.37, p < .001; Std. beta =
#                                                                          -0.17, 95% CI [-0.25, -0.09])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
PC36_0AA9_model <- lmer(log(PC36_0AA) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(PC36_0AA9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(PC36_0AA) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 61.9
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.2772 -0.6529  0.0797  0.5459  1.8491 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1333   0.3651  
# Residual             0.1483   0.3851  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    5.46876    0.39681  13.782
# Spine.Age     -0.07968    0.01887  -4.224
# SiteMatheson  -0.68207    0.53591  -1.273
# SiteRed River -0.74602    0.53852  -1.385
# SiteSandy Bar -0.82594    0.54129  -1.526
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.301                     
# SiteMathesn -0.657 -0.054              
# SiteRedRivr -0.636 -0.112  0.502       
# SiteSandyBr -0.663 -0.012  0.494  0.492


qqnorm(resid(PC36_0AA9_model))
qqline(resid(PC36_0AA9_model))

report(PC36_0AA9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict PC36_0AA with Spine.Age and Site (formula:
#                                                                                           log(PC36_0AA) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.70) and the part related to the fixed
# effects alone (marginal R2) is of 0.44. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.47 (95%
#                                                                      CI [4.67, 6.27], t(47) = 13.78, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.08, 95% CI [-0.12, -0.04], t(47) = -4.22, p < .001; Std. beta =
#                                                                          -0.17, 95% CI [-0.24, -0.09])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.68, 95% CI [-1.76, 0.40], t(47) = -1.27, p = 0.209;
#           Std. beta = -0.51, 95% CI [-0.72, -0.29])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.75, 95% CI [-1.83, 0.34], t(47) = -1.39, p = 0.172;
#           Std. beta = -0.54, 95% CI [-0.76, -0.32])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.83, 95% CI [-1.91, 0.26], t(47) = -1.53, p = 0.134;
#           Std. beta = -0.60, 95% CI [-0.84, -0.36])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(PC36_0AA9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(PC36_0AA)
# Chisq Df Pr(>Chisq)    
# (Intercept) 189.9406  1  < 2.2e-16 ***
#   Spine.Age    17.8404  1  2.402e-05 ***
#   Site          2.9954  3     0.3923    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

PC36_0AA8_model <- lmer(log(PC36_0AA) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(PC36_0AA8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(PC36_0AA) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 67.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.1960 -0.6133  0.0109  0.5787  2.0923 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.007709 0.0878  
# Residual             0.137257 0.3705  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              5.21602    0.34111  15.291
# Spine.Age               -0.03977    0.04981  -0.799
# SiteMatheson            -0.10761    0.45454  -0.237
# SiteRed River           -0.78726    0.43833  -1.796
# SiteSandy Bar            0.21195    0.56457   0.375
# Spine.Age:SiteMatheson  -0.08080    0.06055  -1.334
# Spine.Age:SiteRed River -0.00907    0.05594  -0.162
# Spine.Age:SiteSandy Bar -0.15768    0.08073  -1.953
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.925                                          
# SiteMathesn -0.750  0.694                                   
# SiteRedRivr -0.778  0.720  0.584                            
# SiteSandyBr -0.604  0.559  0.453  0.470                     
# Spn.Ag:StMt  0.761 -0.823 -0.910 -0.592 -0.460              
# Spn.Ag:StRR  0.823 -0.890 -0.618 -0.893 -0.497  0.732       
# Spn.Ag:StSB  0.570 -0.617 -0.428 -0.444 -0.935  0.507  0.549

emmeans(PC36_0AA8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE    df lower.CL upper.CL
# Dauphin River   4.91 0.147 111.7     4.62     5.20
# Matheson        4.18 0.130 155.7     3.92     4.44
# Red River       4.05 0.138 130.0     3.78     4.33
# Sandy Bar       3.91 0.165  89.3     3.58     4.24
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE    df t.ratio p.value
# Dauphin River - Matheson     0.730 0.196 128.4   3.725  0.0016
# Dauphin River - Red River    0.857 0.201 119.8   4.257  0.0002
# Dauphin River - Sandy Bar    1.003 0.221  98.3   4.538  0.0001
# Matheson - Red River         0.127 0.190 141.2   0.670  0.9081
# Matheson - Sandy Bar         0.273 0.210 108.5   1.297  0.5668
# Red River - Sandy Bar        0.146 0.215 103.3   0.677  0.9057
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(PC36_0AA8_model)
# Computing profile confidence intervals ...
# 2.5 %       97.5 %
#   .sig01                   0.0000000  0.120305489
# .sigma                   0.2863411  0.418162909
# (Intercept)              4.6089591  5.823082098
# Spine.Age               -0.1314973  0.051946448
# SiteMatheson            -0.9129255  0.697714154
# SiteRed River           -1.5615026 -0.013017651
# SiteSandy Bar           -0.8022901  1.226187709
# Spine.Age:SiteMatheson  -0.1923171  0.030709362
# Spine.Age:SiteRed River -0.1120819  0.093942344
# Spine.Age:SiteSandy Bar -0.3063550 -0.009003335

plot(PC36_0AA8_model)
# Check model performance
check_model(PC36_0AA8_model) # collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(PC36_0AA8_model))
qqline(resid(PC36_0AA8_model))
Anova(PC36_0AA8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(PC36_0AA)
# Chisq Df Pr(>Chisq)    
# (Intercept)    233.8232  1    < 2e-16 ***
#   Spine.Age        0.6378  1    0.42451    
# Site             5.5946  3    0.13309    
# Spine.Age:Site   6.9550  3    0.07334 .  
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(PC36_0AA8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict PC36_0AA with Spine.Age and Site (formula:
#                                                                                           log(PC36_0AA) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.64) and the part related to the fixed
# effects alone (marginal R2) is of 0.62. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.22 (95%
#                                                                      CI [4.53, 5.90], t(44) = 15.29, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.04, 95% CI [-0.14, 0.06], t(44) = -0.80, p = 0.429; Std. beta
#   = -0.10, 95% CI [-0.30, 0.11])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.11, 95% CI [-1.02, 0.81], t(44) = -0.24, p = 0.814;
#           Std. beta = -0.53, 95% CI [-0.74, -0.33])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.79, 95% CI [-1.67, 0.10], t(44) = -1.80, p = 0.079;
#           Std. beta = -0.61, 95% CI [-0.82, -0.39])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.21, 95% CI [-0.93, 1.35], t(44) = 0.38, p = 0.709;
#           Std. beta = -0.71, 95% CI [-0.95, -0.46])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.08, 95% CI [-0.20, 0.04], t(44) =
#                                 -1.33, p = 0.189; Std. beta = -0.15, 95% CI [-0.40, 0.11])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and negative (beta = -9.07e-03, 95% CI [-0.12, 0.10],
#                               t(44) = -0.16, p = 0.872; Std. beta = -6.28e-03, 95% CI [-0.24, 0.23])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and negative (beta = -0.16, 95% CI [-0.32, 5.02e-03],
#                               t(44) = -1.95, p = 0.057; Std. beta = -0.30, 95% CI [-0.64, 0.03])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(PC36_0AA9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict PC36_0AA with Spine.Age and Site (formula:
#                                                                                           log(PC36_0AA) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.70) and the part related to the fixed
# effects alone (marginal R2) is of 0.44. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.47 (95%
#                                                                      CI [4.67, 6.27], t(47) = 13.78, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.08, 95% CI [-0.12, -0.04], t(47) = -4.22, p < .001; Std. beta =
#                                                                          -0.17, 95% CI [-0.24, -0.09])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.68, 95% CI [-1.76, 0.40], t(47) = -1.27, p = 0.209;
#           Std. beta = -0.51, 95% CI [-0.72, -0.29])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.75, 95% CI [-1.83, 0.34], t(47) = -1.39, p = 0.172;
#           Std. beta = -0.54, 95% CI [-0.76, -0.32])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.83, 95% CI [-1.91, 0.26], t(47) = -1.53, p = 0.134;
# #           Std. beta = -0.60, 95% CI [-0.84, -0.36])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(PC36_0AA3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict PC36_0AA with Spine.Age (formula: log(PC36_0AA) ~
#                                                                                  Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                          Site). The model's total explanatory power is substantial (conditional R2
# = 0.57) and the part related to the fixed effects alone (marginal R2) is
# of 0.18. The model's intercept, corresponding to Spine.Age = 0, is at
# 4.92 (95% CI [4.45, 5.40], t(50) = 20.70, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and negative (beta
#                                                                        = -0.08, 95% CI [-0.12, -0.04], t(50) = -4.37, p < .001; Std. beta =
#                                                                          -0.17, 95% CI [-0.25, -0.09])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(PC36_0AA8_model,PC36_0AA9_model,PC36_0AA3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   PC36_0AA3_model: log(PC36_0AA) ~ Spine.Age + (1 | Site)
# PC36_0AA9_model: log(PC36_0AA) ~ Spine.Age + Site + (1 | Site)
# PC36_0AA8_model: log(PC36_0AA) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df Pr(>Chisq)
# PC36_0AA3_model    4 66.256 74.212 -29.128   58.256                      
# PC36_0AA9_model    7 58.952 72.874 -22.476   44.952 13.3045  3   0.004022
# PC36_0AA8_model   10 57.348 77.238 -18.674   37.348  7.6033  3   0.054963
# 
# PC36_0AA3_model   
# PC36_0AA9_model **
#   PC36_0AA8_model . 
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

#### Isobutyric_Acid ####


# retrying the models

Isobutyric_Acid_lm_plot<- ggplot(data = PCA_18W, 
                          mapping = aes(x = Spine.Age, y = Isobutyric_Acid)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Isobutyric_Acid_lm_plot



#test normality
(shapiro.test(PCA_18W$Isobutyric_Acid
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Isobutyric_Acid
# W = 0.8958, p-value = 0.0002039
shapiro.test(log(Isobutyric_Acid))
# Shapiro-Wilk normality test
# 
# data:  log(Isobutyric_Acid)
# W = 0.97676, p-value = 0.3741




##  model no interaction si6e random metabolite log transformed
Isobutyric_Acid3_model <- lmer(log(Isobutyric_Acid) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Isobutyric_Acid3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Isobutyric_Acid) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 34.9
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.23762 -0.66049 -0.03029  0.58287  2.73941 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.19974  0.4469  
# Residual             0.07697  0.2774  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  1.06906    0.24909   4.292
# Spine.Age   -0.01844    0.01355  -1.361
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.414
Isobutyric_Acid3_model_emm <- emmeans(Isobutyric_Acid3_model, ~ Spine.Age)
Isobutyric_Acid3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7  0.927 0.227 2.99    0.204     1.65
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Isobutyric_Acid3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Isobutyric_Acid)    
# -----------------------------------------------
#   Spine.Age                     -0.018           
# (0.014)          
# 
# Constant                     1.069***          
#   (0.249)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -17.460          
# Akaike Inf. Crit.             42.920           
# Bayesian Inf. Crit.           50.876           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Isobutyric_Acid3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Isobutyric_Acid)
# Chisq Df Pr(>Chisq)    
# (Intercept) 18.4195  1  1.772e-05 ***
#   Spine.Age    1.8518  1     0.1736    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Isobutyric_Acid3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Isobutyric_Acid3_model))
qqline(resid(Isobutyric_Acid3_model))

report(Isobutyric_Acid3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Isobutyric_Acid with Spine.Age (formula:
#                                                                                         log(Isobutyric_Acid) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.73) and the part related to the fixed
# effects alone (marginal R2) is of 0.01. The model's intercept,
# corresponding to Spine.Age = 0, is at 1.07 (95% CI [0.57, 1.57], t(50) =
#                                               4.29, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.02, 95% CI [-0.05, 8.78e-03], t(50) = -1.36, p = 0.180; Std.
# #   beta = -0.04, 95% CI [-0.11, 0.03])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
Isobutyric_Acid9_model <- lmer(log(Isobutyric_Acid) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Isobutyric_Acid9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Isobutyric_Acid) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 29.8
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1856 -0.6345 -0.0104  0.6157  2.7775 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.00000  0.0000  
# Residual             0.07698  0.2775  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    1.66267    0.11198  14.847
# Spine.Age     -0.01717    0.01359  -1.263
# SiteMatheson  -0.54455    0.10343  -5.265
# SiteRed River -1.05264    0.11025  -9.548
# SiteSandy Bar -0.81951    0.11707  -7.000
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.769                     
# SiteMathesn -0.288 -0.201              
# SiteRedRivr -0.112 -0.394  0.530       
# SiteSandyBr -0.362 -0.039  0.432  0.413
# optimizer (nloptwrap) convergence code: 0 (OK)
# boundary (singular) fit: see help('isSingular')


qqnorm(resid(Isobutyric_Acid9_model))
qqline(resid(Isobutyric_Acid9_model))

report(Isobutyric_Acid9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Isobutyric_Acid with Spine.Age and Site (formula:
#                                                                                                  log(Isobutyric_Acid) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's explanatory power related
# to the fixed effects alone (marginal R2) is 0.71. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 1.66 (95%
#                                                                      CI [1.44, 1.89], t(47) = 14.85, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.02, 95% CI [-0.04, 0.01], t(47) = -1.26, p = 0.213; Std. beta
#   = -0.04, 95% CI [-0.10, 0.03])
# - The effect of Site [Matheson] is statistically significant and negative
# (beta = -0.54, 95% CI [-0.75, -0.34], t(47) = -5.26, p < .001; Std. beta
#   = -0.46, 95% CI [-2.20, 1.28])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -1.05, 95% CI [-1.27, -0.83], t(47) = -9.55, p < .001;
#           Std. beta = -0.84, 95% CI [-2.58, 0.90])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -0.82, 95% CI [-1.06, -0.58], t(47) = -7.00, p < .001;
#           Std. beta = -0.68, 95% CI [-2.42, 1.06])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Isobutyric_Acid9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Isobutyric_Acid)
# Chisq Df Pr(>Chisq)    
# (Intercept) 220.447  1     <2e-16 ***
#   Spine.Age     1.596  1     0.2065    
# Site        102.930  3     <2e-16 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Isobutyric_Acid8_model <- lmer(log(Isobutyric_Acid) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Isobutyric_Acid8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Isobutyric_Acid) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 41.6
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.08337 -0.58455 -0.04121  0.62854  2.73160 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.00000  0.0000  
# Residual             0.07876  0.2806  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              1.48310    0.24969   5.940
# Spine.Age                0.01118    0.03773   0.296
# SiteMatheson            -0.14832    0.33123  -0.448
# SiteRed River           -0.95470    0.31844  -2.998
# SiteSandy Bar           -0.60179    0.41720  -1.442
# Spine.Age:SiteMatheson  -0.05589    0.04587  -1.219
# Spine.Age:SiteRed River -0.01979    0.04237  -0.467
# Spine.Age:SiteSandy Bar -0.03408    0.06116  -0.557
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.957                                          
# SiteMathesn -0.754  0.721                                   
# SiteRedRivr -0.784  0.750  0.591                            
# SiteSandyBr -0.598  0.573  0.451  0.469                     
# Spn.Ag:StMt  0.787 -0.823 -0.946 -0.617 -0.471              
# Spn.Ag:StRR  0.852 -0.890 -0.642 -0.931 -0.510  0.732       
# Spn.Ag:StSB  0.590 -0.617 -0.445 -0.463 -0.959  0.507  0.549
# optimizer (nloptwrap) convergence code: 0 (OK)
# boundary (singular) fit: see help('isSingular')

emmeans(Isobutyric_Acid8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean     SE df lower.CL upper.CL
# Dauphin River  1.569 0.0789  0      NaN      NaN
# Matheson       0.990 0.0701  0      NaN      NaN
# Red River      0.462 0.0923  0      NaN      NaN
# Sandy Bar      0.705 0.1075  0      NaN      NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE df t.ratio p.value
# Dauphin River - Matheson     0.579 0.111  0   5.198     NaN
# Dauphin River - Red River    1.107 0.113  0   9.756     NaN
# Dauphin River - Sandy Bar    0.864 0.130  0   6.645     NaN
# Matheson - Red River         0.528 0.114  0   4.638     NaN
# Matheson - Sandy Bar         0.285 0.129  0   2.216     NaN
# Red River - Sandy Bar       -0.243 0.139  0  -1.744     NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Isobutyric_Acid8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.09113585
# .sigma                   0.21690983  0.31676784
# (Intercept)              1.02323564  1.94296120
# Spine.Age               -0.05829680  0.08066601
# SiteMatheson            -0.75836343  0.46173247
# SiteRed River           -1.54120356 -0.36819128
# SiteSandy Bar           -1.37009775  0.16651995
# Spine.Age:SiteMatheson  -0.14036860  0.02857901
# Spine.Age:SiteRed River -0.09782448  0.05824349
# Spine.Age:SiteSandy Bar -0.14670055  0.07855002

plot(Isobutyric_Acid8_model)
# Check model performance
check_model(Isobutyric_Acid8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Isobutyric_Acid8_model))
qqline(resid(Isobutyric_Acid8_model))
Anova(Isobutyric_Acid8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Isobutyric_Acid)
# Chisq Df Pr(>Chisq)    
# (Intercept)    35.2799  1  2.856e-09 ***
#   Spine.Age       0.0879  1   0.766887    
# Site           11.8903  3   0.007769 ** 
#   Spine.Age:Site  1.8906  3   0.595426    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Isobutyric_Acid8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Isobutyric_Acid with Spine.Age and Site (formula:
#                                                                                                  log(Isobutyric_Acid) ~ Spine.Age * Site). The model included Site as
# random effect (formula: ~1 | Site). The model's explanatory power related
# to the fixed effects alone (marginal R2) is 0.71. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 1.48 (95%
#                                                                      CI [0.98, 1.99], t(44) = 5.94, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.06, 0.09], t(44) = 0.30, p = 0.768; Std. beta =
#     0.03, 95% CI [-0.15, 0.22])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.15, 95% CI [-0.82, 0.52], t(44) = -0.45, p = 0.657;
#           Std. beta = -0.49, 95% CI [-2.27, 1.30])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -0.95, 95% CI [-1.60, -0.31], t(44) = -3.00, p = 0.004;
#           Std. beta = -0.89, 95% CI [-2.67, 0.90])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.60, 95% CI [-1.44, 0.24], t(44) = -1.44, p = 0.156;
#           Std. beta = -0.72, 95% CI [-2.50, 1.07])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.06, 95% CI [-0.15, 0.04], t(44) =
#                                 -1.22, p = 0.230; Std. beta = -0.13, 95% CI [-0.36, 0.09])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and negative (beta = -0.02, 95% CI [-0.11, 0.07], t(44) =
#                                 -0.47, p = 0.643; Std. beta = -0.05, 95% CI [-0.26, 0.16])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and negative (beta = -0.03, 95% CI [-0.16, 0.09], t(44) =
# #                                 -0.56, p = 0.580; Std. beta = -0.08, 95% CI [-0.39, 0.22])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Isobutyric_Acid9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Isobutyric_Acid with Spine.Age and Site (formula:
#                                                                                                  log(Isobutyric_Acid) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's explanatory power related
# to the fixed effects alone (marginal R2) is 0.71. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 1.66 (95%
#                                                                      CI [1.44, 1.89], t(47) = 14.85, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.02, 95% CI [-0.04, 0.01], t(47) = -1.26, p = 0.213; Std. beta
#   = -0.04, 95% CI [-0.10, 0.03])
# - The effect of Site [Matheson] is statistically significant and negative
# (beta = -0.54, 95% CI [-0.75, -0.34], t(47) = -5.26, p < .001; Std. beta
#   = -0.46, 95% CI [-2.20, 1.28])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -1.05, 95% CI [-1.27, -0.83], t(47) = -9.55, p < .001;
#           Std. beta = -0.84, 95% CI [-2.58, 0.90])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -0.82, 95% CI [-1.06, -0.58], t(47) = -7.00, p < .001;
#           Std. beta = -0.68, 95% CI [-2.42, 1.06])
# # 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Isobutyric_Acid3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Isobutyric_Acid with Spine.Age (formula:
#                                                                                         log(Isobutyric_Acid) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.73) and the part related to the fixed
# effects alone (marginal R2) is of 0.01. The model's intercept,
# corresponding to Spine.Age = 0, is at 1.07 (95% CI [0.57, 1.57], t(50) =
#                                               4.29, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.02, 95% CI [-0.05, 8.78e-03], t(50) = -1.36, p = 0.180; Std.
#   beta = -0.04, 95% CI [-0.11, 0.03])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Isobutyric_Acid8_model,Isobutyric_Acid9_model,Isobutyric_Acid3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Isobutyric_Acid3_model: log(Isobutyric_Acid) ~ Spine.Age + (1 | Site)
# Isobutyric_Acid9_model: log(Isobutyric_Acid) ~ Spine.Age + Site + (1 | Site)
# Isobutyric_Acid8_model: log(Isobutyric_Acid) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC   logLik deviance  Chisq Df
# Isobutyric_Acid3_model    4 34.863 42.819 -13.4317  26.8633          
# Isobutyric_Acid9_model    7 23.531 37.454  -4.7657   9.5314 17.332  3
# Isobutyric_Acid8_model   10 27.356 47.246  -3.6782   7.3564  2.175  3
# Pr(>Chisq)    
# Isobutyric_Acid3_model               
# Isobutyric_Acid9_model  0.0006039 ***
#   Isobutyric_Acid8_model  0.5368943    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#### Proline ####


# retrying the models

Proline_lm_plot<- ggplot(data = PCA_18W, 
                                 mapping = aes(x = Spine.Age, y = Proline)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Proline_lm_plot



#test normality
(shapiro.test(PCA_18W$Proline
))
# 
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Proline
# W = 0.86169, p-value = 1.723e-05
shapiro.test(log(Proline))
# Shapiro-Wilk normality test
# 
# data:  log(Proline)
# W = 0.97769, p-value = 0.4078



##  model no interaction si6e random metabolite log transformed
Proline3_model <- lmer(log(Proline) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Proline3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Proline) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 112
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1058 -0.5743  0.1123  0.6202  2.3858 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.3570   0.5975  
# Residual             0.3572   0.5977  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  3.67053    0.38094   9.636
# Spine.Age    0.03301    0.02907   1.136
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.581
Proline3_model_emm <- emmeans(Proline3_model, ~ Spine.Age)
Proline3_model_emm
# Spine.Age emmean   SE   df lower.CL upper.CL
# 7.7   3.92 0.31 2.97     2.93     4.92
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Proline3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Proline)        
# -----------------------------------------------
#   Spine.Age                      0.033           
# (0.029)          
# 
# Constant                     3.671***          
#   (0.381)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -56.009          
# Akaike Inf. Crit.             120.018          
# Bayesian Inf. Crit.           127.974          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Proline3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Proline)
# Chisq Df Pr(>Chisq)    
# (Intercept) 92.8433  1     <2e-16 ***
#   Spine.Age    1.2895  1     0.2561    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Proline3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Proline3_model))
qqline(resid(Proline3_model))

report(Proline3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Proline with Spine.Age (formula: log(Proline) ~
#                                                                                 Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                         Site). The model's total explanatory power is substantial (conditional R2
# = 0.51) and the part related to the fixed effects alone (marginal R2) is
# of 0.01. The model's intercept, corresponding to Spine.Age = 0, is at
# 3.67 (95% CI [2.91, 4.44], t(50) = 9.64, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.03, 0.09], t(50) = 1.14, p = 0.262; Std. beta =
#     0.03, 95% CI [-0.06, 0.13])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Proline9_model <- lmer(log(Proline) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Proline9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Proline) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 105
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.04738 -0.51061  0.01054  0.61845  2.42558 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2879   0.5366  
# Residual             0.3573   0.5978  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    4.54415    0.58834   7.724
# Spine.Age      0.03698    0.02928   1.263
# SiteMatheson  -1.04405    0.79090  -1.320
# SiteRed River -1.36278    0.79517  -1.714
# SiteSandy Bar -1.22097    0.79968  -1.527
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.315                     
# SiteMathesn -0.652 -0.057              
# SiteRedRivr -0.629 -0.118  0.502       
# SiteSandyBr -0.659 -0.012  0.494  0.492


qqnorm(resid(Proline9_model))
qqline(resid(Proline9_model))

report(Proline9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Proline with Spine.Age and Site (formula:
#                                                                                          log(Proline) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.62) and the part related to the fixed
# effects alone (marginal R2) is of 0.31. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.54 (95%
#                                                                      CI [3.36, 5.73], t(47) = 7.72, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.04, 95% CI [-0.02, 0.10], t(47) = 1.26, p = 0.213; Std. beta =
#     0.04, 95% CI [-0.06, 0.13])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.04, 95% CI [-2.64, 0.55], t(47) = -1.32, p = 0.193;
#           Std. beta = -0.62, 95% CI [-2.86, 1.61])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.36, 95% CI [-2.96, 0.24], t(47) = -1.71, p = 0.093;
#           Std. beta = -0.76, 95% CI [-3.00, 1.48])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.22, 95% CI [-2.83, 0.39], t(47) = -1.53, p = 0.134;
#           Std. beta = -0.66, 95% CI [-2.91, 1.58])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Proline9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Proline)
# Chisq Df Pr(>Chisq)    
# (Intercept) 59.6554  1   1.13e-14 ***
#   Spine.Age    1.5947  1     0.2067    
# Site         3.6383  3     0.3033    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Proline8_model <- lmer(log(Proline) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Proline8_model)


# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Proline) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 100.8
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.20943 -0.52857 -0.03412  0.48229  2.49134 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2298   0.4794  
# Residual             0.2851   0.5339  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              4.97175    0.67485   7.367
# Spine.Age               -0.03054    0.07178  -0.425
# SiteMatheson            -0.36534    0.92555  -0.395
# SiteRed River           -2.45090    0.90916  -2.696
# SiteSandy Bar           -2.69586    1.04380  -2.583
# Spine.Age:SiteMatheson  -0.07312    0.08726  -0.838
# Spine.Age:SiteRed River  0.13680    0.08061   1.697
# Spine.Age:SiteSandy Bar  0.22461    0.11634   1.931
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.674                                          
# SiteMathesn -0.729  0.491                                   
# SiteRedRivr -0.742  0.500  0.541                            
# SiteSandyBr -0.647  0.436  0.471  0.480                     
# Spn.Ag:StMt  0.554 -0.823 -0.644 -0.411 -0.358              
# Spn.Ag:StRR  0.600 -0.890 -0.437 -0.620 -0.388  0.732       
# Spn.Ag:StSB  0.416 -0.617 -0.303 -0.308 -0.729  0.507  0.549
emmeans(Proline8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   4.74 0.508 3736     3.74     5.73
# Matheson        3.81 0.499 7834     2.83     4.79
# Red River       3.34 0.503 5339     2.35     4.33
# Sandy Bar       3.77 0.520 2032     2.75     4.79
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE   df t.ratio p.value
# Dauphin River - Matheson    0.9286 0.712 5193   1.304  0.5605
# Dauphin River - Red River   1.3970 0.715 4423   1.953  0.2063
# Dauphin River - Sandy Bar   0.9655 0.727 2674   1.328  0.5453
# Matheson - Red River        0.4684 0.709 6397   0.661  0.9117
# Matheson - Sandy Bar        0.0369 0.721 3474   0.051  1.0000
# Red River - Sandy Bar      -0.4315 0.724 3062  -0.596  0.9332
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Proline8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.17337564
# .sigma                   0.41265273  0.60262421
# (Intercept)              4.09689575  5.84659638
# Spine.Age               -0.16272183  0.10164324
# SiteMatheson            -1.52590238  0.79522761
# SiteRed River           -3.56668159 -1.33512424
# SiteSandy Bar           -4.15750407 -1.23421795
# Spine.Age:SiteMatheson  -0.23382132  0.08758732
# Spine.Age:SiteRed River -0.01165180  0.28525442
# Spine.Age:SiteSandy Bar  0.01034869  0.43886897

plot(Proline8_model)
# Check model performance
check_model(Proline8_model) # collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Proline8_model))
qqline(resid(Proline8_model))
Anova(Proline8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Proline)
# Chisq Df Pr(>Chisq)    
# (Intercept)    54.275  1  1.743e-13 ***
#   Spine.Age       0.181  1   0.670483    
# Site           12.528  3   0.005776 ** 
#   Spine.Age:Site 15.424  3   0.001488 ** 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Proline8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Proline with Spine.Age and Site (formula:
#                                                                                          log(Proline) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.68) and the part related to the fixed
# effects alone (marginal R2) is of 0.42. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.97 (95%
#                                                                      CI [3.61, 6.33], t(44) = 7.37, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.03, 95% CI [-0.18, 0.11], t(44) = -0.43, p = 0.673; Std. beta
#   = -0.07, 95% CI [-0.31, 0.17])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.37, 95% CI [-2.23, 1.50], t(44) = -0.39, p = 0.695;
#           Std. beta = -0.57, 95% CI [-2.63, 1.50])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -2.45, 95% CI [-4.28, -0.62], t(44) = -2.70, p = 0.010;
#           Std. beta = -0.78, 95% CI [-2.84, 1.29])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -2.70, 95% CI [-4.80, -0.59], t(44) = -2.58, p = 0.013;
#           Std. beta = -0.55, 95% CI [-2.62, 1.52])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.07, 95% CI [-0.25, 0.10], t(44) =
#                                 -0.84, p = 0.407; Std. beta = -0.10, 95% CI [-0.40, 0.19])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.14, 95% CI [-0.03, 0.30], t(44) =
#                                 1.70, p = 0.097; Std. beta = 0.21, 95% CI [-0.06, 0.49])
# # - The effect of Spine Age × Site [Sandy Bar] is statistically
# # non-significant and positive (beta = 0.22, 95% CI [-9.87e-03, 0.46],
#                               t(44) = 1.93, p = 0.060; Std. beta = 0.32, 95% CI [-0.08, 0.71])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Proline9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Proline with Spine.Age and Site (formula:
#                                                                                          log(Proline) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.62) and the part related to the fixed
# effects alone (marginal R2) is of 0.31. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.54 (95%
#                                                                      CI [3.36, 5.73], t(47) = 7.72, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.04, 95% CI [-0.02, 0.10], t(47) = 1.26, p = 0.213; Std. beta =
#     0.04, 95% CI [-0.06, 0.13])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.04, 95% CI [-2.64, 0.55], t(47) = -1.32, p = 0.193;
#           Std. beta = -0.62, 95% CI [-2.86, 1.61])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.36, 95% CI [-2.96, 0.24], t(47) = -1.71, p = 0.093;
#           Std. beta = -0.76, 95% CI [-3.00, 1.48])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.22, 95% CI [-2.83, 0.39], t(47) = -1.53, p = 0.134;
#           Std. beta = -0.66, 95% CI [-2.91, 1.58])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Proline3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Proline with Spine.Age (formula: log(Proline) ~
#                                                                                 Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                         Site). The model's total explanatory power is substantial (conditional R2
# = 0.51) and the part related to the fixed effects alone (marginal R2) is
# of 0.01. The model's intercept, corresponding to Spine.Age = 0, is at
# 3.67 (95% CI [2.91, 4.44], t(50) = 9.64, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.03, 95% CI [-0.03, 0.09], t(50) = 1.14, p = 0.262; Std. beta =
# #     0.03, 95% CI [-0.06, 0.13])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Proline8_model,Proline9_model,Proline3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Proline3_model: log(Proline) ~ Spine.Age + (1 | Site)
# Proline9_model: log(Proline) ~ Spine.Age + Site + (1 | Site)
# Proline8_model: log(Proline) ~ Spine.Age * Site + (1 | Site)
# npar     AIC    BIC  logLik deviance  Chisq Df Pr(>Chisq)
# Proline3_model    4 114.111 122.07 -53.056  106.111                     
# Proline9_model    7 106.428 120.35 -46.214   92.428 13.683  3    0.00337
# Proline8_model   10  96.814 116.70 -38.407   76.814 15.614  3    0.00136
# 
# Proline3_model   
# Proline9_model **
#   Proline8_model **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

####  Arginine_Average  ####


# retrying the models

Arginine_Average_lm_plot<- ggplot(data = PCA_18W, 
                         mapping = aes(x = Spine.Age, y =  Arginine_Average )) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Arginine_Average_lm_plot



#test normality
(shapiro.test(PCA_18W$ Arginine_Average
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Arginine_Average
# W = 0.91973, p-value = 0.001459
shapiro.test(log( Arginine_Average))
# Shapiro-Wilk normality test
# 
# data:  log(Arginine_Average)
# W = 0.96417, p-value = 0.106


##  model no interaction si6e random metabolite log transformed
Arginine_Average3_model <- lmer(log(Arginine_Average) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Arginine_Average3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Arginine_Average) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 99.7
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.27589 -0.60445  0.03375  0.77445  1.41216 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.0000   0.0000  
# Residual             0.3275   0.5723  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  3.19269    0.21103  15.129
# Spine.Age    0.10233    0.02546   4.019
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.929
# optimizer (nloptwrap) convergence code: 0 (OK)
# boundary (singular) fit: see help('isSingular')
Arginine_Average3_model_emm <- emmeans(Arginine_Average3_model, ~ Spine.Age)
Arginine_Average3_model_emm
# Spine.Age emmean     SE   df lower.CL upper.CL
# 7.7   3.98 0.0795 2.46     3.69     4.27
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Arginine_Average3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Arginine_Average)   
# -----------------------------------------------
#   Spine.Age                    0.102***          
#   (0.025)          
# 
# Constant                     3.193***          
#   (0.211)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -49.869          
# Akaike Inf. Crit.             107.738          
# Bayesian Inf. Crit.           115.694          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Arginine_Average3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Arginine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 228.892  1  < 2.2e-16 ***
#   Spine.Age    16.155  1  5.837e-05 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Arginine_Average3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Arginine_Average3_model))
qqline(resid(Arginine_Average3_model))

report(Arginine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Arginine_Average with Spine.Age (formula:
#                                                                                          log(Arginine_Average) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's explanatory power related to the
# fixed effects alone (marginal R2) is 0.23. The model's intercept,
# corresponding to Spine.Age = 0, is at 3.19 (95% CI [2.77, 3.62], t(50) =
#                                               15.13, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.05, 0.15], t(50) = 4.02, p < .001; Std. beta = 0.22,
#                                                                        95% CI [0.12, 0.33])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
Arginine_Average9_model <- lmer(log(Arginine_Average) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Arginine_Average9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Arginine_Average) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 102.1
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.0350 -0.5362  0.1088  0.8049  1.3565 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.001832 0.0428  
# Residual             0.336979 0.5805  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    3.09719    0.23817  13.004
# Spine.Age      0.09824    0.02843   3.455
# SiteMatheson   0.26134    0.22471   1.163
# SiteRed River  0.10398    0.23848   0.436
# SiteSandy Bar  0.15298    0.25231   0.606
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.756                     
# SiteMathesn -0.307 -0.194              
# SiteRedRivr -0.139 -0.382  0.527       
# SiteSandyBr -0.376 -0.038  0.436  0.418
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined


qqnorm(resid(Arginine_Average9_model))
qqline(resid(Arginine_Average9_model))

report(Arginine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Arginine_Average with Spine.Age and Site (formula:
#                                                                                                   log(Arginine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is moderate (conditional R2 = 0.25) and the part related to the fixed
# effects alone (marginal R2) is of 0.24. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 3.10 (95%
#                                                                      CI [2.62, 3.58], t(47) = 13.00, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(47) = 3.46, p = 0.001; Std. beta = 0.21,
#                                                                        95% CI [0.10, 0.33])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.26, 95% CI [-0.19, 0.71], t(47) = 1.16, p = 0.251;
#           Std. beta = 0.16, 95% CI [-0.23, 0.55])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.10, 95% CI [-0.38, 0.58], t(47) = 0.44, p = 0.665;
#           Std. beta = 0.09, 95% CI [-0.31, 0.49])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.15, 95% CI [-0.35, 0.66], t(47) = 0.61, p = 0.547;
#           Std. beta = 0.15, 95% CI [-0.27, 0.57])
# # 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Arginine_Average9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Arginine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 169.1023  1    < 2e-16 ***
#   Spine.Age    11.9380  1    0.00055 ***
#   Site          1.4241  3    0.69989    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Arginine_Average8_model <- lmer(log(Arginine_Average) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Arginine_Average8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Arginine_Average) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 95.8
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.88309 -0.55265  0.07491  0.64368  1.85371 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.001496 0.03867 
# Residual             0.255592 0.50556 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              3.94171    0.45146   8.731
# Spine.Age               -0.03510    0.06796  -0.516
# SiteMatheson             0.30864    0.59918   0.515
# SiteRed River           -1.35123    0.57625  -2.345
# SiteSandy Bar           -2.05138    0.75354  -2.722
# Spine.Age:SiteMatheson   0.01998    0.08263   0.242
# Spine.Age:SiteRed River  0.19740    0.07633   2.586
# Spine.Age:SiteSandy Bar  0.33732    0.11017   3.062
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.953                                          
# SiteMathesn -0.753  0.718                                   
# SiteRedRivr -0.783  0.747  0.590                            
# SiteSandyBr -0.599  0.571  0.451  0.469                     
# Spn.Ag:StMt  0.784 -0.823 -0.942 -0.614 -0.470              
# Spn.Ag:StRR  0.849 -0.890 -0.640 -0.927 -0.509  0.732       
# Spn.Ag:StSB  0.588 -0.617 -0.443 -0.461 -0.956  0.507  0.549

emmeans(Arginine_Average8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE df lower.CL upper.CL
# Dauphin River   3.67 0.131  0     -Inf      Inf
# Matheson        4.13 0.139  0     -Inf      Inf
# Red River       3.84 0.155  0     -Inf      Inf
# Sandy Bar       4.22 0.193  0     -Inf      Inf
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE df t.ratio p.value
# Dauphin River - Matheson   -0.4625 0.180  0  -2.566     NaN
# Dauphin River - Red River  -0.1695 0.198  0  -0.854     NaN
# Dauphin River - Sandy Bar  -0.5472 0.230  0  -2.377     NaN
# Matheson - Red River        0.2930 0.193  0   1.521     NaN
# Matheson - Sandy Bar       -0.0847 0.238  0  -0.355     NaN
# Red River - Sandy Bar      -0.3777 0.243  0  -1.555     NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Arginine_Average8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.16654400
# .sigma                   0.39074231  0.57062696
# (Intercept)              3.11335310  4.77006444
# Spine.Age               -0.16026525  0.09006296
# SiteMatheson            -0.79022073  1.40749126
# SiteRed River           -2.40766475 -0.29479716
# SiteSandy Bar           -3.43544425 -0.66731562
# Spine.Age:SiteMatheson  -0.13219225  0.17215071
# Spine.Age:SiteRed River  0.05683241  0.33797395
# Spine.Age:SiteSandy Bar  0.13443803  0.54020538

plot(Arginine_Average8_model)
# Check model performance
check_model(Arginine_Average8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Arginine_Average8_model))
qqline(resid(Arginine_Average8_model))
Anova(Arginine_Average8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Arginine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept)    76.2316  1  < 2.2e-16 ***
#   Spine.Age       0.2667  1  0.6055298    
# Site           17.2234  3  0.0006358 ***
#   Spine.Age:Site 18.6027  3  0.0003303 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Arginine_Average8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Arginine_Average with Spine.Age and Site (formula:
#                                                                                                   log(Arginine_Average) ~ Spine.Age * Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.44) and the part related to the fixed
# effects alone (marginal R2) is of 0.44. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 3.94 (95%
#                                                                      CI [3.03, 4.85], t(44) = 8.73, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.04, 95% CI [-0.17, 0.10], t(44) = -0.52, p = 0.608; Std. beta
#   = -0.04, 95% CI [-0.32, 0.23])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.31, 95% CI [-0.90, 1.52], t(44) = 0.52, p = 0.609;
#           Std. beta = 0.29, 95% CI [-0.11, 0.68])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -1.35, 95% CI [-2.51, -0.19], t(44) = -2.34, p = 0.024;
#           Std. beta = 0.13, 95% CI [-0.28, 0.53])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -2.05, 95% CI [-3.57, -0.53], t(44) = -2.72, p = 0.009;
#           Std. beta = 0.40, 95% CI [-0.03, 0.83])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 0.02, 95% CI [-0.15, 0.19], t(44) =
#                                 0.24, p = 0.810; Std. beta = 0.02, 95% CI [-0.32, 0.35])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.20, 95% CI [0.04, 0.35], t(44) = 2.59, p = 0.013;
#               Std. beta = 0.39, 95% CI [0.09, 0.70])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.34, 95% CI [0.12, 0.56], t(44) = 3.06, p = 0.004;
#               Std. beta = 0.66, 95% CI [0.22, 1.10])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Arginine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Arginine_Average with Spine.Age and Site (formula:
#                                                                                                   log(Arginine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is moderate (conditional R2 = 0.25) and the part related to the fixed
# effects alone (marginal R2) is of 0.24. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 3.10 (95%
#                                                                      CI [2.62, 3.58], t(47) = 13.00, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(47) = 3.46, p = 0.001; Std. beta = 0.21,
#                                                                        95% CI [0.10, 0.33])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.26, 95% CI [-0.19, 0.71], t(47) = 1.16, p = 0.251;
#           Std. beta = 0.16, 95% CI [-0.23, 0.55])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.10, 95% CI [-0.38, 0.58], t(47) = 0.44, p = 0.665;
#           Std. beta = 0.09, 95% CI [-0.31, 0.49])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.15, 95% CI [-0.35, 0.66], t(47) = 0.61, p = 0.547;
#           Std. beta = 0.15, 95% CI [-0.27, 0.57])
# # 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Arginine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Arginine_Average with Spine.Age (formula:
#                                                                                          log(Arginine_Average) ~ Spine.Age). The model included Site as random
# effect (formula: ~1 | Site). The model's explanatory power related to the
# fixed effects alone (marginal R2) is 0.23. The model's intercept,
# corresponding to Spine.Age = 0, is at 3.19 (95% CI [2.77, 3.62], t(50) =
#                                               15.13, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.05, 0.15], t(50) = 4.02, p < .001; Std. beta = 0.22,
#                                                                        95% CI [0.12, 0.33])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Arginine_Average8_model,Arginine_Average9_model,Arginine_Average3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Arginine_Average3_model: log(Arginine_Average) ~ Spine.Age + (1 | Site)
# Arginine_Average9_model: log(Arginine_Average) ~ Spine.Age + Site + (1 | Site)
# Arginine_Average8_model: log(Arginine_Average) ~ Spine.Age * Site + (1 | Site)
# npar     AIC    BIC  logLik deviance   Chisq Df
# Arginine_Average3_model    4  98.930 106.89 -45.465   90.930           
# Arginine_Average9_model    7 103.261 117.18 -44.630   89.261  1.6688  3
# Arginine_Average8_model   10  90.922 110.81 -35.461   70.922 18.3392  3
# Pr(>Chisq)    
# Arginine_Average3_model               
# Arginine_Average9_model  0.6438917    
# Arginine_Average8_model  0.0003744 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

###  Ornithine  ####


# retrying the models

Ornithine_lm_plot<- ggplot(data = PCA_18W, 
                                  mapping = aes(x = Spine.Age, y =  Ornithine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Ornithine_lm_plot



#test normality
(shapiro.test(PCA_18W$Ornithine
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Ornithine
# W = 0.75809, p-value = 4.661e-08
shapiro.test(log(Ornithine))
#na


## square root

shapiro.test(sqrt(Ornithine))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Ornithine)
# W = 0.9461, p-value = 0.01688

## standardized
shapiro.test((Ornithine-(mean(Ornithine))/(sd(Ornithine)))) 
# Shapiro-Wilk normality test
# 
# data:  (Ornithine - (mean(Ornithine))/(sd(Ornithine)))
# W = 0.75809, p-value = 4.661e-08

#sqrt used instead of log
##  model no interaction si6e random metabolite log transformed
Ornithine3_model <- lmer(sqrt(Ornithine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Ornithine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Ornithine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 176.7
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.08990 -0.88092  0.09892  0.68127  2.08070 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.000    0.000   
# Residual             1.439    1.199   
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  0.44292    0.44228   1.001
# Spine.Age    0.20637    0.05336   3.868
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.929
# optimizer (nloptwrap) convergence code: 0 (OK)
# boundary (singular) fit: see help('isSingular')
Ornithine3_model_emm <- emmeans(Ornithine3_model, ~ Spine.Age)
Ornithine3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   2.03 0.167 2.46     1.43     2.63
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Ornithine3_model, type = "text")
# 
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   sqrt(Ornithine)      
# -----------------------------------------------
#   Spine.Age                    0.206***          
#   (0.053)          
# 
# Constant                       0.443           
# (0.442)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -88.346          
# Akaike Inf. Crit.             184.693          
# Bayesian Inf. Crit.           192.649          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Ornithine3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Ornithine)
# Chisq Df Pr(>Chisq)    
# (Intercept)  1.0029  1  0.3166106    
# Spine.Age   14.9583  1  0.0001099 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Ornithine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Ornithine3_model))
qqline(resid(Ornithine3_model))

report(Ornithine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Ornithine with Spine.Age (formula: sqrt(Ornithine)
#                                                                                 ~ Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's explanatory power related to the fixed effects alone
# (marginal R2) is 0.22. The model's intercept, corresponding to Spine.Age
# = 0, is at 0.44 (95% CI [-0.45, 1.33], t(50) = 1.00, p = 0.321). Within
# this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
# #                                                                        = 0.21, 95% CI [0.10, 0.31], t(50) = 3.87, p < .001; Std. beta = 0.24,
#                                                                        95% CI [0.12, 0.37])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Ornithine9_model <- lmer(sqrt(Ornithine) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Ornithine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Ornithine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 174.9
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.8800 -0.7224  0.1995  0.5944  1.8413 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1236   0.3516  
# Residual             1.4871   1.2195  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    0.37254    0.60486   0.616
# Spine.Age      0.19632    0.05973   3.287
# SiteMatheson  -0.04324    0.67370  -0.064
# SiteRed River  0.32860    0.69427   0.473
# SiteSandy Bar  0.41105    0.71552   0.574
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.625                     
# SiteMathesn -0.462 -0.136              
# SiteRedRivr -0.358 -0.275  0.514       
# SiteSandyBr -0.497 -0.028  0.466  0.456
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined


qqnorm(resid(Ornithine9_model))
qqline(resid(Ornithine9_model))
check_model(Ornithine9_model)
report(Ornithine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Ornithine with Spine.Age and Site (formula:
#                                                                                            sqrt(Ornithine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.28) and the part related to the fixed
# effects alone (marginal R2) is of 0.22. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 0.37 (95%
#                                                                      CI [-0.84, 1.59], t(47) = 0.62, p = 0.541). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.20, 95% CI [0.08, 0.32], t(47) = 3.29, p = 0.002; Std. beta = 0.23,
#                                                                        95% CI [0.09, 0.37])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.04, 95% CI [-1.40, 1.31], t(47) = -0.06, p = 0.949;
#           Std. beta = -0.02, 95% CI [-1.03, 1.00])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.33, 95% CI [-1.07, 1.73], t(47) = 0.47, p = 0.638;
#           Std. beta = 0.13, 95% CI [-0.90, 1.15])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# # positive (beta = 0.41, 95% CI [-1.03, 1.85], t(47) = 0.57, p = 0.568;
# #           Std. beta = 0.16, 95% CI [-0.87, 1.19])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Ornithine9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Ornithine)
# Chisq Df Pr(>Chisq)   
# (Intercept)  0.3793  1   0.537952   
# Spine.Age   10.8029  1   0.001013 **
#   Site         0.6406  3   0.887087   
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Ornithine8_model <- lmer(sqrt(Ornithine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Ornithine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Ornithine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 155.3

# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.82705 -0.73551  0.08145  0.67421  2.20517 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2374   0.4873  
# Residual             0.9328   0.9658  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)               2.6784     0.9878   2.711
# Spine.Age                -0.1678     0.1298  -1.292
# SiteMatheson             -0.4024     1.3320  -0.302
# SiteRed River            -3.2804     1.2946  -2.534
# SiteSandy Bar            -5.7852     1.5926  -3.633
# Spine.Age:SiteMatheson    0.1166     0.1579   0.739
# Spine.Age:SiteRed River   0.5008     0.1458   3.434
# Spine.Age:SiteSandy Bar   0.9476     0.2105   4.503
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.832                                          
# SiteMathesn -0.742  0.617                                   
# SiteRedRivr -0.763  0.635  0.566                            
# SiteSandyBr -0.620  0.516  0.460  0.473                     
# Spn.Ag:StMt  0.685 -0.823 -0.809 -0.522 -0.425              
# Spn.Ag:StRR  0.741 -0.890 -0.550 -0.788 -0.460  0.732       
# Spn.Ag:StSB  0.514 -0.617 -0.381 -0.392 -0.864  0.507  0.549

emmeans(Ornithine8_model, pairwise ~ Site, adjust = "tukey")
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   1.39 0.576  573    0.256     2.52
# Matheson        1.88 0.548 1062    0.808     2.96
# Red River       1.96 0.561  768    0.863     3.06
# Sandy Bar       2.90 0.609  356    1.704     4.10
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df t.ratio p.value
# Dauphin River - Matheson   -0.4960 0.794 751  -0.624  0.9243
# Dauphin River - Red River  -0.5774 0.804 658  -0.719  0.8897
# Dauphin River - Sandy Bar  -1.5151 0.838 440  -1.808  0.2707
# Matheson - Red River       -0.0814 0.784 894  -0.104  0.9996
# Matheson - Sandy Bar       -1.0191 0.819 541  -1.245  0.5987
# Red River - Sandy Bar      -0.9377 0.828 489  -1.133  0.6693
# 
# Note: contrasts are still on the sqrt scale. Consider using
# regrid() if you want contrasts of back-transformed estimates. 
# Degrees-of-freedom method: kenward-roger 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Ornithine8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.0000000  0.31363873
# .sigma                   0.7464773  1.09013043
# (Intercept)              1.0957712  4.26093101
# Spine.Age               -0.4068667  0.07136233
# SiteMatheson            -2.5018120  1.69704757
# SiteRed River           -5.2988109 -1.26198569
# SiteSandy Bar           -8.4292541 -3.14111079
# Spine.Age:SiteMatheson  -0.1740924  0.40732690
# Spine.Age:SiteRed River  0.2322262  0.76932129
# Spine.Age:SiteSandy Bar  0.5600485  1.33522974

plot(Ornithine8_model)
# Check model performance
check_model(Ornithine8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Ornithine8_model))
qqline(resid(Ornithine8_model))
Anova(Ornithine8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Ornithine)
# Chisq Df Pr(>Chisq)    
# (Intercept)     7.3511  1  0.0067020 ** 
#   Spine.Age       1.6693  1  0.1963583    
# Site           18.8096  3  0.0002993 ***
#   Spine.Age:Site 32.1138  3  4.952e-07 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Ornithine8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Ornithine with Spine.Age and Site (formula:
#                                                                                            sqrt(Ornithine) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.57) and the part related to the fixed
# effects alone (marginal R2) is of 0.46. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 2.68 (95%
#                                                                      CI [0.69, 4.67], t(44) = 2.71, p = 0.010). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -0.17, 95% CI [-0.43, 0.09], t(44) = -1.29, p = 0.203; Std. beta
#   = -0.20, 95% CI [-0.50, 0.11])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.40, 95% CI [-3.09, 2.28], t(44) = -0.30, p = 0.764;
#           Std. beta = 0.19, 95% CI [-0.24, 0.62])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -3.28, 95% CI [-5.89, -0.67], t(44) = -2.53, p = 0.015;
#           Std. beta = 0.22, 95% CI [-0.22, 0.66])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -5.79, 95% CI [-8.99, -2.58], t(44) = -3.63, p < .001;
#           Std. beta = 0.58, 95% CI [0.10, 1.05])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 0.12, 95% CI [-0.20, 0.43], t(44) =
#                                 0.74, p = 0.464; Std. beta = 0.14, 95% CI [-0.24, 0.51])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.50, 95% CI [0.21, 0.79], t(44) = 3.43, p = 0.001;
#               Std. beta = 0.59, 95% CI [0.24, 0.93])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.95, 95% CI [0.52, 1.37], t(44) = 4.50, p < .001;
#               Std. beta = 1.11, 95% CI [0.62, 1.61])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Ornithine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Ornithine with Spine.Age and Site (formula:
#                                                                                            sqrt(Ornithine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.28) and the part related to the fixed
# effects alone (marginal R2) is of 0.22. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 0.37 (95%
#                                                                      CI [-0.84, 1.59], t(47) = 0.62, p = 0.541). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.20, 95% CI [0.08, 0.32], t(47) = 3.29, p = 0.002; Std. beta = 0.23,
#                                                                        95% CI [0.09, 0.37])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.04, 95% CI [-1.40, 1.31], t(47) = -0.06, p = 0.949;
#           Std. beta = -0.02, 95% CI [-1.03, 1.00])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.33, 95% CI [-1.07, 1.73], t(47) = 0.47, p = 0.638;
#           Std. beta = 0.13, 95% CI [-0.90, 1.15])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.41, 95% CI [-1.03, 1.85], t(47) = 0.57, p = 0.568;
#           Std. beta = 0.16, 95% CI [-0.87, 1.19])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Ornithine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Random effect variances not available. Returned R2 does not account for random effects.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Ornithine with Spine.Age (formula: sqrt(Ornithine)
#                                                                                 ~ Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's explanatory power related to the fixed effects alone
# (marginal R2) is 0.22. The model's intercept, corresponding to Spine.Age
# = 0, is at 0.44 (95% CI [-0.45, 1.33], t(50) = 1.00, p = 0.321). Within
# this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
# #                                                                        = 0.21, 95% CI [0.10, 0.31], t(50) = 3.87, p < .001; Std. beta = 0.24,
#                                                                        95% CI [0.12, 0.37])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Ornithine8_model,Ornithine9_model,Ornithine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Ornithine3_model: sqrt(Ornithine) ~ Spine.Age + (1 | Site)
# Ornithine9_model: sqrt(Ornithine) ~ Spine.Age + Site + (1 | Site)
# Ornithine8_model: sqrt(Ornithine) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df
# Ornithine3_model    4 178.84 186.80 -85.422   170.84           
# Ornithine9_model    7 183.43 197.35 -84.713   169.43  1.4176  3
# Ornithine8_model   10 160.83 180.72 -70.416   140.83 28.5944  3
# Pr(>Chisq)    
# Ornithine3_model               
# Ornithine9_model     0.7014    
# Ornithine8_model  2.725e-06 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


####  Methionine  ####


# retrying the models

Methionine_lm_plot<- ggplot(data = PCA_18W, 
                           mapping = aes(x = Spine.Age, y =  Methionine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Methionine_lm_plot



#test normality
(shapiro.test(PCA_18W$Methionine
))

# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Methionine
# W = 0.90937, p-value = 0.0006057
shapiro.test(log(Methionine))
# 
# Shapiro-Wilk normality test
# 
# data:  log(Methionine)
# W = 0.94534, p-value = 0.01566


## square root

shapiro.test(sqrt(Methionine))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Methionine)
# W = 0.96613, p-value = 0.1298

## standardized
shapiro.test((Methionine-(mean(Methionine))/(sd(Methionine)))) 
# Shapiro-Wilk normality test
# 
# data:  (Methionine - (mean(Methionine))/(sd(Methionine)))
# W = 0.90937, p-value = 0.0006057

##  model no interaction si6e random metabolite log transformed
Methionine3_model <- lmer(sqrt(Methionine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Methionine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 190.1
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.88411 -0.83830  0.05111  0.59283  1.84301 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.364    0.6033  
# Residual             1.730    1.3152  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  3.35116    0.59473   5.635
# Spine.Age    0.23184    0.06277   3.694
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.806
Methionine3_model_emm <- emmeans(Methionine3_model, ~ Spine.Age)
Methionine3_model_emm

stargazer(Methionine3_model, type = "text")
# Dependent variable:    
#   ---------------------------
#   sqrt(Methionine)      
# -----------------------------------------------
#   Spine.Age                    0.232***          
#   (0.063)          
# 
# Constant                     3.351***          
#   (0.595)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -95.060          
# Akaike Inf. Crit.             198.121          
# Bayesian Inf. Crit.           206.076          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01


Anova(Methionine3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 31.751  1  1.753e-08 ***
#   Spine.Age   13.642  1  0.0002212 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Methionine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Methionine3_model))
qqline(resid(Methionine3_model))

report(Methionine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine with Spine.Age (formula:
#                                                                                    sqrt(Methionine) ~ Spine.Age). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.34) and the part related to the fixed effects alone
# (marginal R2) is of 0.20. The model's intercept, corresponding to
# Spine.Age = 0, is at 3.35 (95% CI [2.16, 4.55], t(50) = 5.63, p < .001).
# Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.23, 95% CI [0.11, 0.36], t(50) = 3.69, p < .001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.30])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Methionine9_model <- lmer(sqrt(Methionine) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Methionine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 182.3
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -1.75042 -0.79560 -0.02541  0.62305  1.98229 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.237    0.4868  
# Residual             1.732    1.3161  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    4.27326    0.72056   5.930
# Spine.Age      0.24272    0.06447   3.765
# SiteMatheson  -1.44019    0.84544  -1.703
# SiteRed River -1.16811    0.86462  -1.351
# SiteSandy Bar -1.47772    0.88456  -1.671
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.567                     
# SiteMathesn -0.512 -0.117              
# SiteRedRivr -0.431 -0.239  0.510       
# SiteSandyBr -0.539 -0.024  0.474  0.467

check_model(Methionine9_model)
qqnorm(resid(Methionine9_model))
qqline(resid(Methionine9_model))

report(Methionine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine with Spine.Age and Site (formula:
#                                                                                             sqrt(Methionine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.36) and the part related to the fixed
# effects alone (marginal R2) is of 0.27. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.27 (95%
#                                                                      CI [2.82, 5.72], t(47) = 5.93, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.24, 95% CI [0.11, 0.37], t(47) = 3.77, p < .001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.31])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.44, 95% CI [-3.14, 0.26], t(47) = -1.70, p = 0.095;
#           Std. beta = -0.38, 95% CI [-0.87, 0.11])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.17, 95% CI [-2.91, 0.57], t(47) = -1.35, p = 0.183;
#           Std. beta = -0.32, 95% CI [-0.82, 0.18])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.48, 95% CI [-3.26, 0.30], t(47) = -1.67, p = 0.101;
#           Std. beta = -0.45, 95% CI [-0.96, 0.06])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
Anova(Methionine9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 35.1706  1  3.021e-09 ***
#   Spine.Age   14.1757  1  0.0001665 ***
#   Site         3.9418  3  0.2678131    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Methionine8_model <- lmer(sqrt(Methionine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Methionine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 172.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7891 -0.7332 -0.1135  0.4861  2.7196 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.5673   0.7532  
# Residual             1.3538   1.1635  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              5.71782    1.28020   4.466
# Spine.Age                0.01464    0.15642   0.094
# SiteMatheson            -0.56778    1.73792  -0.327
# SiteRed River           -4.20558    1.69634  -2.479
# SiteSandy Bar           -5.14376    2.03134  -2.532
# Spine.Age:SiteMatheson  -0.06644    0.19017  -0.349
# Spine.Age:SiteRed River  0.39518    0.17567   2.250
# Spine.Age:SiteSandy Bar  0.56131    0.25354   2.214
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.774                                          
# SiteMathesn -0.737  0.570                                   
# SiteRedRivr -0.755  0.584  0.556                            
# SiteSandyBr -0.630  0.488  0.464  0.476                     
# Spn.Ag:StMt  0.636 -0.823 -0.747 -0.480 -0.401              
# Spn.Ag:StRR  0.689 -0.890 -0.508 -0.725 -0.434  0.732       
# Spn.Ag:StSB  0.477 -0.617 -0.352 -0.360 -0.816  0.507  0.549
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined
emmeans(Methionine8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE   df lower.CL upper.CL
# Dauphin River   5.83 0.839 1227     4.19     7.48
# Matheson        4.75 0.811 2427     3.16     6.34
# Red River       4.67 0.824 1701     3.05     6.29
# Sandy Bar       5.01 0.872  712     3.30     6.72
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate   SE   df t.ratio p.value
# Dauphin River - Matheson    1.0796 1.17 1658   0.925  0.7913
# Dauphin River - Red River   1.1613 1.18 1431   0.988  0.7565
# Dauphin River - Sandy Bar   0.8196 1.21  908   0.677  0.9057
# Matheson - Red River        0.0816 1.16 2010   0.071  0.9999
# Matheson - Sandy Bar       -0.2600 1.19 1149  -0.218  0.9963
# Red River - Sandy Bar      -0.3417 1.20 1025  -0.285  0.9919
# 
# Note: contrasts are still on the sqrt scale. Consider using
# regrid() if you want contrasts of back-transformed estimates. 
# Degrees-of-freedom method: kenward-roger 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Methionine8_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                   0.00000000  0.3778430
# .sigma                   0.89928121  1.3132801
# (Intercept)              3.81128214  7.6243500
# Spine.Age               -0.27342438  0.3026982
# SiteMatheson            -3.09695890  1.9614072
# SiteRed River           -6.63716259 -1.7739994
# SiteSandy Bar           -8.32907703 -1.9584509
# Spine.Age:SiteMatheson  -0.41666073  0.2837751
# Spine.Age:SiteRed River  0.07165731  0.7186958
# Spine.Age:SiteSandy Bar  0.09438010  1.0282410

plot(Methionine8_model)
# Check model performance
check_model(Methionine8_model)#collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Methionine8_model))
qqline(resid(Methionine8_model))
Anova(Methionine8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine)
# Chisq Df Pr(>Chisq)    
# (Intercept)    19.9481  1  7.957e-06 ***
#   Spine.Age       0.0088  1  0.9254462    
# Site           11.5823  3  0.0089598 ** 
#   Spine.Age:Site 16.6972  3  0.0008156 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Methionine8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine with Spine.Age and Site (formula:
#                                                                                             sqrt(Methionine) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.56) and the part related to the fixed
# effects alone (marginal R2) is of 0.38. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.72 (95%
#                                                                      CI [3.14, 8.30], t(44) = 4.47, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.30, 0.33], t(44) = 0.09, p = 0.926; Std. beta =
#     8.90e-03, 95% CI [-0.26, 0.28])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.57, 95% CI [-4.07, 2.93], t(44) = -0.33, p = 0.745;
#           Std. beta = -0.28, 95% CI [-0.73, 0.16])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -4.21, 95% CI [-7.62, -0.79], t(44) = -2.48, p = 0.017;
#           Std. beta = -0.32, 95% CI [-0.77, 0.14])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -5.14, 95% CI [-9.24, -1.05], t(44) = -2.53, p = 0.015;
#           Std. beta = -0.26, 95% CI [-0.74, 0.23])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.07, 95% CI [-0.45, 0.32], t(44) =
#                                 -0.35, p = 0.728; Std. beta = -0.05, 95% CI [-0.38, 0.28])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.40, 95% CI [0.04, 0.75], t(44) = 2.25, p = 0.030;
#               Std. beta = 0.33, 95% CI [0.02, 0.63])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.56, 95% CI [0.05, 1.07], t(44) = 2.21, p = 0.032;
#               Std. beta = 0.51, 95% CI [0.07, 0.95])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Methionine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine with Spine.Age and Site (formula:
#                                                                                             sqrt(Methionine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.36) and the part related to the fixed
# effects alone (marginal R2) is of 0.27. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.27 (95%
#                                                                      CI [2.82, 5.72], t(47) = 5.93, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.24, 95% CI [0.11, 0.37], t(47) = 3.77, p < .001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.31])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.44, 95% CI [-3.14, 0.26], t(47) = -1.70, p = 0.095;
#           Std. beta = -0.38, 95% CI [-0.87, 0.11])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.17, 95% CI [-2.91, 0.57], t(47) = -1.35, p = 0.183;
#           Std. beta = -0.32, 95% CI [-0.82, 0.18])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -1.48, 95% CI [-3.26, 0.30], t(47) = -1.67, p = 0.101;
#           Std. beta = -0.45, 95% CI [-0.96, 0.06])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Methionine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine with Spine.Age (formula:
#                                                                                    sqrt(Methionine) ~ Spine.Age). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.34) and the part related to the fixed effects alone
# (marginal R2) is of 0.20. The model's intercept, corresponding to
# Spine.Age = 0, is at 3.35 (95% CI [2.16, 4.55], t(50) = 5.63, p < .001).
# Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.23, 95% CI [0.11, 0.36], t(50) = 3.69, p < .001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.30])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Methionine8_model,Methionine9_model,Methionine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Methionine3_model: sqrt(Methionine) ~ Spine.Age + (1 | Site)
# Methionine9_model: sqrt(Methionine) ~ Spine.Age + Site + (1 | Site)
# Methionine8_model: sqrt(Methionine) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df
# Methionine3_model    4 194.00 201.95 -92.998   186.00           
# Methionine9_model    7 191.67 205.59 -88.834   177.67  8.3283  3
# Methionine8_model   10 180.94 200.84 -80.472   160.94 16.7225  3
# Pr(>Chisq)    
# Methionine3_model               
# Methionine9_model  0.0396916 *  
#   Methionine8_model  0.0008059 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

####  Methionine_Sulphoxide  ####


# retrying the models

Methionine_Sulphoxidelm_plot<- ggplot(data = PCA_18W, 
                            mapping = aes(x = Spine.Age, y =  Methionine_Sulfoxide)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Methionine_Sulphoxidelm_plot



#test normality
(shapiro.test(PCA_18W$Methionine_Sulfoxide
))

# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Methionine_Sulfoxide
# W = 0.94783, p-value = 0.02003
shapiro.test(log(Methionine_Sulfoxide))
# Shapiro-Wilk normality test
# 
# data:  log(Methionine_Sulfoxide)
# W = 0.95545, p-value = 0.04321


## square root

shapiro.test(sqrt(Methionine_Sulfoxide))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Methionine_Sulfoxide)
# W = 0.98828, p-value = 0.8742


##  model no interaction si6e random metabolite log transformed
Methionine_Sulphoxide3_model <- lmer(sqrt(Methionine_Sulfoxide) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Methionine_Sulphoxide3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 112.9
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.4951 -0.7171  0.0013  0.6354  2.6590 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.01544  0.1243  
# Residual             0.41248  0.6422  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  1.97468    0.25064   7.879
# Spine.Age    0.11316    0.02949   3.838
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.903
Methionine_Sulphoxide3_model_emm <- emmeans(Methionine_Sulphoxide3_model, ~ Spine.Age)
Methionine_Sulphoxide3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   2.85 0.109 2.65     2.47     3.22
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Methionine_Sulphoxide3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   sqrt(Methionine_Sulfoxide) 
# -----------------------------------------------
#   Spine.Age                    0.113***          
#   (0.029)          
# 
# Constant                     1.975***          
#   (0.251)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -56.441          
# Akaike Inf. Crit.             120.881          
# Bayesian Inf. Crit.           128.837          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Methionine_Sulphoxide3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine_Sulfoxide)
# Chisq Df Pr(>Chisq)    
# (Intercept) 62.071  1  3.313e-15 ***
#   Spine.Age   14.729  1  0.0001241 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Methionine_Sulphoxide3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Methionine_Sulphoxide3_model))
qqline(resid(Methionine_Sulphoxide3_model))

report(Methionine_Sulphoxide3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine_Sulfoxide with Spine.Age (formula:
#                                                                                              sqrt(Methionine_Sulfoxide) ~ Spine.Age). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is moderate (conditional R2 = 0.25) and the part related to the fixed
# effects alone (marginal R2) is of 0.22. The model's intercept,
# corresponding to Spine.Age = 0, is at 1.97 (95% CI [1.47, 2.48], t(50) =
#                                               7.88, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.11, 95% CI [0.05, 0.17], t(50) = 3.84, p < .001; Std. beta = 0.18,
#                                                                        95% CI [0.08, 0.28])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Methionine_Sulphoxide9_model <- lmer(sqrt(Methionine_Sulfoxide) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Methionine_Sulphoxide9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 112.2
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.31550 -0.67732 -0.00261  0.54440  2.37769 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.02913  0.1707  
# Residual             0.41429  0.6437  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    2.20314    0.31084   7.088
# Spine.Age      0.11973    0.03153   3.798
# SiteMatheson  -0.45405    0.34036  -1.334
# SiteRed River -0.28631    0.35169  -0.814
# SiteSandy Bar -0.41624    0.36336  -1.146
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.642                     
# SiteMathesn -0.445 -0.142              
# SiteRedRivr -0.335 -0.287  0.515       
# SiteSandyBr -0.484 -0.029  0.463  0.452
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined


qqnorm(resid(Methionine_Sulphoxide9_model))
qqline(resid(Methionine_Sulphoxide9_model))
check_model(Methionine_Sulphoxide9_model)
report(Methionine_Sulphoxide9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine_Sulfoxide with Spine.Age and Site
# (formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.30) and the part
# related to the fixed effects alone (marginal R2) is of 0.25. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 2.20 (95% CI [1.58, 2.83], t(47) = 7.09, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.12, 95% CI [0.06, 0.18], t(47) = 3.80, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.09, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.45, 95% CI [-1.14, 0.23], t(47) = -1.33, p = 0.189;
#           Std. beta = -0.23, 95% CI [-0.79, 0.33])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.29, 95% CI [-0.99, 0.42], t(47) = -0.81, p = 0.420;
#           Std. beta = -0.15, 95% CI [-0.71, 0.42])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.42, 95% CI [-1.15, 0.31], t(47) = -1.15, p = 0.258;
#           Std. beta = -0.26, 95% CI [-0.83, 0.32])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Methionine_Sulphoxide9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine_Sulfoxide)
# Chisq Df Pr(>Chisq)    
# (Intercept) 50.2349  1  1.364e-12 ***
#   Spine.Age   14.4217  1  0.0001461 ***
#   Site         2.1347  3  0.5449206    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Methionine_Sulphoxide8_model <- lmer(sqrt(Methionine_Sulfoxide) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Methionine_Sulphoxide8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 114.4
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.2159 -0.5498 -0.0981  0.4821  2.5396 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.02693  0.1641  
# Residual             0.38296  0.6188  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              2.59407    0.57451   4.515
# Spine.Age                0.05800    0.08319   0.697
# SiteMatheson            -0.09385    0.76636  -0.122
# SiteRed River           -1.05503    0.73953  -1.427
# SiteSandy Bar           -1.99851    0.94876  -2.106
# Spine.Age:SiteMatheson  -0.03376    0.10114  -0.334
# Spine.Age:SiteRed River  0.10135    0.09343   1.085
# Spine.Age:SiteSandy Bar  0.24043    0.13485   1.783
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.917                                          
# SiteMathesn -0.750  0.688                                   
# SiteRedRivr -0.777  0.712  0.582                            
# SiteSandyBr -0.606  0.555  0.454  0.470                     
# Spn.Ag:StMt  0.754 -0.823 -0.901 -0.586 -0.457              
# Spn.Ag:StRR  0.817 -0.890 -0.612 -0.884 -0.494  0.732       
# Spn.Ag:StSB  0.566 -0.617 -0.424 -0.440 -0.930  0.507  0.549
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined

emmeans(Methionine_Sulphoxide8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE  df lower.CL upper.CL
# Dauphin River   3.04 0.256 133     2.53     3.55
# Matheson        2.69 0.229 194     2.23     3.14
# Red River       2.77 0.242 158     2.29     3.24
# Sandy Bar       2.89 0.286 102     2.33     3.46
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df t.ratio p.value
# Dauphin River - Matheson    0.3539 0.344 156   1.030  0.7320
# Dauphin River - Red River   0.2742 0.352 144   0.779  0.8639
# Dauphin River - Sandy Bar   0.1463 0.383 115   0.382  0.9810
# Matheson - Red River       -0.0797 0.333 173  -0.239  0.9952
# Matheson - Sandy Bar       -0.2076 0.366 128  -0.567  0.9418
# Red River - Sandy Bar      -0.1279 0.374 121  -0.342  0.9862
# 
# Note: contrasts are still on the sqrt scale. Consider using
# regrid() if you want contrasts of back-transformed estimates. 
# Degrees-of-freedom method: kenward-roger 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Methionine_Sulphoxide8_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                   0.000000000  0.2009548
# .sigma                   0.478291601  0.6984810
# (Intercept)              1.580063949  3.6080818
# Spine.Age               -0.095206588  0.2112099
# SiteMatheson            -1.439019089  1.2513229
# SiteRed River           -2.348286958  0.2382345
# SiteSandy Bar           -3.692646680 -0.3043662
# Spine.Age:SiteMatheson  -0.220023113  0.1525106
# Spine.Age:SiteRed River -0.070712877  0.2734209
# Spine.Age:SiteSandy Bar -0.007914731  0.4887684

plot(Methionine_Sulphoxide8_model)
# Check model performance
check_model(Methionine_Sulphoxide8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Methionine_Sulphoxide8_model))
qqline(resid(Methionine_Sulphoxide8_model))
Anova(Methionine_Sulphoxide8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Methionine_Sulfoxide)
# Chisq Df Pr(>Chisq)    
# (Intercept)    20.3874  1  6.324e-06 ***
#   Spine.Age       0.4861  1    0.48568    
# Site            6.4281  3    0.09254 .  
# Spine.Age:Site  7.0091  3    0.07161 .  
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Methionine_Sulphoxide8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine_Sulfoxide with Spine.Age and Site
# (formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age * Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.37) and the part
# related to the fixed effects alone (marginal R2) is of 0.33. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 2.59 (95% CI [1.44, 3.75], t(44) = 4.52, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.06, 95% CI [-0.11, 0.23], t(44) = 0.70, p = 0.489; Std. beta =
#     0.09, 95% CI [-0.20, 0.37])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.09, 95% CI [-1.64, 1.45], t(44) = -0.12, p = 0.903;
#           Std. beta = -0.18, 95% CI [-0.56, 0.21])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.06, 95% CI [-2.55, 0.44], t(44) = -1.43, p = 0.161;
#           Std. beta = -0.14, 95% CI [-0.54, 0.26])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -2.00, 95% CI [-3.91, -0.09], t(44) = -2.11, p = 0.041;
#           Std. beta = -0.11, 95% CI [-0.54, 0.33])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.03, 95% CI [-0.24, 0.17], t(44) =
#                                 -0.33, p = 0.740; Std. beta = -0.05, 95% CI [-0.39, 0.30])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.10, 95% CI [-0.09, 0.29], t(44) =
#                                 1.08, p = 0.284; Std. beta = 0.17, 95% CI [-0.15, 0.48])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.24, 95% CI [-0.03, 0.51], t(44) =
#                                 1.78, p = 0.081; Std. beta = 0.42, 95% CI [-0.04, 0.88])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation

report(Methionine_Sulphoxide9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine_Sulfoxide with Spine.Age and Site
# (formula: sqrt(Methionine_Sulfoxide) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.30) and the part
# related to the fixed effects alone (marginal R2) is of 0.25. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 2.20 (95% CI [1.58, 2.83], t(47) = 7.09, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.12, 95% CI [0.06, 0.18], t(47) = 3.80, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.09, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.45, 95% CI [-1.14, 0.23], t(47) = -1.33, p = 0.189;
#           Std. beta = -0.23, 95% CI [-0.79, 0.33])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.29, 95% CI [-0.99, 0.42], t(47) = -0.81, p = 0.420;
#           Std. beta = -0.15, 95% CI [-0.71, 0.42])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.42, 95% CI [-1.15, 0.31], t(47) = -1.15, p = 0.258;
#           Std. beta = -0.26, 95% CI [-0.83, 0.32])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Methionine_Sulphoxide3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Methionine_Sulfoxide with Spine.Age (formula:
#                                                                                              sqrt(Methionine_Sulfoxide) ~ Spine.Age). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is moderate (conditional R2 = 0.25) and the part related to the fixed
# effects alone (marginal R2) is of 0.22. The model's intercept,
# corresponding to Spine.Age = 0, is at 1.97 (95% CI [1.47, 2.48], t(50) =
#                                               7.88, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
# #                                                                        = 0.11, 95% CI [0.05, 0.17], t(50) = 3.84, p < .001; Std. beta = 0.18,
#                                                                        95% CI [0.08, 0.28])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Methionine_Sulphoxide8_model,Methionine_Sulphoxide9_model,Methionine_Sulphoxide3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Methionine_Sulphoxide3_model: sqrt(Methionine_Sulfoxide) ~ Spine.Age + (1 | Site)
# Methionine_Sulphoxide9_model: sqrt(Methionine_Sulfoxide) ~ Spine.Age + Site + (1 | Site)
# Methionine_Sulphoxide8_model: sqrt(Methionine_Sulfoxide) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance  Chisq
# Methionine_Sulphoxide3_model    4 112.85 120.81 -52.424  104.849       
# Methionine_Sulphoxide9_model    7 114.42 128.34 -50.207  100.415 4.4340
# Methionine_Sulphoxide8_model   10 112.76 132.65 -46.378   92.756 7.6584
# Df Pr(>Chisq)  
# Methionine_Sulphoxide3_model                
# Methionine_Sulphoxide9_model  3    0.21825  
# Methionine_Sulphoxide8_model  3    0.05362 .
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
####  Lysine  ####


# retrying the models

Lysine_lm_plot<- ggplot(data = PCA_18W, 
                                      mapping = aes(x = Spine.Age, y =  Lysine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Lysine_lm_plot



#test normality
(shapiro.test(PCA_18W$Lysine
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Lysine
# W = 0.81904, p-value = 1.194e-06
shapiro.test(log(Lysine))

# Shapiro-Wilk normality test
# 
# data:  log(Lysine)
# W = 0.95219, p-value = 0.03102


## square root

shapiro.test(sqrt(Lysine))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Lysine)
# W = 0.93617, p-value = 0.006476

## standardized
shapiro.test((Lysine-(mean(Lysine))/(sd(Lysine)))) 
# Shapiro-Wilk normality test
# 
# data:  (Lysine - (mean(Lysine))/(sd(Lysine)))
# W = 0.81904, p-value = 1.194e-06

##  model no interaction si6e random metabolite log transformed
Lysine3_model <- lmer(log(Lysine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Lysine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Lysine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 180.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.7270 -0.5802  0.1158  0.7516  1.4292 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.0649   0.2548  
# Residual             1.5099   1.2288  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  1.20068    0.48277   2.487
# Spine.Age    0.18352    0.05658   3.243
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.899
Lysine3_model_emm <- emmeans(Lysine3_model, ~ Spine.Age)
Lysine3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   2.61 0.214 2.67     1.88     3.34
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Lysine3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Lysine)        
# -----------------------------------------------
#   Spine.Age                    0.184***          
#   (0.057)          
# 
# Constant                      1.201**          
#   (0.483)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -90.248          
# Akaike Inf. Crit.             188.495          
# Bayesian Inf. Crit.           196.451          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Lysine3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Lysine)
# Chisq Df Pr(>Chisq)   
# (Intercept)  6.1854  1   0.012881 * 
#   Spine.Age   10.5196  1   0.001181 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Lysine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Lysine3_model))
qqline(resid(Lysine3_model))

report(Lysine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Lysine with Spine.Age (formula: log(Lysine) ~
#                                                                                Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                        Site). The model's total explanatory power is moderate (conditional R2 =
# 0.20) and the part related to the fixed effects alone (marginal R2) is of
# 0.17. The model's intercept, corresponding to Spine.Age = 0, is at 1.20
# (95% CI [0.23, 2.17], t(50) = 2.49, p = 0.016). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.18, 95% CI [0.07, 0.30], t(50) = 3.24, p = 0.002; Std. beta = 0.23,
# #                                                                        95% CI [0.12, 0.34])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
Lysine9_model <- lmer(log(Lysine) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Lysine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Lysine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 175.8
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.8478 -0.5848  0.2158  0.8271  1.2572 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.2292   0.4787  
# Residual             1.5151   1.2309  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    0.73605    0.68991   1.067
# Spine.Age      0.17102    0.06029   2.837
# SiteMatheson   0.86058    0.81786   1.052
# SiteRed River  0.59512    0.83521   0.713
# SiteSandy Bar  0.87779    0.85328   1.029
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.553                     
# SiteMathesn -0.523 -0.113              
# SiteRedRivr -0.445 -0.231  0.509       
# SiteSandyBr -0.548 -0.024  0.476  0.469
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined


qqnorm(resid(Lysine9_model))
qqline(resid(Lysine9_model))
check_model(Lysine9_model)
report(Lysine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Lysine with Spine.Age and Site (formula:
#                                                                                         log(Lysine) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.32) and the part related to the fixed effects alone
# (marginal R2) is of 0.21. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 0.74 (95% CI [-0.65, 2.12],
#                                                     t(47) = 1.07, p = 0.291). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.17, 95% CI [0.05, 0.29], t(47) = 2.84, p = 0.007; Std. beta = 0.22,
#                                                                        95% CI [0.11, 0.34])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.86, 95% CI [-0.78, 2.51], t(47) = 1.05, p = 0.298;
#           Std. beta = 0.23, 95% CI [-0.08, 0.54])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.60, 95% CI [-1.09, 2.28], t(47) = 0.71, p = 0.480;
#           Std. beta = 0.23, 95% CI [-0.10, 0.55])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.88, 95% CI [-0.84, 2.59], t(47) = 1.03, p = 0.309;
#           Std. beta = 0.46, 95% CI [0.12, 0.80])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Lysine9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Lysine)
# Chisq Df Pr(>Chisq)   
# (Intercept) 1.1382  1    0.28603   
# Spine.Age   8.0460  1    0.00456 **
#   Site        1.4684  3    0.68958   
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Lysine8_model <- lmer(log(Lysine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Lysine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Lysine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 165.3
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.7227 -0.6504  0.0308  0.5998  1.9985 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1754   0.4188  
# Residual             1.1598   1.0769  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              1.75006    1.04568   1.674
# Spine.Age                0.01091    0.14477   0.075
# SiteMatheson             1.95987    1.40226   1.398
# SiteRed River           -1.44463    1.35794  -1.064
# SiteSandy Bar           -3.50255    1.70698  -2.052
# Spine.Age:SiteMatheson  -0.10853    0.17601  -0.617
# Spine.Age:SiteRed River  0.26770    0.16260   1.646
# Spine.Age:SiteSandy Bar  0.66506    0.23467   2.834
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.877                                          
# SiteMathesn -0.746  0.654                                   
# SiteRedRivr -0.770  0.675  0.574                            
# SiteSandyBr -0.613  0.537  0.457  0.472                     
# Spn.Ag:StMt  0.721 -0.823 -0.857 -0.555 -0.442              
# Spn.Ag:StRR  0.781 -0.890 -0.582 -0.838 -0.478  0.732       
# Spn.Ag:StSB  0.541 -0.617 -0.403 -0.417 -0.899  0.507  0.549
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Model failed to converge: degenerate  Hessian with 1 negative eigenvalues

emmeans(Lysine8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE  df lower.CL upper.CL
# Dauphin River   1.83 0.540 288     0.77     2.90
# Matheson        2.96 0.503 489     1.97     3.95
# Red River       2.45 0.521 369     1.43     3.48
# Sandy Bar       3.45 0.584 195     2.30     4.61
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df t.ratio p.value
# Dauphin River - Matheson    -1.124 0.738 362  -1.522  0.4253
# Dauphin River - Red River   -0.618 0.750 324  -0.823  0.8435
# Dauphin River - Sandy Bar   -1.621 0.796 231  -2.037  0.1774
# Matheson - Red River         0.506 0.724 421   0.699  0.8974
# Matheson - Sandy Bar        -0.497 0.771 275  -0.645  0.9172
# Red River - Sandy Bar       -1.003 0.782 253  -1.282  0.5751
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Lysine8_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                   0.00000000  0.3497170
# .sigma                   0.83234251  1.2155251
# (Intercept)             -0.01455477  3.5146844
# Spine.Age               -0.25570580  0.2775326
# SiteMatheson            -0.38105162  4.3007910
# SiteRed River           -3.69521693  0.8059529
# SiteSandy Bar           -6.45076382 -0.5543402
# Spine.Age:SiteMatheson  -0.43268218  0.2156161
# Spine.Age:SiteRed River -0.03173553  0.5671401
# Spine.Age:SiteSandy Bar  0.23288296  1.0972312

plot(Lysine8_model)
# Check model performance
check_model(Lysine8_model)#collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Lysine8_model))
qqline(resid(Lysine8_model))
Anova(Lysine8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Lysine)
# Chisq Df Pr(>Chisq)    
# (Intercept)     2.8010  1  0.0942073 .  
# Spine.Age       0.0057  1  0.9399107    
# Site           13.2680  3  0.0040914 ** 
#   Spine.Age:Site 18.0130  3  0.0004371 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Lysine8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Lysine with Spine.Age and Site (formula:
#                                                                                         log(Lysine) ~ Spine.Age * Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.47) and the part related to the fixed effects alone
# (marginal R2) is of 0.39. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 1.75 (95% CI [-0.36, 3.86],
#                                                     t(44) = 1.67, p = 0.101). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.01, 95% CI [-0.28, 0.30], t(44) = 0.08, p = 0.940; Std. beta =
#     0.07, 95% CI [-0.18, 0.32])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 1.96, 95% CI [-0.87, 4.79], t(44) = 1.40, p = 0.169;
#           Std. beta = 0.31, 95% CI [0.05, 0.58])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.44, 95% CI [-4.18, 1.29], t(44) = -1.06, p = 0.293;
#           Std. beta = 0.23, 95% CI [-0.05, 0.50])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -3.50, 95% CI [-6.94, -0.06], t(44) = -2.05, p = 0.046;
#           Std. beta = 0.72, 95% CI [0.40, 1.03])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.11, 95% CI [-0.46, 0.25], t(44) =
#                                 -0.62, p = 0.541; Std. beta = -0.16, 95% CI [-0.46, 0.14])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.27, 95% CI [-0.06, 0.60], t(44) =
#                                 1.65, p = 0.107; Std. beta = 0.26, 95% CI [-0.02, 0.54])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.67, 95% CI [0.19, 1.14], t(44) = 2.83, p = 0.007;
#               Std. beta = 0.72, 95% CI [0.32, 1.13])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Lysine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Lysine with Spine.Age and Site (formula:
#                                                                                         log(Lysine) ~ Spine.Age + Site). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.32) and the part related to the fixed effects alone
# (marginal R2) is of 0.21. The model's intercept, corresponding to
# Spine.Age = 0 and Site = Dauphin River, is at 0.74 (95% CI [-0.65, 2.12],
#                                                     t(47) = 1.07, p = 0.291). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.17, 95% CI [0.05, 0.29], t(47) = 2.84, p = 0.007; Std. beta = 0.22,
#                                                                        95% CI [0.11, 0.34])
# - The effect of Site [Matheson] is statistically non-significant and
# positive (beta = 0.86, 95% CI [-0.78, 2.51], t(47) = 1.05, p = 0.298;
#           Std. beta = 0.23, 95% CI [-0.08, 0.54])
# - The effect of Site [Red River] is statistically non-significant and
# positive (beta = 0.60, 95% CI [-1.09, 2.28], t(47) = 0.71, p = 0.480;
#           Std. beta = 0.23, 95% CI [-0.10, 0.55])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# positive (beta = 0.88, 95% CI [-0.84, 2.59], t(47) = 1.03, p = 0.309;
#           Std. beta = 0.46, 95% CI [0.12, 0.80])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Lysine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Lysine with Spine.Age (formula: log(Lysine) ~
#                                                                                Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                        Site). The model's total explanatory power is moderate (conditional R2 =
# 0.20) and the part related to the fixed effects alone (marginal R2) is of
# 0.17. The model's intercept, corresponding to Spine.Age = 0, is at 1.20
# (95% CI [0.23, 2.17], t(50) = 2.49, p = 0.016). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.18, 95% CI [0.07, 0.30], t(50) = 3.24, p = 0.002; Std. beta = 0.23,
#                                                                        95% CI [0.12, 0.34])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Lysine8_model,Lysine9_model,Lysine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Lysine3_model: log(Lysine) ~ Spine.Age + (1 | Site)
# Lysine9_model: log(Lysine) ~ Spine.Age + Site + (1 | Site)
# Lysine8_model: log(Lysine) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance   Chisq Df Pr(>Chisq)
# Lysine3_model    4 183.11 191.07 -87.555   175.11                      
# Lysine9_model    7 184.44 198.36 -85.217   170.44  4.6759  3  0.1971232
# Lysine8_model   10 172.59 192.48 -76.295   152.59 17.8440  3  0.0004737
# 
# Lysine3_model    
# Lysine9_model    
# Lysine8_model ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

####  Phenylalanine_Average  ####


# retrying the models

Phenylalanine_Average_lm_plot<- ggplot(data = PCA_18W, 
                        mapping = aes(x = Spine.Age, y =  Phenylalanine_Average)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Phenylalanine_Average_lm_plot



#test normality
(shapiro.test(PCA_18W$Phenylalanine_Average
))

# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Phenylalanine_Average
# W = 0.93593, p-value = 0.006328
shapiro.test(log(Phenylalanine_Average))
# Shapiro-Wilk normality test
# 
# data:  log(Phenylalanine_Average)
# W = 0.99075, p-value = 0.9507



##  model no interaction si6e random metabolite log transformed
Phenylalanine_Average3_model <- lmer(log(Phenylalanine_Average) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Phenylalanine_Average3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Phenylalanine_Average) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 49
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -3.02437 -0.64306 -0.01063  0.77178  2.13662 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.07787  0.279   
# Residual             0.10825  0.329   
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  3.52474    0.19060  18.492
# Spine.Age    0.07307    0.01596   4.577
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.638
Phenylalanine_Average3_model_emm <- emmeans(Phenylalanine_Average3_model, ~ Spine.Age)
Phenylalanine_Average3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   4.09 0.147 2.96     3.62     4.56
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Phenylalanine_Average3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Phenylalanine_Average) 
# -----------------------------------------------
#   Spine.Age                    0.073***          
#   (0.016)          
# 
# Constant                     3.525***          
#   (0.191)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -24.519          
# Akaike Inf. Crit.             57.038           
# Bayesian Inf. Crit.           64.994           
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Phenylalanine_Average3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Phenylalanine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 341.970  1  < 2.2e-16 ***
#   Spine.Age    20.951  1  4.712e-06 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Phenylalanine_Average3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Phenylalanine_Average3_model))
qqline(resid(Phenylalanine_Average3_model))

report(Phenylalanine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Phenylalanine_Average with Spine.Age (formula:
#                                                                                               log(Phenylalanine_Average) ~ Spine.Age). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.54) and the part related to the fixed
# effects alone (marginal R2) is of 0.21. The model's intercept,
# corresponding to Spine.Age = 0, is at 3.52 (95% CI [3.14, 3.91], t(50) =
#                                               18.49, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.04, 0.11], t(50) = 4.58, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.11, 0.27])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
##  model no interaction metabolite log transformed
Phenylalanine_Average9_model <- lmer(log(Phenylalanine_Average) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Phenylalanine_Average9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Phenylalanine_Average) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 46.5
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.94940 -0.57354 -0.01739  0.68547  2.12741 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.04573  0.2139  
# Residual             0.10833  0.3291  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    3.93077    0.25175  15.614
# Spine.Age      0.07455    0.01612   4.624
# SiteMatheson  -0.64039    0.32638  -1.962
# SiteRed River -0.44760    0.32950  -1.358
# SiteSandy Bar -0.59045    0.33280  -1.774
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.406                     
# SiteMathesn -0.614 -0.076              
# SiteRedRivr -0.575 -0.157  0.504       
# SiteSandyBr -0.626 -0.016  0.489  0.485


qqnorm(resid(Phenylalanine_Average9_model))
qqline(resid(Phenylalanine_Average9_model))

report(Phenylalanine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Phenylalanine_Average with Spine.Age and Site
# (formula: log(Phenylalanine_Average) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.57) and the part
# related to the fixed effects alone (marginal R2) is of 0.39. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 3.93 (95% CI [3.42, 4.44], t(47) = 15.61, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.04, 0.11], t(47) = 4.62, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.11, 0.27])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.64, 95% CI [-1.30, 0.02], t(47) = -1.96, p = 0.056;
#           Std. beta = -0.53, 95% CI [-1.36, 0.30])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.45, 95% CI [-1.11, 0.22], t(47) = -1.36, p = 0.181;
#           Std. beta = -0.36, 95% CI [-1.19, 0.47])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.59, 95% CI [-1.26, 0.08], t(47) = -1.77, p = 0.083;
#           Std. beta = -0.47, 95% CI [-1.30, 0.37])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Phenylalanine_Average9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Phenylalanine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 243.7829  1  < 2.2e-16 ***
#   Spine.Age    21.3859  1  3.755e-06 ***
#   Site          4.7421  3     0.1917    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Phenylalanine_Average8_model <- lmer(log(Phenylalanine_Average) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Phenylalanine_Average8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Phenylalanine_Average) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 42.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -3.1858 -0.5765 -0.0074  0.6449  2.0737 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.09301  0.3050  
# Residual             0.07984  0.2826  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              4.28721    0.39523  10.847
# Spine.Age                0.01827    0.03799   0.481
# SiteMatheson            -0.37458    0.54519  -0.687
# SiteRed River           -1.19442    0.53741  -2.223
# SiteSandy Bar           -1.65243    0.60205  -2.745
# Spine.Age:SiteMatheson  -0.02282    0.04618  -0.494
# Spine.Age:SiteRed River  0.09723    0.04266   2.279
# Spine.Age:SiteSandy Bar  0.16211    0.06157   2.633
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.609                                          
# SiteMathesn -0.725  0.441                                   
# SiteRedRivr -0.735  0.448  0.533                            
# SiteSandyBr -0.656  0.400  0.476  0.483                     
# Spn.Ag:StMt  0.501 -0.823 -0.579 -0.368 -0.329              
# Spn.Ag:StRR  0.542 -0.890 -0.393 -0.555 -0.356  0.732       
# Spn.Ag:StSB  0.376 -0.617 -0.272 -0.276 -0.669  0.507  0.549

emmeans(Phenylalanine_Average8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE    df lower.CL upper.CL
# Dauphin River   4.43 0.318  7279     3.80     5.05
# Matheson        3.88 0.314 15597     3.26     4.49
# Red River       3.98 0.316 10522     3.36     4.60
# Sandy Bar       4.02 0.323  3860     3.39     4.66
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE    df t.ratio p.value
# Dauphin River - Matheson    0.5504 0.447 10225   1.233  0.6061
# Dauphin River - Red River   0.4454 0.448  8666   0.994  0.7527
# Dauphin River - Sandy Bar   0.4036 0.453  5143   0.890  0.8099
# Matheson - Red River       -0.1050 0.445 12671  -0.236  0.9954
# Matheson - Sandy Bar       -0.1468 0.450  6750  -0.326  0.9880
# Red River - Sandy Bar      -0.0418 0.452  5920  -0.093  0.9997
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Phenylalanine_Average8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.09175820
# .sigma                   0.21839124  0.31893124
# (Intercept)              3.82421138  4.75021832
# Spine.Age               -0.05168275  0.08822912
# SiteMatheson            -0.98879102  0.23963769
# SiteRed River           -1.78493614 -0.60391262
# SiteSandy Bar           -2.42598750 -0.87887527
# Spine.Age:SiteMatheson  -0.10787014  0.06223132
# Spine.Age:SiteRed River  0.01866301  0.17579687
# Spine.Age:SiteSandy Bar  0.04871652  0.27550546

plot(Phenylalanine_Average8_model)
# Check model performance
check_model(Phenylalanine_Average8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Phenylalanine_Average8_model))
qqline(resid(Phenylalanine_Average8_model))
Anova(Phenylalanine_Average8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Phenylalanine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept)    117.6636  1  < 2.2e-16 ***
#   Spine.Age        0.2314  1  0.6304820    
# Site            10.0357  3  0.0182654 *  
#   Spine.Age:Site  20.4806  3  0.0001349 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Phenylalanine_Average8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Phenylalanine_Average with Spine.Age and Site
# (formula: log(Phenylalanine_Average) ~ Spine.Age * Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.74) and the part
# related to the fixed effects alone (marginal R2) is of 0.43. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 4.29 (95% CI [3.49, 5.08], t(44) = 10.85, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.06, 0.09], t(44) = 0.48, p = 0.633; Std. beta =
#     0.05, 95% CI [-0.14, 0.24])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.37, 95% CI [-1.47, 0.72], t(44) = -0.69, p = 0.496;
#           Std. beta = -0.46, 95% CI [-0.89, -0.02])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -1.19, 95% CI [-2.28, -0.11], t(44) = -2.22, p = 0.031;
#           Std. beta = -0.36, 95% CI [-0.80, 0.08])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -1.65, 95% CI [-2.87, -0.44], t(44) = -2.74, p = 0.009;
#           Std. beta = -0.32, 95% CI [-0.77, 0.13])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.02, 95% CI [-0.12, 0.07], t(44) =
#                                 -0.49, p = 0.624; Std. beta = -0.06, 95% CI [-0.29, 0.17])
# - The effect of Spine Age × Site [Red River] is statistically significant
# and positive (beta = 0.10, 95% CI [0.01, 0.18], t(44) = 2.28, p = 0.028;
#               Std. beta = 0.25, 95% CI [0.04, 0.46])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.16, 95% CI [0.04, 0.29], t(44) = 2.63, p = 0.012;
#               Std. beta = 0.39, 95% CI [0.08, 0.69])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Phenylalanine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Phenylalanine_Average with Spine.Age and Site
# (formula: log(Phenylalanine_Average) ~ Spine.Age + Site). The model
# included Site as random effect (formula: ~1 | Site). The model's total
# explanatory power is substantial (conditional R2 = 0.57) and the part
# related to the fixed effects alone (marginal R2) is of 0.39. The model's
# intercept, corresponding to Spine.Age = 0 and Site = Dauphin River, is at
# 3.93 (95% CI [3.42, 4.44], t(47) = 15.61, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.04, 0.11], t(47) = 4.62, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.11, 0.27])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.64, 95% CI [-1.30, 0.02], t(47) = -1.96, p = 0.056;
#           Std. beta = -0.53, 95% CI [-1.36, 0.30])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.45, 95% CI [-1.11, 0.22], t(47) = -1.36, p = 0.181;
#           Std. beta = -0.36, 95% CI [-1.19, 0.47])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.59, 95% CI [-1.26, 0.08], t(47) = -1.77, p = 0.083;
#           Std. beta = -0.47, 95% CI [-1.30, 0.37])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Phenylalanine_Average3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Phenylalanine_Average with Spine.Age (formula:
#                                                                                               log(Phenylalanine_Average) ~ Spine.Age). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.54) and the part related to the fixed
# effects alone (marginal R2) is of 0.21. The model's intercept,
# corresponding to Spine.Age = 0, is at 3.52 (95% CI [3.14, 3.91], t(50) =
#                                               18.49, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.07, 95% CI [0.04, 0.11], t(50) = 4.58, p < .001; Std. beta = 0.19,
#                                                                        95% CI [0.11, 0.27])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Phenylalanine_Average8_model,Phenylalanine_Average9_model,Phenylalanine_Average3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Phenylalanine_Average3_model: log(Phenylalanine_Average) ~ Spine.Age + (1 | Site)
# Phenylalanine_Average9_model: log(Phenylalanine_Average) ~ Spine.Age + Site + (1 | Site)
# Phenylalanine_Average8_model: log(Phenylalanine_Average) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC   logLik deviance  Chisq
# Phenylalanine_Average3_model    4 48.436 56.392 -20.2181   40.436       
# Phenylalanine_Average9_model    7 41.978 55.901 -13.9890   27.978 12.458
# Phenylalanine_Average8_model   10 28.092 47.981  -4.0458    8.092 19.887
# Df Pr(>Chisq)    
# Phenylalanine_Average3_model                  
# Phenylalanine_Average9_model  3  0.0059679 ** 
#   Phenylalanine_Average8_model  3  0.0001792 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


####  Glycine_Average  ####


# retrying the models

Glycine_Average_lm_plot<- ggplot(data = PCA_18W, 
                                       mapping = aes(x = Spine.Age, y =  Glycine_Average)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Glycine_Average_lm_plot



#test normality
(shapiro.test(PCA_18W$Glycine_Average
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Glycine_Average
# W = 0.96525, p-value = 0.1185



##  model no interaction si6e random metabolite log transformed
Glycine_Average3_model <- lmer((Glycine_Average) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Glycine_Average3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: (Glycine_Average) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 674.3
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.15574 -0.61135 -0.04877  0.70731  2.65041 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept)  3213     56.69  
# Residual             19333    139.04  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  244.132     60.977   4.004
# Spine.Age     28.386      6.605   4.298
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.827
Glycine_Average3_model_emm <- emmeans(Glycine_Average3_model, ~ Spine.Age)
Glycine_Average3_model_emm
# Spine.Age emmean   SE   df lower.CL upper.CL
# 7.7    463 34.4 2.85      350      575
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the ( (not the response) scale. 
#                            Confidence level used: 0.95 
stargazer(Glycine_Average3_model, type = "text")
# 
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   (Glycine_Average)     
# -----------------------------------------------
#   Spine.Age                    28.386***         
#   (6.605)          
# 
# Constant                    244.132***         
#   (60.977)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood               -337.175          
# Akaike Inf. Crit.             682.350          
# Bayesian Inf. Crit.           690.306          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Glycine_Average3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: (Glycine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 16.029  1  6.236e-05 ***
#   Spine.Age   18.470  1  1.726e-05 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Glycine_Average3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Glycine_Average3_model))
qqline(resid(Glycine_Average3_model))

report(Glycine_Average3_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glycine_Average with Spine.Age (formula:
#                                                                                         (Glycine_Average) ~ Spine.Age). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.36) and the part related to the fixed effects alone
# (marginal R2) is of 0.25. The model's intercept, corresponding to
# Spine.Age = 0, is at 244.13 (95% CI [121.66, 366.61], t(50) = 4.00, p <
#                                .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 28.39, 95% CI [15.12, 41.65], t(50) = 4.30, p < .001; Std. beta =
# #                                                                          87.64, 95% CI [46.68, 128.60])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Glycine_Average9_model <- lmer(log(Glycine_Average) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Glycine_Average9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Glycine_Average) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 46.5
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -3.06619 -0.45326  0.06406  0.63340  1.58050 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.02822  0.1680  
# Residual             0.10831  0.3291  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    5.81326    0.21415  27.146
# Spine.Age      0.05968    0.01612   3.702
# SiteMatheson  -0.34009    0.26736  -1.272
# SiteRed River -0.19379    0.27117  -0.715
# SiteSandy Bar -0.31181    0.27516  -1.133
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.477                     
# SiteMathesn -0.575 -0.092              
# SiteRedRivr -0.520 -0.190  0.506       
# SiteSandyBr -0.592 -0.020  0.483  0.479


qqnorm(resid(Glycine_Average9_model))
qqline(resid(Glycine_Average9_model))

report(Glycine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glycine_Average with Spine.Age and Site (formula:
#                                                                                                  log(Glycine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.41) and the part related to the fixed
# effects alone (marginal R2) is of 0.25. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.81 (95%
#                                                                      CI [5.38, 6.24], t(47) = 27.15, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.06, 95% CI [0.03, 0.09], t(47) = 3.70, p < .001; Std. beta = 0.17,
#                                                                        95% CI [0.08, 0.26])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.34, 95% CI [-0.88, 0.20], t(47) = -1.27, p = 0.210;
#           Std. beta = -0.31, 95% CI [-0.69, 0.07])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.19, 95% CI [-0.74, 0.35], t(47) = -0.71, p = 0.478;
#           Std. beta = -0.18, 95% CI [-0.57, 0.22])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.31, 95% CI [-0.87, 0.24], t(47) = -1.13, p = 0.263;
#           Std. beta = -0.27, 95% CI [-0.67, 0.13])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Glycine_Average9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Glycine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept) 736.9035  1  < 2.2e-16 ***
#   Spine.Age    13.7084  1  0.0002135 ***
#   Site          1.9798  3  0.5766040    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Glycine_Average8_model <- lmer(log(Glycine_Average) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Glycine_Average8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Glycine_Average) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 49.6
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -3.05403 -0.42451 -0.01234  0.69454  1.87972 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.01285  0.1133  
# Residual             0.09368  0.3061  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              6.231173   0.294955  21.126
# Spine.Age               -0.006301   0.041145  -0.153
# SiteMatheson            -0.414771   0.395197  -1.050
# SiteRed River           -0.832700   0.382492  -2.177
# SiteSandy Bar           -1.473341   0.482397  -3.054
# Spine.Age:SiteMatheson   0.022355   0.050024   0.447
# Spine.Age:SiteRed River  0.089168   0.046210   1.930
# Spine.Age:SiteSandy Bar  0.177529   0.066694   2.662
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.883                                          
# SiteMathesn -0.746  0.659                                   
# SiteRedRivr -0.771  0.681  0.576                            
# SiteSandyBr -0.611  0.540  0.456  0.472                     
# Spn.Ag:StMt  0.727 -0.823 -0.864 -0.560 -0.444              
# Spn.Ag:StRR  0.787 -0.890 -0.587 -0.845 -0.481  0.732       
# Spn.Ag:StSB  0.545 -0.617 -0.407 -0.420 -0.904  0.507  0.549

emmeans(Glycine_Average8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE  df lower.CL upper.CL
# Dauphin River   6.18 0.149 257     5.89     6.48
# Matheson        5.94 0.138 428     5.67     6.21
# Red River       6.04 0.143 326     5.75     6.32
# Sandy Bar       6.08 0.162 177     5.76     6.40
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE  df t.ratio p.value
# Dauphin River - Matheson    0.2426 0.203 320   1.192  0.6322
# Dauphin River - Red River   0.1458 0.207 287   0.704  0.8953
# Dauphin River - Sandy Bar   0.1057 0.220 208   0.480  0.9634
# Matheson - Red River       -0.0968 0.199 370  -0.486  0.9622
# Matheson - Sandy Bar       -0.1368 0.213 245  -0.643  0.9180
# Red River - Sandy Bar      -0.0401 0.216 226  -0.185  0.9977
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Glycine_Average8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.000000000  0.09938875
# .sigma                   0.236554434  0.34545616
# (Intercept)              5.729661943  6.73268315
# Spine.Age               -0.082075377  0.06947270
# SiteMatheson            -1.080068576  0.25052625
# SiteRed River           -1.472323018 -0.19307598
# SiteSandy Bar           -2.311232368 -0.63544971
# Spine.Age:SiteMatheson  -0.069768981  0.11447950
# Spine.Age:SiteRed River  0.004066322  0.17426872
# Spine.Age:SiteSandy Bar  0.054704047  0.30035460

plot(Glycine_Average8_model)
# Check model performance
check_model(Glycine_Average8_model)# collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Glycine_Average8_model))
qqline(resid(Glycine_Average8_model))
Anova(Glycine_Average8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Glycine_Average)
# Chisq Df Pr(>Chisq)    
# (Intercept)    446.3019  1    < 2e-16 ***
#   Spine.Age        0.0235  1    0.87828    
# Site            10.7793  3    0.01298 *  
#   Spine.Age:Site  10.6543  3    0.01375 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Glycine_Average8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glycine_Average with Spine.Age and Site (formula:
#                                                                                                  log(Glycine_Average) ~ Spine.Age * Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.45) and the part related to the fixed
# effects alone (marginal R2) is of 0.38. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 6.23 (95%
#                                                                      CI [5.64, 6.83], t(44) = 21.13, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and negative
# (beta = -6.30e-03, 95% CI [-0.09, 0.08], t(44) = -0.15, p = 0.879; Std.
#   beta = -0.02, 95% CI [-0.25, 0.21])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.41, 95% CI [-1.21, 0.38], t(44) = -1.05, p = 0.300;
#           Std. beta = -0.22, 95% CI [-0.98, 0.54])
# - The effect of Site [Red River] is statistically significant and
# negative (beta = -0.83, 95% CI [-1.60, -0.06], t(44) = -2.18, p = 0.035;
#           Std. beta = -0.13, 95% CI [-0.90, 0.63])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -1.47, 95% CI [-2.45, -0.50], t(44) = -3.05, p = 0.004;
#           Std. beta = -0.09, 95% CI [-0.86, 0.69])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and positive (beta = 0.02, 95% CI [-0.08, 0.12], t(44) =
#                                 0.45, p = 0.657; Std. beta = 0.06, 95% CI [-0.22, 0.34])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.09, 95% CI [-3.96e-03, 0.18],
#                               t(44) = 1.93, p = 0.060; Std. beta = 0.25, 95% CI [-5.77e-03, 0.51])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.18, 95% CI [0.04, 0.31], t(44) = 2.66, p = 0.011;
# #               Std. beta = 0.49, 95% CI [0.12, 0.86])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Glycine_Average9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glycine_Average with Spine.Age and Site (formula:
#                                                                                                  log(Glycine_Average) ~ Spine.Age + Site). The model included Site as
# random effect (formula: ~1 | Site). The model's total explanatory power
# is substantial (conditional R2 = 0.41) and the part related to the fixed
# effects alone (marginal R2) is of 0.25. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 5.81 (95%
#                                                                      CI [5.38, 6.24], t(47) = 27.15, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.06, 95% CI [0.03, 0.09], t(47) = 3.70, p < .001; Std. beta = 0.17,
#                                                                        95% CI [0.08, 0.26])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.34, 95% CI [-0.88, 0.20], t(47) = -1.27, p = 0.210;
#           Std. beta = -0.31, 95% CI [-0.69, 0.07])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.19, 95% CI [-0.74, 0.35], t(47) = -0.71, p = 0.478;
#           Std. beta = -0.18, 95% CI [-0.57, 0.22])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.31, 95% CI [-0.87, 0.24], t(47) = -1.13, p = 0.263;
#           Std. beta = -0.27, 95% CI [-0.67, 0.13])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Glycine_Average3_model)
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glycine_Average with Spine.Age (formula:
#                                                                                         (Glycine_Average) ~ Spine.Age). The model included Site as random effect
# (formula: ~1 | Site). The model's total explanatory power is substantial
# (conditional R2 = 0.36) and the part related to the fixed effects alone
# (marginal R2) is of 0.25. The model's intercept, corresponding to
# Spine.Age = 0, is at 244.13 (95% CI [121.66, 366.61], t(50) = 4.00, p <
#                                .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 28.39, 95% CI [15.12, 41.65], t(50) = 4.30, p < .001; Std. beta =
#                                                                          87.64, 95% CI [46.68, 128.60])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Glycine_Average8_model,Glycine_Average9_model,Glycine_Average3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Glycine_Average3_model: (Glycine_Average) ~ Spine.Age + (1 | Site)
# Glycine_Average9_model: log(Glycine_Average) ~ Spine.Age + Site + (1 | Site)
# Glycine_Average8_model: log(Glycine_Average) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC  logLik deviance  Chisq Df
# Glycine_Average3_model    4 696.69 704.65 -344.35   688.69          
# Glycine_Average9_model    7  41.97  55.89  -13.98    27.97 660.73  3
# Glycine_Average8_model   10  36.72  56.61   -8.36    16.72  11.25  3
# Pr(>Chisq)    
# Glycine_Average3_model               
# Glycine_Average9_model    < 2e-16 ***
#   Glycine_Average8_model    0.01045 *  
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1


####  Sarcosine  ####


# retrying the models

Sarcosine_lm_plot<- ggplot(data = PCA_18W, 
                                 mapping = aes(x = Spine.Age, y =  Sarcosine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Sarcosine_lm_plot



#test normality
(shapiro.test(PCA_18W$Sarcosine
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Sarcosine
# W = 0.80887, p-value = 6.667e-07
shapiro.test(log(Sarcosine))
# Shapiro-Wilk normality test
# 
# data:  log(Sarcosine)
# W = 0.98665, p-value = 0.807




##  model no interaction si6e random metabolite log transformed
Sarcosine3_model <- lmer(log(Sarcosine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Sarcosine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Sarcosine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 110.3
# 
# Scaled residuals: 
#   Min       1Q   Median       3Q      Max 
# -2.22031 -0.64228  0.07469  0.69869  2.28684 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1243   0.3525  
# Residual             0.3649   0.6041  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  1.98216    0.29525   6.713
# Spine.Age    0.10024    0.02906   3.449
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.750
Sarcosine3_model_emm <- emmeans(Sarcosine3_model, ~ Spine.Age)
Sarcosine3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7   2.75 0.195 2.92     2.12     3.39
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Sarcosine3_model, type = "text")



# ===============================================
#   Dependent variable:    
#   ---------------------------
#   log(Sarcosine)       
# -----------------------------------------------
#   Spine.Age                    0.100***          
#   (0.029)          
# 
# Constant                     1.982***          
#   (0.295)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood                -55.153          
# Akaike Inf. Crit.             118.307          
# Bayesian Inf. Crit.           126.263          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01
Anova(Sarcosine3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Sarcosine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 45.071  1    1.9e-11 ***
#   Spine.Age   11.896  1  0.0005626 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance# not bad model
check_model(Sarcosine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Sarcosine3_model))
qqline(resid(Sarcosine3_model))

report(Sarcosine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Sarcosine with Spine.Age (formula: log(Sarcosine) ~
#                                                                                   Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's total explanatory power is substantial (conditional R2
# = 0.38) and the part related to the fixed effects alone (marginal R2) is
# of 0.16. The model's intercept, corresponding to Spine.Age = 0, is at
# 1.98 (95% CI [1.39, 2.58], t(50) = 6.71, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(50) = 3.45, p = 0.001; Std. beta = 0.19,
#                                                                        95% CI [0.09, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Sarcosine9_model <- lmer(log(Sarcosine) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Sarcosine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Sarcosine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 106.1
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.2156 -0.7236  0.1045  0.6673  2.2370 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.1062   0.3258  
# Residual             0.3657   0.6047  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    2.32715    0.40710   5.716
# Spine.Age      0.10176    0.02962   3.435
# SiteMatheson  -0.88085    0.51297  -1.717
# SiteRed River -0.18884    0.51968  -0.363
# SiteSandy Bar -0.35657    0.52672  -0.677
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.461                     
# SiteMathesn -0.584 -0.089              
# SiteRedRivr -0.533 -0.182  0.506       
# SiteSandyBr -0.600 -0.019  0.485  0.480


qqnorm(resid(Sarcosine9_model))
qqline(resid(Sarcosine9_model))
check_model(Sarcosine9_model)
report(Sarcosine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Sarcosine with Spine.Age and Site (formula:
#                                                                                            log(Sarcosine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.46) and the part related to the fixed
# effects alone (marginal R2) is of 0.30. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 2.33 (95%
#                                                                      CI [1.51, 3.15], t(47) = 5.72, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(47) = 3.44, p = 0.001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.88, 95% CI [-1.91, 0.15], t(47) = -1.72, p = 0.093;
#           Std. beta = -0.46, 95% CI [-0.71, -0.21])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.19, 95% CI [-1.23, 0.86], t(47) = -0.36, p = 0.718;
#           Std. beta = -0.08, 95% CI [-0.35, 0.19])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.36, 95% CI [-1.42, 0.70], t(47) = -0.68, p = 0.502;
# #           Std. beta = -0.12, 95% CI [-0.40, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

Anova(Sarcosine9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Sarcosine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 32.6768  1  1.088e-08 ***
#   Spine.Age   11.8012  1  0.0005919 ***
#   Site         3.2916  3  0.3488100    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Sarcosine8_model <- lmer(log(Sarcosine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Sarcosine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: log(Sarcosine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 98.9
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1738 -0.7173  0.1103  0.5582  2.5535 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.005039 0.07098 
# Residual             0.273744 0.52321 
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              2.86838    0.47088   6.092
# Spine.Age                0.01630    0.07034   0.232
# SiteMatheson            -0.52329    0.62561  -0.836
# SiteRed River           -1.07326    0.60209  -1.783
# SiteSandy Bar           -2.92319    0.78423  -3.727
# Spine.Age:SiteMatheson  -0.02880    0.08551  -0.337
# Spine.Age:SiteRed River  0.12146    0.07899   1.538
# Spine.Age:SiteSandy Bar  0.38927    0.11401   3.414
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.946                                          
# SiteMathesn -0.753  0.712                                   
# SiteRedRivr -0.782  0.740  0.589                            
# SiteSandyBr -0.600  0.568  0.452  0.470                     
# Spn.Ag:StMt  0.778 -0.823 -0.933 -0.609 -0.467              
# Spn.Ag:StRR  0.842 -0.890 -0.634 -0.918 -0.506  0.732       
# Spn.Ag:StSB  0.584 -0.617 -0.439 -0.456 -0.951  0.507  0.549

emmeans(Sarcosine8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean    SE df lower.CL upper.CL
# Dauphin River   2.99 0.173  0      NaN      NaN
# Matheson        2.25 0.170  0      NaN      NaN
# Red River       2.86 0.148  0      NaN      NaN
# Sandy Bar       3.07 0.205  0      NaN      NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate    SE df t.ratio p.value
# Dauphin River - Matheson    0.7451 0.192  0   3.872     NaN
# Dauphin River - Red River   0.1376 0.298  0   0.461     NaN
# Dauphin River - Sandy Bar  -0.0756 0.283  0  -0.267     NaN
# Matheson - Red River       -0.6075 0.222  0  -2.740     NaN
# Matheson - Sandy Bar       -0.8207 0.263  0  -3.123     NaN
# Red River - Sandy Bar      -0.2132 0.264  0  -0.809     NaN
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the log (not the response) scale. 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Sarcosine8_model)
# Computing profile confidence intervals ...
# 2.5 %      97.5 %
#   .sig01                   0.00000000  0.16989934
# .sigma                   0.40437901  0.59054154
# (Intercept)              2.01107393  3.72569290
# Spine.Age               -0.11323257  0.14583196
# SiteMatheson            -1.66058512  0.61400600
# SiteRed River           -2.16666911  0.02014531
# SiteSandy Bar           -4.35552440 -1.49085043
# Spine.Age:SiteMatheson  -0.18627798  0.12868638
# Spine.Age:SiteRed River -0.02402018  0.26693305
# Spine.Age:SiteSandy Bar  0.17930139  0.59922980

plot(Sarcosine8_model)
# Check model performance
check_model(Sarcosine8_model)#collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Sarcosine8_model))
qqline(resid(Sarcosine8_model))
Anova(Sarcosine8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: log(Sarcosine)
# Chisq Df Pr(>Chisq)    
# (Intercept)    37.1073  1  1.118e-09 ***
#   Spine.Age       0.0537  1  0.8167401    
# Site           15.1102  3  0.0017249 ** 
#   Spine.Age:Site 19.4614  3  0.0002195 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Sarcosine8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Sarcosine with Spine.Age and Site (formula:
#                                                                                            log(Sarcosine) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.53) and the part related to the fixed
# effects alone (marginal R2) is of 0.52. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 2.87 (95%
#                                                                      CI [1.92, 3.82], t(44) = 6.09, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.02, 95% CI [-0.13, 0.16], t(44) = 0.23, p = 0.818; Std. beta =
#     0.03, 95% CI [-0.21, 0.27])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.52, 95% CI [-1.78, 0.74], t(44) = -0.84, p = 0.407;
#           Std. beta = -0.38, 95% CI [-0.86, 0.10])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.07, 95% CI [-2.29, 0.14], t(44) = -1.78, p = 0.082;
#           Std. beta = -0.05, 95% CI [-0.53, 0.44])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -2.92, 95% CI [-4.50, -1.34], t(44) = -3.73, p < .001;
#           Std. beta = 0.13, 95% CI [-0.38, 0.63])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.03, 95% CI [-0.20, 0.14], t(44) =
#                                 -0.34, p = 0.738; Std. beta = -0.04, 95% CI [-0.33, 0.25])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.12, 95% CI [-0.04, 0.28], t(44) =
#                                 1.54, p = 0.131; Std. beta = 0.24, 95% CI [-0.03, 0.50])
# - The effect of Spine Age × Site [Sandy Bar] is statistically significant
# and positive (beta = 0.39, 95% CI [0.16, 0.62], t(44) = 3.41, p = 0.001;
#               Std. beta = 0.69, 95% CI [0.31, 1.07])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Sarcosine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# boundary (singular) fit: see help('isSingular')
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Sarcosine with Spine.Age and Site (formula:
#                                                                                            log(Sarcosine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.46) and the part related to the fixed
# effects alone (marginal R2) is of 0.30. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 2.33 (95%
#                                                                      CI [1.51, 3.15], t(47) = 5.72, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(47) = 3.44, p = 0.001; Std. beta = 0.20,
#                                                                        95% CI [0.09, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.88, 95% CI [-1.91, 0.15], t(47) = -1.72, p = 0.093;
#           Std. beta = -0.46, 95% CI [-0.71, -0.21])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -0.19, 95% CI [-1.23, 0.86], t(47) = -0.36, p = 0.718;
#           Std. beta = -0.08, 95% CI [-0.35, 0.19])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -0.36, 95% CI [-1.42, 0.70], t(47) = -0.68, p = 0.502;
#           Std. beta = -0.12, 95% CI [-0.40, 0.16])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Sarcosine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Sarcosine with Spine.Age (formula: log(Sarcosine) ~
#                                                                                   Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's total explanatory power is substantial (conditional R2
# = 0.38) and the part related to the fixed effects alone (marginal R2) is
# of 0.16. The model's intercept, corresponding to Spine.Age = 0, is at
# 1.98 (95% CI [1.39, 2.58], t(50) = 6.71, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.10, 95% CI [0.04, 0.16], t(50) = 3.45, p = 0.001; Std. beta = 0.19,
#                                                                        95% CI [0.09, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Sarcosine8_model,Sarcosine9_model,Sarcosine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Sarcosine3_model: log(Sarcosine) ~ Spine.Age + (1 | Site)
# Sarcosine9_model: log(Sarcosine) ~ Spine.Age + Site + (1 | Site)
# Sarcosine8_model: log(Sarcosine) ~ Spine.Age * Site + (1 | Site)
# npar     AIC    BIC  logLik deviance   Chisq Df
# Sarcosine3_model    4 111.472 119.43 -51.736  103.472           
# Sarcosine9_model    7 107.679 121.60 -46.839   93.679  9.7932  3
# Sarcosine8_model   10  94.626 114.52 -37.313   74.626 19.0522  3
# Pr(>Chisq)    
# Sarcosine3_model               
# Sarcosine9_model  0.0204079 *  
#   Sarcosine8_model  0.0002667 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1



####  Glutamine  ####


# retrying the models

Glutamine_lm_plot<- ggplot(data = PCA_18W, 
                           mapping = aes(x = Spine.Age, y =  Glutamine)) +
  geom_point(aes(color = Site, size = 1)) +
  geom_smooth(method = "lm", se = FALSE, color = "black") + # Add a linear model fit
  theme_bw() +
  sm_hvgrid(borders = FALSE)
Glutamine_lm_plot



#test normality
(shapiro.test(PCA_18W$Glutamine
))
# Shapiro-Wilk normality test
# 
# data:  PCA_18W$Glutamine
# W = 0.85858, p-value = 1.398e-05
shapiro.test(log(Glutamine))
# Shapiro-Wilk normality test
# 
# data:  log(Glutamine)
# W = NaN, p-value = NA


## square root

shapiro.test(sqrt(Glutamine))
# Shapiro-Wilk normality test
# 
# data:  sqrt(Glutamine)
# W = 0.98528, p-value = 0.7448




##  model no interaction si6e random metabolite log transformed
Glutamine3_model <- lmer(sqrt(Glutamine) ~ Spine.Age + (1 | Site), data = PCA_18W)
summary(Glutamine3_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Glutamine) ~ Spine.Age + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 211.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.8830 -0.7755  0.1356  0.7140  2.7176 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.6153   0.7844  
# Residual             2.5978   1.6118  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)  2.26490    0.74140   3.055
# Spine.Age    0.22489    0.07709   2.917
# 
# Correlation of Fixed Effects:
#   (Intr)
# Spine.Age -0.793
Glutamine3_model_emm <- emmeans(Glutamine3_model, ~ Spine.Age)
Glutamine3_model_emm
# Spine.Age emmean    SE   df lower.CL upper.CL
# 7.7      4 0.452 2.89     2.53     5.47
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
stargazer(Glutamine3_model, type = "text")
# ===============================================
#   Dependent variable:    
#   ---------------------------
#   sqrt(Glutamine)      
# -----------------------------------------------
#   Spine.Age                    0.225***          
#   (0.077)          
# 
# Constant                     2.265***          
#   (0.741)          
# 
# -----------------------------------------------
#   Observations                    54             
# Log Likelihood               -105.764          
# Akaike Inf. Crit.             219.527          
# Bayesian Inf. Crit.           227.483          
# ===============================================
#   Note:               *p<0.1; **p<0.05; ***p<0.01

Anova(Glutamine3_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Glutamine)
# Chisq Df Pr(>Chisq)   
# (Intercept) 9.3324  1   0.002251 **
#   Spine.Age   8.5102  1   0.003532 **
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Check model perfomance
check_model(Glutamine3_model)
# Plot the Q-Q plot for the residuals

qqnorm(resid(Glutamine3_model))
qqline(resid(Glutamine3_model))

report(Glutamine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glutamine with Spine.Age (formula: sqrt(Glutamine)
#                                                                                 ~ Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's total explanatory power is substantial (conditional R2
# = 0.30) and the part related to the fixed effects alone (marginal R2) is
# of 0.13. The model's intercept, corresponding to Spine.Age = 0, is at
# 2.26 (95% CI [0.78, 3.75], t(50) = 3.05, p = 0.004). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.22, 95% CI [0.07, 0.38], t(50) = 2.92, p = 0.005; Std. beta = 0.17,
#                                                                        95% CI [0.05, 0.29])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.

##  model no interaction metabolite log transformed
Glutamine9_model <- lmer(sqrt(Glutamine) ~ Spine.Age + Site + (1 | Site), data = PCA_18W)
summary(Glutamine9_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Glutamine) ~ Spine.Age + Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 202.2
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7269 -0.7218  0.0717  0.6590  2.5484 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 0.4898   0.6999  
# Residual             2.5996   1.6123  
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)    3.42952    0.95568   3.589
# Spine.Age      0.23240    0.07897   2.943
# SiteMatheson  -1.70421    1.15800  -1.472
# SiteRed River -1.22549    1.17905  -1.039
# SiteSandy Bar -2.06575    1.20105  -1.720
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv
# Spine.Age   -0.523                     
# SiteMathesn -0.544 -0.105              
# SiteRedRivr -0.476 -0.214  0.508       
# SiteSandyBr -0.566 -0.022  0.479  0.473
# optimizer (nloptwrap) convergence code: 0 (OK)
# unable to evaluate scaled gradient
# Hessian is numerically singular: parameters are not uniquely determined


qqnorm(resid(Glutamine9_model))
qqline(resid(Glutamine9_model))

report(Glutamine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glutamine with Spine.Age and Site (formula:
#                                                                                            sqrt(Glutamine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.36) and the part related to the fixed
# effects alone (marginal R2) is of 0.24. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 3.43 (95%
#                                                                      CI [1.51, 5.35], t(47) = 3.59, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.23, 95% CI [0.07, 0.39], t(47) = 2.94, p = 0.005; Std. beta = 0.18,
#                                                                        95% CI [0.06, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.70, 95% CI [-4.03, 0.63], t(47) = -1.47, p = 0.148;
#           Std. beta = -0.42, 95% CI [-0.74, -0.10])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.23, 95% CI [-3.60, 1.15], t(47) = -1.04, p = 0.304;
#           Std. beta = -0.30, 95% CI [-0.64, 0.04])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -2.07, 95% CI [-4.48, 0.35], t(47) = -1.72, p = 0.092;
#           Std. beta = -0.51, 95% CI [-0.87, -0.15])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
check_model(Glutamine9_model)
Anova(Glutamine9_model, type = "III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Glutamine)
# Chisq Df Pr(>Chisq)    
# (Intercept) 12.8778  1  0.0003325 ***
#   Spine.Age    8.6596  1  0.0032534 ** 
#   Site         3.5028  3  0.3203961    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Glutamine8_model <- lmer(sqrt(Glutamine) ~ Spine.Age*Site + (1 | Site), data = PCA_18W)
summary(Glutamine8_model)
# Linear mixed model fit by REML ['lmerMod']
# Formula: sqrt(Glutamine) ~ Spine.Age * Site + (1 | Site)
# Data: PCA_18W
# 
# REML criterion at convergence: 196.5
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.7754 -0.5646  0.1490  0.5475  2.8044 
# 
# Random effects:
#   Groups   Name        Variance Std.Dev.
# Site     (Intercept) 1.318    1.148   
# Residual             2.285    1.511   
# Number of obs: 54, groups:  Site, 4
# 
# Fixed effects:
#   Estimate Std. Error t value
# (Intercept)              4.66401    1.76828   2.638
# Spine.Age                0.03748    0.20319   0.184
# SiteMatheson            -0.59939    2.41229  -0.248
# SiteRed River           -3.90154    2.36182  -1.652
# SiteSandy Bar           -5.88536    2.77226  -2.123
# Spine.Age:SiteMatheson  -0.10245    0.24703  -0.415
# Spine.Age:SiteRed River  0.34613    0.22820   1.517
# Spine.Age:SiteSandy Bar  0.58269    0.32936   1.769
# 
# Correlation of Fixed Effects:
#   (Intr) Spn.Ag StMths StRdRv StSndB S.A:SM S.A:SR
# Spine.Age   -0.728                                          
# SiteMathesn -0.733  0.533                                   
# SiteRedRivr -0.749  0.545  0.549                            
# SiteSandyBr -0.638  0.464  0.468  0.478                     
# Spn.Ag:StMt  0.599 -0.823 -0.699 -0.448 -0.382              
# Spn.Ag:StRR  0.648 -0.890 -0.475 -0.676 -0.413  0.732       
# Spn.Ag:StSB  0.449 -0.617 -0.329 -0.336 -0.777  0.507  0.549

emmeans(Glutamine8_model, pairwise ~ Site, adjust = "tukey")
# NOTE: Results may be misleading due to involvement in interactions
# $emmeans
# Site          emmean   SE   df lower.CL upper.CL
# Dauphin River   4.95 1.24 2088     2.51     7.39
# Matheson        3.56 1.21 4263     1.19     5.94
# Red River       3.72 1.23 2942     1.31     6.12
# Sandy Bar       3.56 1.28 1170     1.04     6.07
# 
# Degrees-of-freedom method: kenward-roger 
# Results are given on the sqrt (not the response) scale. 
# Confidence level used: 0.95 
# 
# $contrasts
# contrast                  estimate   SE   df t.ratio p.value
# Dauphin River - Matheson   1.38863 1.74 2864   0.799  0.8548
# Dauphin River - Red River  1.23504 1.75 2454   0.707  0.8945
# Dauphin River - Sandy Bar  1.39651 1.79 1517   0.782  0.8629
# Matheson - Red River      -0.15359 1.73 3504  -0.089  0.9997
# Matheson - Sandy Bar       0.00788 1.77 1947   0.004  1.0000
# Red River - Sandy Bar      0.16147 1.78 1726   0.091  0.9997
# 
# Note: contrasts are still on the sqrt scale. Consider using
# regrid() if you want contrasts of back-transformed estimates. 
# Degrees-of-freedom method: kenward-roger 
# P value adjustment: tukey method for comparing a family of 4 estimates 
confint(Glutamine8_model)
# Computing profile confidence intervals ...
# 2.5 %     97.5 %
#   .sig01                    0.00000000  0.4908482
# .sigma                    1.16819243  1.7059890
# (Intercept)               2.18736363  7.1406497
# Spine.Age                -0.33671951  0.4116804
# SiteMatheson             -3.88487064  2.6860939
# SiteRed River            -7.06023534 -0.7428450
# SiteSandy Bar           -10.02317999 -1.7475515
# Spine.Age:SiteMatheson   -0.55739345  0.3524930
# Spine.Age:SiteRed River  -0.07412882  0.7663929
# Spine.Age:SiteSandy Bar  -0.02386863  1.1892438

plot(Glutamine8_model)
# Check model performance
check_model(Glutamine8_model)#collinearity
# Plot the Q-Q plot for the residuals
qqnorm(resid(Glutamine8_model))
qqline(resid(Glutamine8_model))
Anova(Glutamine8_model, type="III")
# Analysis of Deviance Table (Type III Wald chisquare tests)
# 
# Response: sqrt(Glutamine)
# Chisq Df Pr(>Chisq)   
# (Intercept)    6.9569  1    0.00835 **
#   Spine.Age      0.0340  1    0.85365   
# Site           6.6282  3    0.08474 . 
# Spine.Age:Site 9.7570  3    0.02075 * 
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
report(Glutamine8_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glutamine with Spine.Age and Site (formula:
#                                                                                            sqrt(Glutamine) ~ Spine.Age * Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.54) and the part related to the fixed
# effects alone (marginal R2) is of 0.28. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 4.66 (95%
#                                                                      CI [1.10, 8.23], t(44) = 2.64, p = 0.011). Within this model:
#   
#   - The effect of Spine Age is statistically non-significant and positive
# (beta = 0.04, 95% CI [-0.37, 0.45], t(44) = 0.18, p = 0.855; Std. beta =
#     0.03, 95% CI [-0.28, 0.34])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -0.60, 95% CI [-5.46, 4.26], t(44) = -0.25, p = 0.805;
#           Std. beta = -0.34, 95% CI [-0.67, -0.01])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -3.90, 95% CI [-8.66, 0.86], t(44) = -1.65, p = 0.106;
#           Std. beta = -0.30, 95% CI [-0.64, 0.04])
# - The effect of Site [Sandy Bar] is statistically significant and
# negative (beta = -5.89, 95% CI [-11.47, -0.30], t(44) = -2.12, p = 0.039;
#           Std. beta = -0.34, 95% CI [-0.73, 0.04])
# - The effect of Spine Age × Site [Matheson] is statistically
# non-significant and negative (beta = -0.10, 95% CI [-0.60, 0.40], t(44) =
#                                 -0.41, p = 0.680; Std. beta = -0.08, 95% CI [-0.46, 0.30])
# - The effect of Spine Age × Site [Red River] is statistically
# non-significant and positive (beta = 0.35, 95% CI [-0.11, 0.81], t(44) =
#                                 1.52, p = 0.136; Std. beta = 0.26, 95% CI [-0.09, 0.61])
# - The effect of Spine Age × Site [Sandy Bar] is statistically
# non-significant and positive (beta = 0.58, 95% CI [-0.08, 1.25], t(44) =
#                                 1.77, p = 0.084; Std. beta = 0.44, 95% CI [-0.06, 0.95])
# 
# # Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Glutamine9_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glutamine with Spine.Age and Site (formula:
#                                                                                            sqrt(Glutamine) ~ Spine.Age + Site). The model included Site as random
# effect (formula: ~1 | Site). The model's total explanatory power is
# substantial (conditional R2 = 0.36) and the part related to the fixed
# effects alone (marginal R2) is of 0.24. The model's intercept,
# corresponding to Spine.Age = 0 and Site = Dauphin River, is at 3.43 (95%
#                                                                      CI [1.51, 5.35], t(47) = 3.59, p < .001). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.23, 95% CI [0.07, 0.39], t(47) = 2.94, p = 0.005; Std. beta = 0.18,
#                                                                        95% CI [0.06, 0.30])
# - The effect of Site [Matheson] is statistically non-significant and
# negative (beta = -1.70, 95% CI [-4.03, 0.63], t(47) = -1.47, p = 0.148;
#           Std. beta = -0.42, 95% CI [-0.74, -0.10])
# - The effect of Site [Red River] is statistically non-significant and
# negative (beta = -1.23, 95% CI [-3.60, 1.15], t(47) = -1.04, p = 0.304;
#           Std. beta = -0.30, 95% CI [-0.64, 0.04])
# - The effect of Site [Sandy Bar] is statistically non-significant and
# negative (beta = -2.07, 95% CI [-4.48, 0.35], t(47) = -1.72, p = 0.092;
#           Std. beta = -0.51, 95% CI [-0.87, -0.15])
# 
# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
report(Glutamine3_model)
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# Formula contains log- or sqrt-terms.
# See help("standardize") for how such terms are standardized.
# We fitted a linear mixed model (estimated using REML and nloptwrap
#                                 optimizer) to predict Glutamine with Spine.Age (formula: sqrt(Glutamine)
#                                                                                 ~ Spine.Age). The model included Site as random effect (formula: ~1 |
#                                                                                                                                           Site). The model's total explanatory power is substantial (conditional R2
# = 0.30) and the part related to the fixed effects alone (marginal R2) is
# of 0.13. The model's intercept, corresponding to Spine.Age = 0, is at
# 2.26 (95% CI [0.78, 3.75], t(50) = 3.05, p = 0.004). Within this model:
#   
#   - The effect of Spine Age is statistically significant and positive (beta
#                                                                        = 0.22, 95% CI [0.07, 0.38], t(50) = 2.92, p = 0.005; Std. beta = 0.17,
#                                                                        95% CI [0.05, 0.29])

# Standardized parameters were obtained by fitting the model on a
# standardized version of the dataset. 95% Confidence Intervals (CIs) and
# p-values were computed using a Wald t-distribution approximation.
anova(Glutamine8_model,Glutamine9_model,Glutamine3_model)
# refitting model(s) with ML (instead of REML)
# Data: PCA_18W
# Models:
#   Glutamine3_model: sqrt(Glutamine) ~ Spine.Age + (1 | Site)
# Glutamine9_model: sqrt(Glutamine) ~ Spine.Age + Site + (1 | Site)
# Glutamine8_model: sqrt(Glutamine) ~ Spine.Age * Site + (1 | Site)
# npar    AIC    BIC   logLik deviance  Chisq Df
# Glutamine3_model    4 216.31 224.26 -104.153   208.31          
# Glutamine9_model    7 213.59 227.51  -99.793   199.59  8.720  3
# Glutamine8_model   10 209.20 229.09  -94.600   189.20 10.388  3
# Pr(>Chisq)  
# Glutamine3_model             
# Glutamine9_model    0.03325 *
#   Glutamine8_model    0.01554 *
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

